<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .content-area {
            flex: 1;
            padding: 20px;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .message.character {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.protagonist {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        .message.other {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 0;
            margin-right: auto;
        }

        .message.narrator {
            background: #e9ecef;
            color: #495057;
            text-align: center;
            font-style: italic;
            margin: 0 auto;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .character-list {
            list-style: none;
        }

        .character-item {
            background: white;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .character-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .character-desc {
            color: #666;
            font-size: 0.9em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none;
        }

        .api-settings {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
        }


        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
    </style>
    <script>
    // åˆ‡æ›å°è©±æ¨¡å¼é¡¯ç¤º
    function toggleDialogueMode() {
        const mode = document.getElementById('dialogue-mode').value;
        const choiceButtons = document.getElementById('choice-mode-buttons');
        const autoButtons = document.getElementById('auto-mode-buttons');
        
        if (mode === 'choice') {
            choiceButtons.style.display = 'block';
            autoButtons.style.display = 'none';
            showSecurityTip('ğŸ”’ å·²åˆ‡æ›åˆ°é¸é …å¼å°è©±æ¨¡å¼');
        } else if (mode === 'auto') {
            choiceButtons.style.display = 'none';
            autoButtons.style.display = 'block';
            showSecurityTip('ğŸ¤– å·²åˆ‡æ›åˆ°AIè‡ªå‹•ç”Ÿæˆæ¨¡å¼');
        }
    }
    // åˆ‡æ›APIè¨­å®šé¡¯ç¤º
function toggleAPISettings() {
    const service = document.getElementById('api-service').value;
    
    // éš±è—æ‰€æœ‰APIè¨­å®š
    document.querySelectorAll('.api-settings').forEach(setting => {
        setting.style.display = 'none';
    });
    
    // é¡¯ç¤ºé¸ä¸­çš„APIè¨­å®š
    if (service && service !== 'simulation') {
        const settingId = service + '-settings';
        const settingElement = document.getElementById(settingId);
        if (settingElement) {
            settingElement.style.display = 'block';
        }
    }
}

// ç”Ÿæˆå°è©±é¸é …
async function generateDialogueOptions() {
    const speakerId = document.getElementById('speaker-select').value;
    
    if (!speakerId) {
        alert('è«‹å…ˆé¸æ“‡è¦èªªè©±çš„è§’è‰²ï¼');
        return;
    }

    const speaker = characters.find(c => c.id == speakerId);
    if (!speaker) {
        alert('æ‰¾ä¸åˆ°é¸æ“‡çš„è§’è‰²ï¼');
        return;
    }

    console.log('ç‚ºè§’è‰²ç”Ÿæˆå°è©±é¸é …:', speaker.name);
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'ğŸ¤– AIç”Ÿæˆä¸­...';
    btn.disabled = true;

    try {
        // åˆ†æç•¶å‰å°è©±æƒ…å¢ƒ
        const context = analyzeCurrentContext();
        
        // å˜—è©¦ä½¿ç”¨AIç”Ÿæˆï¼Œå¤±æ•—å‰‡ä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
        const options = await generateAIDialogueOptions(speaker, context);
        
        showDialogueOptions(options, speaker);
        
    } catch (error) {
        console.error('ç”Ÿæˆå°è©±é¸é …å¤±æ•—:', error);
        alert('ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// ä½¿ç”¨AIç”Ÿæˆå°è©±é¸é …
async function generateAIDialogueOptions(speaker, context) {
    const apiService = document.getElementById('api-service').value;
    
    // å¦‚æœé¸æ“‡æ¨¡æ“¬æ¨¡å¼ï¼Œæç¤ºç”¨æˆ¶
    if (apiService === 'simulation') {
        alert('æ¨¡æ“¬æ¨¡å¼ä¸æ”¯æ´å°è©±é¸é …ç”Ÿæˆï¼Œè«‹é¸æ“‡APIæœå‹™ä¸¦è¼¸å…¥API Key');
        return [];
    }
    
    const apiKey = getAPIKeyByService(apiService);
    
    if (!apiKey) {
        alert('è«‹å…ˆè¼¸å…¥API Keyæ‰èƒ½ç”Ÿæˆå°è©±é¸é …ï¼');
        return [];
    }
    
    try {
        console.log('ä½¿ç”¨çœŸå¯¦APIç”Ÿæˆå°è©±é¸é …...');
        
        const prompt = buildDialogueOptionsPrompt(speaker, context);
        let options;
        
        switch (apiService) {
            case 'huggingface':
                options = await generateWithHuggingFace(apiKey, prompt);
                break;
            case 'deepseek':
                options = await generateWithDeepSeek(apiKey, prompt);
                break;
            case 'groq':
                options = await generateWithGroq(apiKey, prompt);
                break;
            default:
                throw new Error('è«‹é¸æ“‡æœ‰æ•ˆçš„APIæœå‹™');
        }
        
        if (options && options.length >= 4) {
            showSecurityTip(`ğŸ¤– ${apiService.toUpperCase()} APIç”Ÿæˆå®Œæˆ`);
            return options.slice(0, 4);
        } else {
            throw new Error('APIç”Ÿæˆçš„é¸é …ä¸è¶³4å€‹');
        }
        
    } catch (error) {
        console.error('APIç”Ÿæˆå¤±æ•—:', error);
        alert(`APIç”Ÿæˆå¤±æ•—ï¼š${error.message}\nè«‹æª¢æŸ¥API Keyæ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚`);
        return [];
    }
}

// ç²å–å°æ‡‰æœå‹™çš„API Key
function getAPIKeyByService(service) {
    switch (service) {
        case 'huggingface':
            return document.getElementById('hf-api-key').value.trim();
        case 'deepseek':
            return document.getElementById('deepseek-api-key').value.trim();
        case 'groq':
            return document.getElementById('groq-api-key').value.trim();
        default:
            return null;
    }
}

// å»ºæ§‹å°è©±é¸é …ç”Ÿæˆæç¤º
function buildDialogueOptionsPrompt(speaker, context) {
    // ç²å–æœ€è¿‘çš„å°è©±æ­·å²
    const recentDialogues = dialogues.slice(-3).map(d => {
        if (d.type === 'dialogue') {
            return `${d.speaker}ï¼šã€Œ${d.content}ã€`;
        } else {
            return `(æ—ç™½ï¼š${d.content})`;
        }
    }).join('\n');
    
    const contextInfo = context.lastSpeaker ? 
        `\næœ€å¾Œèªªè©±è€…ï¼š${context.lastSpeaker}` : '';
    
    const topicInfo = context.currentTopic ? 
        `\nç•¶å‰è©±é¡Œï¼š${context.currentTopic}` : '';
    
    const moodInfo = context.mood !== 'neutral' ? 
        `\nç•¶å‰æ°›åœï¼š${context.mood}` : '';
    
    const responseType = context.hasQuestion ? 
        'éœ€è¦å›ç­”å•é¡Œ' : (context.needsResponse ? 'éœ€è¦å›æ‡‰å‰é¢çš„è©±' : 'å¯ä»¥ä¸»å‹•é–‹å•Ÿæ–°è©±é¡Œ');

    return `ä½ æ˜¯å°ˆæ¥­çš„å°è©±ç·¨åŠ‡ï¼Œè«‹ç‚ºä»¥ä¸‹è§’è‰²ç”Ÿæˆ4å€‹ä¸åŒé¢¨æ ¼çš„å°è©±é¸é …ï¼š

ã€è§’è‰²è¨­å®šã€‘
å§“åï¼š${speaker.name}
å€‹æ€§ï¼š${speaker.personality}
èªæ°£ï¼š${speaker.tone}
è¡Œç‚ºç‰¹è‰²ï¼š${speaker.behavior}

ã€å°è©±æƒ…å¢ƒã€‘
${recentDialogues || '(å°è©±é–‹å§‹)'}${contextInfo}${topicInfo}${moodInfo}
å°è©±é¡å‹ï¼š${responseType}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. ç”Ÿæˆ4å€‹å®Œå…¨ä¸åŒé¢¨æ ¼çš„å°è©±é¸é …
2. æ¯å€‹é¸é …éƒ½è¦ç¬¦åˆè§’è‰²å€‹æ€§å’Œèªæ°£
3. é¸é …è¦é©åˆç•¶å‰å°è©±æƒ…å¢ƒ
4. é¸é …é•·åº¦æ§åˆ¶åœ¨10-25å­—ä¹‹é–“
5. è¦æœ‰å‰µæ„å’Œå¤šæ¨£æ€§ï¼Œé¿å…é‡è¤‡æˆ–ç›¸ä¼¼

ã€è¼¸å‡ºæ ¼å¼ã€‘
é¸é …1ï¼š[å°è©±å…§å®¹]
é¸é …2ï¼š[å°è©±å…§å®¹]  
é¸é …3ï¼š[å°è©±å…§å®¹]
é¸é …4ï¼š[å°è©±å…§å®¹]

åªè¼¸å‡º4å€‹é¸é …ï¼Œä¸è¦å…¶ä»–èªªæ˜ã€‚`;
}

// ä½¿ç”¨Hugging Faceç”Ÿæˆ
async function generateWithHuggingFace(apiKey, prompt) {
    const response = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            inputs: prompt,
            parameters: {
                max_length: 200,
                temperature: 0.8,
                do_sample: true,
                top_p: 0.9
            }
        })
    });

    if (!response.ok) {
        throw new Error(`Hugging Face APIéŒ¯èª¤: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.error) {
        throw new Error(`Hugging FaceéŒ¯èª¤: ${data.error}`);
    }
    
    // è§£æç”Ÿæˆçš„å…§å®¹
    return parseGeneratedOptions(data[0]?.generated_text || '');
}

// ä½¿ç”¨DeepSeekç”Ÿæˆï¼ˆä¿®å¾©CORSï¼‰
async function generateWithDeepSeek(apiKey, prompt) {
    try {
        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 300,
                temperature: 0.8,
                top_p: 0.9,
                stream: false
            })
        });

        if (!response.ok) {
            throw new Error(`DeepSeek APIéŒ¯èª¤: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.error) {
            throw new Error(`DeepSeekéŒ¯èª¤: ${data.error.message}`);
        }
        
        const generatedText = data.choices[0]?.message?.content || '';
        console.log('DeepSeekç”Ÿæˆçµæœ:', generatedText);
        return parseGeneratedOptions(generatedText);
        
    } catch (error) {
        console.error('DeepSeek APIéŒ¯èª¤:', error);
        throw error;
    }
}

// ä½¿ç”¨Groqç”Ÿæˆï¼ˆä¿®å¾©CORSï¼‰
async function generateWithGroq(apiKey, prompt) {
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: 'llama3-8b-8192',
                messages: [
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: 300,
                temperature: 0.8,
                top_p: 0.9,
                stream: false
            })
        });

        if (!response.ok) {
            throw new Error(`Groq APIéŒ¯èª¤: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.error) {
            throw new Error(`GroqéŒ¯èª¤: ${data.error.message}`);
        }
        
        const generatedText = data.choices[0]?.message?.content || '';
        console.log('Groqç”Ÿæˆçµæœ:', generatedText);
        return parseGeneratedOptions(generatedText);
        
    } catch (error) {
        console.error('Groq APIéŒ¯èª¤:', error);
        throw error;
    }
}

// è§£æAIç”Ÿæˆçš„é¸é …
function parseGeneratedOptions(text) {
    console.log('AIç”Ÿæˆçš„åŸå§‹æ–‡æœ¬:', text);
    
    const options = [];
    const lines = text.split('\n').filter(line => line.trim());
    
    for (const line of lines) {
        // åŒ¹é… "é¸é …Xï¼šå…§å®¹" æ ¼å¼
        const match = line.match(/é¸é …[1-4][:ï¼š]\s*(.+)/) || 
                     line.match(/^[1-4]\.?\s*(.+)/) ||
                     line.match(/^[-â€¢]\s*(.+)/);
        
        if (match && match[1]) {
            let option = match[1].trim();
            // ç§»é™¤å¼•è™Ÿ
            option = option.replace(/[ã€Œã€ã€ã€"]/g, '');
            
            if (option.length > 5 && option.length < 50) {
                options.push(option);
            }
        }
    }
    
    console.log('è§£æå¾Œçš„é¸é …:', options);
    
    // å¦‚æœè§£æä¸åˆ°è¶³å¤ é¸é …ï¼Œå˜—è©¦å…¶ä»–æ–¹æ³•
    if (options.length < 4) {
        const sentences = text.split(/[ã€‚ï¼ï¼Ÿ\n]/).filter(s => 
            s.trim().length > 5 && s.trim().length < 50 && 
            !s.includes('é¸é …') && !s.includes('æ ¼å¼')
        );
        
        sentences.forEach(sentence => {
            if (options.length < 4) {
                options.push(sentence.trim());
            }
        });
    }
    
    return options;
}

// æ”¹é€²çš„æœ¬åœ°ç”Ÿæˆï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
function generateContextualOptions(speaker, context) {
    let options = [];
    
    // æ ¹æ“šè§’è‰²å€‹æ€§èª¿æ•´é¸é …é¢¨æ ¼
    const isCheerful = speaker.personality && (
        speaker.personality.includes('æ´»æ½‘') || 
        speaker.personality.includes('é–‹æœ—') || 
        speaker.personality.includes('æ¨‚è§€')
    );
    
    const isCalm = speaker.personality && (
        speaker.personality.includes('æ²‰ç©©') || 
        speaker.personality.includes('å†·éœ') || 
        speaker.personality.includes('ç†æ€§')
    );
    
    // åŸºæ–¼ä¸åŒæƒ…å¢ƒç”Ÿæˆé¸é …
    if (context.hasQuestion) {
        options = generateAnswerOptions(speaker, context, isCheerful, isCalm);
    } else if (context.needsResponse || context.lastSpeaker) {
        options = generateResponseOptions(speaker, context, isCheerful, isCalm);
    } else {
        options = generateInitiativeOptions(speaker, context, isCheerful, isCalm);
    }
    
    // æ·»åŠ ä¸»é¡Œç›¸é—œé¸é …
    if (context.currentTopic) {
        const topicOptions = generateTopicRelatedOptions(speaker, context.currentTopic, isCheerful, isCalm);
        options = options.concat(topicOptions);
    }
    
    // ç¢ºä¿æœ‰è¶³å¤ çš„é¸é …
    while (options.length < 4) {
        options.push(...generateGeneralOptions(speaker, isCheerful, isCalm));
    }
    
    // éš¨æ©Ÿæ’åºä¸¦å–å‰4å€‹
    return shuffleArray(options).slice(0, 4);
}


// åˆ†æç•¶å‰å°è©±æƒ…å¢ƒ
function analyzeCurrentContext() {
    const recentDialogues = dialogues.slice(-3);
    const lastDialogue = dialogues.length > 0 ? dialogues[dialogues.length - 1] : null;
    
    let context = {
        hasQuestion: false,
        needsResponse: false,
        currentTopic: '',
        mood: 'neutral',
        lastSpeaker: null,
        conversationType: 'casual'
    };
    
    if (lastDialogue) {
        context.lastSpeaker = lastDialogue.speaker;
        
        if (lastDialogue.type === 'dialogue' && 
            (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?'))) {
            context.hasQuestion = true;
            context.needsResponse = true;
        }
        
        const content = lastDialogue.content.toLowerCase();
        if (content.includes('å¤©æ°£') || content.includes('æ™´') || content.includes('é›¨')) {
            context.currentTopic = 'å¤©æ°£';
        } else if (content.includes('åƒ') || content.includes('é¤“') || content.includes('é£Ÿç‰©')) {
            context.currentTopic = 'é£²é£Ÿ';
        } else if (content.includes('å­¸æ ¡') || content.includes('åŠŸèª²') || content.includes('è€ƒè©¦')) {
            context.currentTopic = 'å­¸ç¿’';
        } else if (content.includes('æ„Ÿè¦º') || content.includes('å¿ƒæƒ…') || content.includes('æƒ³')) {
            context.currentTopic = 'æƒ…æ„Ÿ';
        }
        
        if (content.includes('é–‹å¿ƒ') || content.includes('é«˜èˆˆ') || content.includes('å“ˆå“ˆ')) {
            context.mood = 'happy';
        } else if (content.includes('æ“”å¿ƒ') || content.includes('ç…©æƒ±') || content.includes('å›°æ“¾')) {
            context.mood = 'worried';
        } else if (content.includes('é›£é') || content.includes('å‚·å¿ƒ') || content.includes('å¤±æœ›')) {
            context.mood = 'sad';
        }
    }
    
    return context;
}

// éš¨æ©Ÿæ‰“äº‚é™£åˆ—
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}



// æ¨¡æ“¬å°è©±é¸é …ç”Ÿæˆ
function simulateDialogueOptions() {
    const options = [
        "æˆ‘è¦ºå¾—é€™å€‹æƒ³æ³•å¾ˆä¸éŒ¯ã€‚",
        "æˆ–è¨±æˆ‘å€‘å¯ä»¥æ›å€‹è§’åº¦æƒ³æƒ³ã€‚", 
        "é€™è®“æˆ‘æƒ³åˆ°å¦ä¸€ä»¶äº‹...",
        "æˆ‘æœ‰é»ä¸åŒçš„çœ‹æ³•ã€‚"
    ];
    
    showDialogueOptions(options);
}

// é¡¯ç¤ºå°è©±é¸é …
function showDialogueOptions(options, speaker) {
    const optionsDiv = document.getElementById('dialogue-options');
    const choicesDiv = document.getElementById('dialogue-choices');
    
    // æ·»åŠ èªªæ˜æ¨™é¡Œ
    const titleDiv = document.createElement('div');
    titleDiv.innerHTML = `<strong>ğŸ’¡ ç‚º ${speaker.name} ç”Ÿæˆçš„å°è©±é¸é …ï¼š</strong>`;
    titleDiv.style.cssText = 'margin-bottom: 10px; color: #333; font-size: 14px;';
    
    choicesDiv.innerHTML = '';
    choicesDiv.appendChild(titleDiv);
    
    options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'btn';
        button.style.cssText = 'display: block; width: 100%; margin-bottom: 8px; text-align: left; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease;';
        button.textContent = `${index + 1}. ${option}`;
        button.onclick = () => selectDialogueOption(option, speaker);
        
        // æ·»åŠ hoveræ•ˆæœ
        button.onmouseenter = () => {
            button.style.transform = 'translateY(-1px)';
            button.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
        };
        button.onmouseleave = () => {
            button.style.transform = 'translateY(0)';
            button.style.boxShadow = 'none';
        };
        
        choicesDiv.appendChild(button);
    });
    
    // æ·»åŠ é‡æ–°ç”ŸæˆæŒ‰éˆ•
    const regenerateBtn = document.createElement('button');
    regenerateBtn.className = 'btn';
    regenerateBtn.style.cssText = 'display: block; width: 100%; margin-top: 10px; background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);';
    regenerateBtn.textContent = 'ğŸ”„ é‡æ–°ç”Ÿæˆé¸é …';
    regenerateBtn.onclick = () => {
        generateDialogueOptions();
    };
    choicesDiv.appendChild(regenerateBtn);
    
    optionsDiv.style.display = 'block';
    
    // é¡¯ç¤ºæç¤º
    showSecurityTip(`ğŸ’¡ å·²ç‚º ${speaker.name} ç”Ÿæˆ ${options.length} å€‹å°è©±é¸é …`);
}

// é¸æ“‡å°è©±é¸é …
function selectDialogueOption(option, speaker) {
    // å¦‚æœæ²’æœ‰å‚³å…¥speakerï¼Œå¾é¸æ“‡å™¨ç²å–
    if (!speaker) {
        const speakerId = document.getElementById('speaker-select').value;
        if (!speakerId) {
            alert('è«‹å…ˆé¸æ“‡èªªè©±è€…ï¼');
            return;
        }
        speaker = characters.find(c => c.id == speakerId);
    }
    
    if (!speaker) {
        alert('æ‰¾ä¸åˆ°é¸æ“‡çš„è§’è‰²ï¼');
        return;
    }
    
    const dialogue = {
        type: 'dialogue',
        speaker: speaker.name,
        speakerId: speaker.id,
        content: option,
        timestamp: new Date(),
        generated: true,
        selected: true,
        fromOptions: true
    };
    
    dialogues.push(dialogue);
    displayDialogue(dialogue);
    hideDialogueOptions();
    
    // æ›´æ–°è§’è‰²è¨˜æ†¶
    updateCharacterMemory(speaker.id, option, 'é¸é …ç”Ÿæˆ');
    
    showSecurityTip(`âœ… ${speaker.name} èªªï¼š${option}`);
}

// ç”Ÿæˆå›ç­”å•é¡Œçš„é¸é …
function generateAnswerOptions(speaker, context, isCheerful, isCalm) {
    const baseAnswers = [
        "æˆ‘è¦ºå¾—æ˜¯é€™æ¨£çš„...",
        "è®“æˆ‘æƒ³æƒ³...",
        "é€™å€‹å•é¡Œå¾ˆæœ‰è¶£ã€‚",
        "æˆ‘çš„çœ‹æ³•æ˜¯..."
    ];
    
    if (isCheerful) {
        return [
            "å“‡ï¼Œé€™å€‹å•é¡Œå¥½æ£’ï¼æˆ‘è¦ºå¾—...",
            "è®“æˆ‘èˆˆå¥®åœ°å‘Šè¨´ä½ ...",
            "é€™çœŸçš„å¾ˆæœ‰æ„æ€å‘¢ï¼",
            "æˆ‘æœ‰å€‹å¾ˆæ£’çš„æƒ³æ³•ï¼"
        ];
    } else if (isCalm) {
        return [
            "è®“æˆ‘ä»”ç´°è€ƒæ…®ä¸€ä¸‹é€™å€‹å•é¡Œã€‚",
            "æ ¹æ“šæˆ‘çš„ç†è§£...",
            "é€™éœ€è¦æ·±æ€ç†Ÿæ…®ã€‚",
            "æˆ‘èªç‚ºæˆ‘å€‘æ‡‰è©²é€™æ¨£çœ‹..."
        ];
    }
    
    return baseAnswers;
}

// ç”Ÿæˆå›æ‡‰é¸é …
function generateResponseOptions(speaker, context, isCheerful, isCalm) {
    const moodResponses = {
        happy: isCheerful ? [
            "å“ˆå“ˆï¼Œæˆ‘ä¹Ÿè¦ºå¾—å¾ˆé–‹å¿ƒï¼",
            "å¤ªæ£’äº†ï¼æˆ‘å€‘éƒ½é€™éº¼æƒ³ï¼",
            "é€™ç¨®å¿«æ¨‚çš„æ„Ÿè¦ºçœŸå¥½ï¼",
            "è®“æˆ‘å€‘ç¹¼çºŒä¿æŒé€™ç¨®å¥½å¿ƒæƒ…ï¼"
        ] : [
            "æˆ‘ç†è§£ä½ çš„å¿«æ¨‚ã€‚",
            "çœ‹åˆ°ä½ é–‹å¿ƒæˆ‘ä¹Ÿå¾ˆé«˜èˆˆã€‚",
            "é€™ç¢ºå¯¦æ˜¯ä»¶å¥½äº‹ã€‚",
            "ä½ çš„å¿«æ¨‚å¾ˆæœ‰æ„ŸæŸ“åŠ›ã€‚"
        ],
        worried: isCheerful ? [
            "ä¸è¦å¤ªæ“”å¿ƒå•¦ï¼æœƒæœ‰è¾¦æ³•çš„ï¼",
            "æˆ‘å€‘ä¸€èµ·æƒ³è¾¦æ³•è§£æ±ºå§ï¼",
            "åˆ¥ç…©æƒ±ï¼Œäº‹æƒ…æœƒå¥½è½‰çš„ï¼",
            "è®“æˆ‘ä¾†å¹«ä½ åˆ†æ“”ä¸€äº›å§ï¼"
        ] : [
            "æˆ‘ç†è§£ä½ çš„æ“”æ†‚ã€‚",
            "è®“æˆ‘å€‘å†·éœåˆ†æä¸€ä¸‹ã€‚",
            "æˆ‘å€‘éœ€è¦ä»”ç´°è€ƒæ…®å°ç­–ã€‚",
            "é€™ç¢ºå¯¦æ˜¯å€‹éœ€è¦æ³¨æ„çš„å•é¡Œã€‚"
        ],
        sad: isCheerful ? [
            "åˆ¥é›£éï¼Œæˆ‘é™ªè‘—ä½ ï¼",
            "äº‹æƒ…æœƒå¥½èµ·ä¾†çš„ï¼",
            "è®“æˆ‘æƒ³è¾¦æ³•è®“ä½ é–‹å¿ƒé»ï¼",
            "æˆ‘å€‘ä¸€èµ·åº¦éé€™å€‹é›£é—œï¼"
        ] : [
            "æˆ‘å¾ˆç†è§£ä½ çš„æ„Ÿå—ã€‚",
            "é€™ç¢ºå¯¦è®“äººé›£éã€‚",
            "è«‹ç›¸ä¿¡ï¼Œæˆ‘æœƒæ”¯æŒä½ ã€‚",
            "æ™‚é–“æœƒç™‚ç™’ä¸€åˆ‡çš„ã€‚"
        ]
    };
    
    return moodResponses[context.mood] || [
        "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚",
        "ä½ èªªå¾—å¾ˆæœ‰é“ç†ã€‚",
        "æˆ‘ä¹Ÿæ˜¯é€™éº¼æƒ³çš„ã€‚",
        "é€™å€‹è§€é»å¾ˆæ£’ã€‚"
    ];
}

// ç”Ÿæˆä¸»å‹•é–‹å•Ÿè©±é¡Œçš„é¸é …
function generateInitiativeOptions(speaker, context, isCheerful, isCalm) {
    if (isCheerful) {
        return [
            "æˆ‘æƒ³åˆ°ä¸€ä»¶æœ‰è¶£çš„äº‹ï¼",
            "ä½ çŸ¥é“å—ï¼Ÿæˆ‘ä»Šå¤©...",
            "æˆ‘å€‘ä¾†èŠé»é–‹å¿ƒçš„å§ï¼",
            "æˆ‘æœ‰å€‹å¥½ä¸»æ„ï¼"
        ];
    } else if (isCalm) {
        return [
            "æˆ‘æƒ³å’Œä½ è¨è«–ä¸€ä»¶äº‹ã€‚",
            "æœ‰å€‹æƒ³æ³•æƒ³å’Œä½ åˆ†äº«ã€‚",
            "æˆ‘ä¸€ç›´åœ¨æ€è€ƒ...",
            "é—œæ–¼...æˆ‘æƒ³è½è½ä½ çš„æ„è¦‹ã€‚"
        ];
    }
    
    return [
        "å°äº†ï¼Œæˆ‘æƒ³å‘Šè¨´ä½ ...",
        "èªªåˆ°é€™å€‹...",
        "æˆ‘å‰›æ‰æƒ³åˆ°...",
        "æœ‰ä»¶äº‹æƒ³å’Œä½ èŠèŠã€‚"
    ];
}

// ç”Ÿæˆä¸»é¡Œç›¸é—œé¸é …
function generateTopicRelatedOptions(speaker, topic, isCheerful, isCalm) {
    const topicResponses = {
        'å¤©æ°£': [
            "èªªåˆ°å¤©æ°£ï¼Œæˆ‘è¦ºå¾—...",
            "é€™ç¨®å¤©æ°£è®“æˆ‘æƒ³åˆ°...",
            "å¤©æ°£çœŸçš„æœƒå½±éŸ¿å¿ƒæƒ…å‘¢ã€‚",
            "ä½ å–œæ­¡é€™æ¨£çš„å¤©æ°£å—ï¼Ÿ"
        ],
        'é£²é£Ÿ': [
            "èªªåˆ°åƒçš„ï¼Œæˆ‘æœ€å–œæ­¡...",
            "ä½ æœ‰ä»€éº¼æ¨è–¦çš„ç¾é£Ÿå—ï¼Ÿ",
            "æˆ‘å€‘æ”¹å¤©ä¸€èµ·å»åƒ...",
            "é£Ÿç‰©çœŸçš„èƒ½å¸¶ä¾†å¿«æ¨‚ã€‚"
        ],
        'å­¸ç¿’': [
            "é—œæ–¼å­¸ç¿’ï¼Œæˆ‘çš„ç¶“é©—æ˜¯...",
            "æˆ‘å€‘å¯ä»¥ä¸€èµ·åŠªåŠ›ï¼",
            "å­¸ç¿’ç¢ºå¯¦ä¸å®¹æ˜“ã€‚",
            "ä½ æœ‰ä»€éº¼å¥½çš„å­¸ç¿’æ–¹æ³•å—ï¼Ÿ"
        ],
        'æƒ…æ„Ÿ': [
            "æˆ‘å¾ˆç†è§£é€™ç¨®æ„Ÿè¦ºã€‚",
            "æƒ…æ„Ÿç¢ºå¯¦å¾ˆè¤‡é›œã€‚",
            "è¬è¬ä½ é¡˜æ„åˆ†äº«ã€‚",
            "æˆ‘ä¹Ÿæœ‰é¡ä¼¼çš„ç¶“æ­·ã€‚"
        ]
    };
    
    return topicResponses[topic] || [];
}

// ç”Ÿæˆé€šç”¨é¸é …
function generateGeneralOptions(speaker, isCheerful, isCalm) {
    if (isCheerful) {
        return [
            "ä»Šå¤©å¿ƒæƒ…çœŸå¥½ï¼",
            "ç”Ÿæ´»çœŸç¾å¥½å•Šï¼",
            "æˆ‘å€‘çœŸå¹¸é‹ï¼",
            "è®“æˆ‘å€‘ç¹¼çºŒèŠå§ï¼"
        ];
    } else if (isCalm) {
        return [
            "æˆ‘å€‘ç¹¼çºŒé€™å€‹è©±é¡Œã€‚",
            "é€™å¾ˆå€¼å¾—æ·±æ€ã€‚",
            "æˆ‘æƒ³è½è½ä½ çš„çœ‹æ³•ã€‚",
            "è®“æˆ‘å€‘ä»”ç´°è€ƒæ…®ã€‚"
        ];
    }
    
    return [
        "æˆ‘æ˜ç™½äº†ã€‚",
        "é€™å¾ˆæœ‰æ„æ€ã€‚",
        "æˆ‘å€‘ç¹¼çºŒèŠå§ã€‚",
        "ä½ èªªå¾—å°ã€‚"
    ];
}

// éš±è—å°è©±é¸é …
function hideDialogueOptions() {
    document.getElementById('dialogue-options').style.display = 'none';
}

// é¡¯ç¤ºå®Œæ•´å°èªªç”Ÿæˆé¢æ¿
function generateFullNovel() {
    document.getElementById('novel-generation').style.display = 'block';
}
</script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±</h1>
            <p>å‰µé€ ä½ çš„äº’å‹•å¼å°è©±å°èªª</p>
        </div>

        <div class="main-content">
            <!-- å´é‚Šæ¬„ - è§’è‰²ç®¡ç† -->
            <div class="sidebar">
                <div class="section">
                    <h3>ğŸ‘¥ è§’è‰²ç®¡ç†</h3>
                    <button class="btn" onclick="showCreateCharacter()">+ æ–°å¢è§’è‰²</button>
                    <button class="btn btn-secondary" onclick="loadTemplate()">ğŸ“‹ è¼‰å…¥ç¯„æœ¬</button>
                    
                    <div id="character-list">
                        <ul class="character-list">
                            <!-- è§’è‰²åˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                        </ul>
                    </div>
                </div>

                <div class="section">
                    <h3>âš™ï¸ ç³»çµ±è¨­å®š</h3>
                    <div class="input-group">
                        <label>APIæœå‹™é¸æ“‡ï¼š</label>
                        <select id="api-service" onchange="toggleAPISettings()">
                            <option value="simulation">æ¨¡æ“¬æ¨¡å¼ (ç„¡éœ€API Key)</option>
                            <option value="huggingface">Hugging Face (æœ€ç°¡å–®)</option>
                            <option value="deepseek">DeepSeek (ä¸­æ–‡æœ€å¼·)</option>
                            <option value="groq">Groq (æœ€å¿«é€Ÿ)</option>
                        </select>
                    </div>
                    
                    <!-- Hugging Face API -->
                    <div id="huggingface-settings" class="api-settings" style="display: none;">
                        <div class="input-group">
                            <label>Hugging Face API Tokenï¼š</label>
                            <input type="password" id="hf-api-key" placeholder="è«‹è¼¸å…¥ Hugging Face API Token">
                            <small style="color: #666; font-size: 12px;">
                                ğŸ“ å¾ <a href="https://huggingface.co/settings/tokens" target="_blank" style="color: #4facfe;">huggingface.co/settings/tokens</a> å–å¾—
                            </small>
                        </div>
                        <div style="padding: 10px; background: #e8f5e8; border-radius: 6px; font-size: 12px; color: #2d5a2d;">
                            âœ… <strong>å„ªå‹¢ï¼š</strong>å®Œå…¨å…è²»ã€ç©©å®šå¯é ã€ç„¡CORSå•é¡Œ<br>
                            ğŸ“‹ <strong>æ­¥é©Ÿï¼š</strong>1. è¨»å†ŠHFå¸³è™Ÿ â†’ 2. å‰µå»ºToken â†’ 3. è²¼ä¸Šå³ç”¨
                        </div>
                    </div>
                    
                    <!-- DeepSeek API -->
                    <div id="deepseek-settings" class="api-settings" style="display: none;">
                        <div class="input-group">
                            <label>DeepSeek API Keyï¼š</label>
                            <input type="password" id="deepseek-api-key" placeholder="è«‹è¼¸å…¥ DeepSeek API Key">
                            <small style="color: #666; font-size: 12px;">
                                ğŸ“ å¾ <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: #4facfe;">platform.deepseek.com</a> å–å¾—
                            </small>
                        </div>
                        <div style="padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 12px; color: #856404;">
                            ğŸ‡¨ğŸ‡³ <strong>å„ªå‹¢ï¼š</strong>ä¸­æ–‡èƒ½åŠ›è¶…å¼·ã€ç†è§£èªå¢ƒä½³ã€å…è²»é¡åº¦å¤§<br>
                            ğŸ“‹ <strong>æ­¥é©Ÿï¼š</strong>1. è¨»å†ŠDeepSeekå¸³è™Ÿ â†’ 2. ç²å–API Key â†’ 3. äº«å—ä¸­æ–‡AI
                        </div>
                    </div>
                    
                    <!-- Groq API -->
                    <div id="groq-settings" class="api-settings" style="display: none;">
                        <div class="input-group">
                            <label>Groq API Keyï¼š</label>
                            <input type="password" id="groq-api-key" placeholder="è«‹è¼¸å…¥ Groq API Key">
                            <small style="color: #666; font-size: 12px;">
                                ğŸ“ å¾ <a href="https://console.groq.com/keys" target="_blank" style="color: #4facfe;">console.groq.com/keys</a> å–å¾—
                            </small>
                        </div>
                        <div style="padding: 10px; background: #f0f8ff; border-radius: 6px; font-size: 12px; color: #0c5460;">
                            âš¡ <strong>å„ªå‹¢ï¼š</strong>è¶…é«˜é€Ÿåº¦ã€å³æ™‚å›æ‡‰ã€å…è²»ä½¿ç”¨<br>
                            ğŸ“‹ <strong>æ­¥é©Ÿï¼š</strong>1. è¨»å†ŠGroqå¸³è™Ÿ â†’ 2. å‰µå»ºAPI Key â†’ 3. é«”é©—æ¥µé€ŸAI
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>ä¸»è§’è¨­å®šï¼š</label>
                        <select id="protagonist-select">
                            <option value="">é¸æ“‡ä¸»è§’</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>å°è©±æ¨¡å¼ï¼š</label>
                        <select id="dialogue-mode" onchange="toggleDialogueMode()">
                            <option value="choice">é¸é …å¼å°è©± (AIç”Ÿæˆ4å€‹å›æ‡‰é¸é …ä¾›é¸æ“‡)</option>
                            <option value="auto">AIè‡ªå‹•ç”Ÿæˆ (å®Œæ•´å°èªªè‡ªå‹•å‰µä½œ)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>åŒ¯å‡ºæ ¼å¼ï¼š</label>
                        <select id="export-format">
                            <option value="txt">ç´”æ–‡å­— (.txt)</option>
                            <option value="docx">Wordæ–‡ä»¶ (.docx)</option>
                            <option value="pdf">PDFæ–‡ä»¶ (.pdf)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportNovel()">ğŸ“„ åŒ¯å‡ºå°èªª</button>
                    <button class="btn btn-secondary" onclick="saveProject()">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ</button>
                </div>
            </div>

            <!-- ä¸»è¦å…§å®¹å€ -->
            <div class="content-area">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ å°è©±å‰µä½œ</div>
                    <div class="tab" onclick="switchTab('character')">ğŸ‘¤ è§’è‰²ç·¨è¼¯</div>
                    <div class="tab" onclick="switchTab('preview')">ğŸ“– é è¦½å°èªª</div>
                </div>

                <!-- å°è©±å‰µä½œå€ -->
                <div id="chat-tab" class="tab-content">
                    <div class="section">
                        <h3>ğŸ’¬ å°è©±å‰µä½œå€</h3>
                        <div class="chat-container" id="chat-container">
                            <div class="message narrator">
                                <div class="message-header">ç³»çµ±æç¤º</div>
                                æ­¡è¿ä½¿ç”¨AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±ï¼è«‹å…ˆå»ºç«‹è§’è‰²ï¼Œç„¶å¾Œé–‹å§‹å‰µä½œå°è©±ã€‚
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <select id="speaker-select" style="flex: 0 0 150px;">
                                <option value="">é¸æ“‡èªªè©±è€…</option>
                            </select>
                            <input type="text" id="dialogue-input" placeholder="è¼¸å…¥å°è©±å…§å®¹..." style="flex: 1;" onkeypress="handleEnterKey(event)">
                            <button class="btn" onclick="addDialogue()" id="send-btn">ç™¼é€</button>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="addNarrator()">+ æ–°å¢æ—ç™½</button>
                            <button class="btn" onclick="generateAIScene()" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);">ğŸ¬ AIç”Ÿæˆå ´æ™¯</button>
                            <button class="btn" onclick="clearChat()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">ğŸ—‘ï¸ æ¸…ç©ºå°è©±</button>
                            
                            <!-- æ ¹æ“šå°è©±æ¨¡å¼é¡¯ç¤ºå°æ‡‰æŒ‰éˆ• -->
                            <div id="choice-mode-buttons" style="margin-top: 10px; display: none;">
                                <button class="btn" onclick="generateDialogueOptions()" id="choice-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ¯ ç”Ÿæˆå°è©±é¸é …</button>
                                <div style="margin-top: 8px; padding: 10px; background: #e8f4fd; border-radius: 6px; font-size: 12px; color: #0c5460;">
                                    ğŸ’¡ <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                                    1. å…ˆæ‰‹å‹•å»ºç«‹ä¸€äº›å°è©±<br>
                                    2. é»æ“Šã€Œç”Ÿæˆå°è©±é¸é …ã€<br>
                                    3. é¸æ“‡å›æ‡‰è§’è‰²<br>
                                    4. å¾4å€‹é¸é …ä¸­é¸æ“‡å›æ‡‰
                                </div>
                            </div>
                            
                            <div id="auto-mode-buttons" style="margin-top: 10px; display: none;">
                                <button class="btn" onclick="generateFullNovel()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ“š AIè‡ªå‹•ç”Ÿæˆå°èªª</button>
                                <div style="margin-top: 8px; padding: 10px; background: #fdf2e9; border-radius: 6px; font-size: 12px; color: #8b4513;">
                                    ğŸ’¡ <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                                    1. é»æ“Šã€ŒAIè‡ªå‹•ç”Ÿæˆå°èªªã€<br>
                                    2. è¼¸å…¥å°èªªå¤§ç¶±å’Œè¨­å®š<br>
                                    3. AIæœƒè‡ªå‹•ç”Ÿæˆå®Œæ•´å°èªª<br>
                                    4. åŒ…å«å°è©±ã€æ—ç™½ã€å‹•ä½œæè¿°
                                </div>
                            </div>
                        </div>
                        
                        <!-- å°è©±é¸é …å€åŸŸ -->
                        <div id="dialogue-options" style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; display: none;">
                            <h4 style="margin-bottom: 10px; color: #333;">ğŸ’¬ é¸æ“‡å›æ‡‰</h4>
                            <div id="dialogue-choices"></div>
                            <button class="btn btn-secondary" onclick="hideDialogueOptions()" style="margin-top: 10px;">å–æ¶ˆ</button>
                        </div>
                        
                        <!-- è‡ªå‹•ç”Ÿæˆå°èªªè¨­å®š -->
                        <div id="novel-generation" style="margin-top: 15px; padding: 15px; background: #fff8dc; border-radius: 8px; display: none;">
                            <h4 style="margin-bottom: 10px; color: #333;">ğŸ“š è‡ªå‹•ç”Ÿæˆå°èªªè¨­å®š</h4>
                            <!-- è§’è‰²é¸æ“‡å€åŸŸ -->
<div style="background: #e8f5e8; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
    <h5 style="margin-bottom: 10px; color: #2d5a2d;">ğŸ“‹ é¸æ“‡åƒèˆ‡å°èªªçš„è§’è‰²ï¼š</h5>
    <div id="character-checkboxes">
        <!-- è§’è‰²é¸é …æœƒå‹•æ…‹è¼‰å…¥ -->
    </div>
    <div style="background: #fff3cd; border-radius: 4px; padding: 8px; margin-top: 10px; font-size: 12px; color: #856404;">
        âš ï¸ <strong>é‡è¦ï¼š</strong>è«‹è‡³å°‘é¸æ“‡2å€‹è§’è‰²åƒèˆ‡å°èªªå‰µä½œï¼Œå¦‚æœæ²’æœ‰é¸æ“‡å°‡ä½¿ç”¨ç¾æœ‰è§’è‰²
    </div>
</div>
                            <div class="input-group">
                                <label>å°èªªå¤§ç¶±ï¼š</label>
                                <textarea id="novel-outline" rows="3" placeholder="è«‹æè¿°å°èªªçš„ä¸»è¦æƒ…ç¯€ï¼Œä¾‹å¦‚ï¼šä¸€å€‹é—œæ–¼å‹æƒ…çš„æ•…äº‹ï¼Œå…©å€‹å­¸ç”Ÿåœ¨å­¸æ ¡ç›¸é‡..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>ç›®æ¨™å­—æ•¸ï¼š</label>
                                <select id="novel-length">
                                    <option value="5000">çŸ­ç¯‡ (ç´„5000å­—)</option>
                                    <option value="10000">ä¸­çŸ­ç¯‡ (ç´„10000å­—)</option>
                                    <option value="15000">ä¸­ç¯‡ (ç´„15000å­—)</option>
                                    <option value="20000">é•·ç¯‡ (ç´„20000å­—)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>çµå°¾é¢¨æ ¼ï¼š</label>
                                <select id="novel-ending" onchange="toggleCustomEnding()">
                                    <option value="happy">åœ“æ»¿çµå±€</option>
                                    <option value="open">é–‹æ”¾å¼çµå±€</option>
                                    <option value="twist">è½‰æŠ˜çµå±€</option>
                                    <option value="emotional">æ„Ÿäººçµå±€</option>
                                    <option value="cliffhanger">æ‡¸å¿µçµå±€</option>
                                    <option value="custom">å…¶ä»– (è‡ªå®šç¾©)</option>
                                </select>
                                <input type="text" id="custom-ending" placeholder="è«‹æè¿°ä½ æƒ³è¦çš„çµå°¾é¢¨æ ¼..." style="margin-top: 8px; display: none;">
                            </div>
                            <div class="input-group">
                                <label>ä¸»è¦è§’è‰²æ•¸é‡ï¼š</label>
                                <select id="character-count" onchange="toggleCustomCharacterCount()">
                                    <option value="2">2å€‹ä¸»è¦è§’è‰²</option>
                                    <option value="3">3å€‹ä¸»è¦è§’è‰²</option>
                                    <option value="4">4å€‹ä¸»è¦è§’è‰² + è·¯äºº</option>
                                    <option value="5">5å€‹ä¸»è¦è§’è‰² + è·¯äºº</option>
                                    <option value="custom">å…¶ä»– (è‡ªå®šç¾©)</option>
                                </select>
                                <input type="number" id="custom-character-count" min="1" max="10" placeholder="è¼¸å…¥è§’è‰²æ•¸é‡ (1-10)" style="margin-top: 8px; display: none;">
                            </div>
                            <button class="btn" onclick="startNovelGeneration()">ğŸš€ é–‹å§‹ç”Ÿæˆå°èªª</button>
                            <button class="btn btn-secondary" onclick="hideNovelGeneration()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²ç·¨è¼¯å€ -->
                <div id="character-tab" class="tab-content hidden">
                    <div class="section">
                        <h3>ğŸ‘¤ è§’è‰²ç·¨è¼¯</h3>
                        <div id="character-editor">
                            <div class="input-group">
                                <label>è§’è‰²åç¨±ï¼š</label>
                                <input type="text" id="char-name" placeholder="è«‹è¼¸å…¥è§’è‰²åç¨±">
                            </div>
                            <div class="input-group">
                                <label>è§’è‰²å€‹æ€§ï¼š</label>
                                <textarea id="char-personality" rows="3" placeholder="æè¿°è§’è‰²çš„å€‹æ€§ç‰¹å¾µ..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>èªªè©±èªæ°£ï¼š</label>
                                <input type="text" id="char-tone" placeholder="ä¾‹å¦‚ï¼šæº«å’Œã€æ´»æ½‘ã€åš´è‚…...">
                            </div>
                            <div class="input-group">
                                <label>è¡Œç‚ºç‰¹è‰²ï¼š</label>
                                <textarea id="char-behavior" rows="2" placeholder="æè¿°è§’è‰²çš„è¡Œç‚ºç¿’æ…£..."></textarea>
                            </div>
                            <button class="btn" onclick="saveCharacter()">ğŸ’¾ å„²å­˜è§’è‰²</button>
                            <button class="btn btn-secondary" onclick="clearCharacterForm()">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- å°èªªé è¦½å€ -->
                <div id="preview-tab" class="tab-content hidden">
                    <div class="section">
                        <h3>ğŸ“– å°èªªé è¦½</h3>
                        <div id="novel-preview" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 400px; font-family: serif; line-height: 1.8;">
                            <p style="text-align: center; color: #666;">å°èªªå…§å®¹æœƒåœ¨é€™è£¡é¡¯ç¤º...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let characters = [];
        let dialogues = [];
        let currentEditingCharacter = null;
        let protagonistId = null;
        let apiKeyMemory = null; // æš«æ™‚å„²å­˜API Keyåœ¨è¨˜æ†¶é«”ä¸­
        let characterMemories = {}; // æ¯å€‹è§’è‰²çš„è¨˜æ†¶åº«
        let currentScene = { // ç•¶å‰å ´æ™¯ç‹€æ…‹
            location: 'å®¤å…§',
            timeOfDay: 'ç™½å¤©',
            weather: 'æ™´æœ—',
            atmosphere: 'å¹³éœ',
            established: false
        };

        // é è¨­è§’è‰²ç¯„æœ¬
        const characterTemplates = [
            {
                name: "è‰¾è‰çµ²",
                personality: "è°æ˜æ©Ÿæ™ºï¼Œæœ‰é»ä»»æ€§ä½†å–„è‰¯",
                tone: "æ´»æ½‘ç›´æ¥ï¼Œå¶çˆ¾æœƒæœ‰é»å°å‚²å¬Œ",
                behavior: "å–œæ­¡æ€è€ƒå•é¡Œï¼Œç¶“å¸¸åšå‡ºæ„å¤–çš„æ±ºå®š"
            },
            {
                name: "é›·æ©",
                personality: "æ²‰ç©©å¯é ï¼Œå…§å¿ƒæº«æŸ”",
                tone: "èªªè©±æº«å’Œä½†å …å®š",
                behavior: "ç¸½æ˜¯å„ªå…ˆè€ƒæ…®ä»–äººï¼Œç¿’æ…£é»˜é»˜æ‰¿æ“”è²¬ä»»"
            },
            {
                name: "æ—ç™½è€…",
                personality: "å®¢è§€å†·éœï¼Œç„¡æ‰€ä¸çŸ¥",
                tone: "ä¸­æ€§æ•˜è¿°ï¼Œå¶çˆ¾å¸¶æœ‰è©©æ„",
                behavior: "è² è²¬å ´æ™¯æè¿°å’Œæƒ…ç¯€æ¨é€²"
            }
        ];

        // åˆ‡æ›è‡ªå®šç¾©çµå°¾è¼¸å…¥æ¡†
        function toggleCustomEnding() {
            const select = document.getElementById('novel-ending');
            const customInput = document.getElementById('custom-ending');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        // åˆ‡æ›è‡ªå®šç¾©è§’è‰²æ•¸é‡è¼¸å…¥æ¡†
        function toggleCustomCharacterCount() {
            const select = document.getElementById('character-count');
            const customInput = document.getElementById('custom-character-count');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–æ™‚è¨­å®šAPIé¡¯ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ç³»çµ±åˆå§‹åŒ–é–‹å§‹ ===');
            loadCharacterTemplates();
            updateCharacterList();
            updateSpeakerSelect();
            
            console.log('åˆå§‹åŒ–å¾Œçš„è§’è‰²:', characters);
            
            // è¨­å®šä¸»è§’é¸æ“‡ç›£è½å™¨
            document.getElementById('protagonist-select').addEventListener('change', function() {
                protagonistId = this.value;
                console.log('ä¸»è§’è¨­å®šç‚º:', protagonistId);
                refreshChatDisplay();
            });

            // åˆå§‹åŒ–å°è©±æ¨¡å¼é¡¯ç¤º
            toggleDialogueMode();
            
            // åˆå§‹åŒ–APIè¨­å®šé¡¯ç¤º
            toggleAPISettings();
        });

        // API Keyå®‰å…¨è¨­å®š
        function setupAPIKeySecurity() {
            const apiKeyInput = document.getElementById('api-key');
            const saveCheckbox = document.getElementById('save-api-key');

            // è¼‰å…¥æš«å­˜çš„API Keyï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const tempKey = sessionStorage.getItem('temp_api_key');
            if (tempKey) {
                apiKeyInput.value = tempKey;
                saveCheckbox.checked = true;
            }

            // ç›£è½API Keyè¼¸å…¥è®ŠåŒ–
            apiKeyInput.addEventListener('input', function() {
                apiKeyMemory = this.value;
                
                if (saveCheckbox.checked && this.value) {
                    // åªåœ¨ç•¶å‰ç€è¦½å™¨æœƒè©±ä¸­æš«å­˜
                    sessionStorage.setItem('temp_api_key', this.value);
                } else {
                    // æ¸…é™¤æš«å­˜
                    sessionStorage.removeItem('temp_api_key');
                }
            });

            // ç›£è½å„²å­˜é¸é …è®ŠåŒ–
            saveCheckbox.addEventListener('change', function() {
                if (this.checked && apiKeyInput.value) {
                    sessionStorage.setItem('temp_api_key', apiKeyInput.value);
                    showSecurityTip('API Keyå·²æš«æ™‚å„²å­˜åˆ°æœ¬åœ°ç€è¦½å™¨');
                } else {
                    sessionStorage.removeItem('temp_api_key');
                    showSecurityTip('API Keyæš«å­˜å·²æ¸…é™¤');
                }
            });

            // é é¢é—œé–‰æ™‚æ¸…é™¤æ•æ„Ÿè³‡æ–™
            window.addEventListener('beforeunload', function() {
                if (!saveCheckbox.checked) {
                    apiKeyMemory = null;
                    sessionStorage.removeItem('temp_api_key');
                }
            });
        }

        // é¡¯ç¤ºå®‰å…¨æç¤º
        function showSecurityTip(message) {
            const tip = document.createElement('div');
            tip.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4facfe;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            tip.textContent = message;
            document.body.appendChild(tip);

            setTimeout(() => {
                tip.remove();
            }, 3000);
        }

        // åˆå§‹åŒ–è§’è‰²è¨˜æ†¶
        function initializeCharacterMemory(characterId) {
            if (!characterMemories[characterId]) {
                characterMemories[characterId] = {
                    spokenLines: new Set(), // èªªéçš„è©±
                    conversationHistory: [], // å°è©±æ­·å²
                    mood: 'neutral', // ç•¶å‰æƒ…ç·’ç‹€æ…‹
                    topics: new Set() // è¨è«–éçš„è©±é¡Œ
                };
            }
        }

        // æ›´æ–°è§’è‰²è¨˜æ†¶
        function updateCharacterMemory(characterId, content, context) {
            initializeCharacterMemory(characterId);
            const memory = characterMemories[characterId];
            
            memory.spokenLines.add(content);
            memory.conversationHistory.push({
                content: content,
                timestamp: new Date(),
                context: context
            });
            
            // ä¿æŒè¨˜æ†¶åº«å¤§å°åˆç†ï¼ˆæœ€å¤šä¿ç•™20æ¢è¨˜éŒ„ï¼‰
            if (memory.conversationHistory.length > 20) {
                memory.conversationHistory.shift();
            }
        }

        // æª¢æŸ¥è§’è‰²æ˜¯å¦èªªéé¡ä¼¼çš„è©±
        function hasCharacterSaidSimilar(characterId, content) {
            if (!characterMemories[characterId]) return false;
            
            const memory = characterMemories[characterId];
            const contentLower = content.toLowerCase();
            
            for (let spokenLine of memory.spokenLines) {
                const similarity = calculateSimilarity(contentLower, spokenLine.toLowerCase());
                if (similarity > 0.7) return true; // 70%ç›¸ä¼¼åº¦è¦–ç‚ºé‡è¤‡
            }
            return false;
        }

        // è¨ˆç®—æ–‡å­—ç›¸ä¼¼åº¦
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // Levenshteinè·é›¢ç®—æ³•
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // æ¨™ç±¤åˆ‡æ›
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„activeé¡
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // æ·»åŠ activeé¡åˆ°é»æ“Šçš„æ¨™ç±¤
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°é è¦½æ¨™ç±¤ï¼Œæ›´æ–°é è¦½å…§å®¹
            if (tabName === 'preview') {
                updateNovelPreview();
            }
        }

        // è™•ç†Enteréµç™¼é€
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                addDialogue();
            }
        }

        // è¼‰å…¥è§’è‰²ç¯„æœ¬
        // è¼‰å…¥è§’è‰²ç¯„æœ¬
function loadCharacterTemplates() {
    console.log('è¼‰å…¥è§’è‰²ç¯„æœ¬...'); // é™¤éŒ¯ç”¨
    characterTemplates.forEach((template, index) => {
        characters.push({
            ...template, 
            id: `template_${index}_${Date.now()}` // ä½¿ç”¨å­—ç¬¦ä¸²ID
        });
    });
    console.log('ç¯„æœ¬è¼‰å…¥å®Œæˆï¼Œè§’è‰²æ•¸é‡:', characters.length); // é™¤éŒ¯ç”¨
    console.log('è¼‰å…¥çš„è§’è‰²:', characters); // é™¤éŒ¯ç”¨
}

      
        // æ›´æ–°è§’è‰²åˆ—è¡¨é¡¯ç¤º
function updateCharacterList() {
    const listContainer = document.querySelector('.character-list');
    listContainer.innerHTML = '';
     // æ–°å¢ï¼šåŒæ™‚æ›´æ–°è§’è‰²é¸æ“‡æ¡†
    updateCharacterCheckboxes();
    
    console.log('æ›´æ–°è§’è‰²åˆ—è¡¨ï¼Œç•¶å‰è§’è‰²:', characters); // é™¤éŒ¯ç”¨
    
    characters.forEach((char, index) => {
        console.log(`è§’è‰² ${index}:`, char); // é™¤éŒ¯ç”¨
        
        const li = document.createElement('li');
        li.className = 'character-item';
        li.innerHTML = `
            <div class="character-name">${char.name}</div>
            <div class="character-desc">${char.personality}</div>
            <div style="margin-top: 8px;">
                <button class="btn" style="font-size: 12px; padding: 5px 10px;" onclick="editCharacterById('${char.id}')">ç·¨è¼¯</button>
                <button class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" onclick="deleteCharacterById('${char.id}')">åˆªé™¤</button>
            </div>
        `;
        listContainer.appendChild(li);
    });
}

        // æ›´æ–°èªªè©±è€…é¸æ“‡
        function updateSpeakerSelect() {
            const select = document.getElementById('speaker-select');
            const protagonistSelect = document.getElementById('protagonist-select');
            
            select.innerHTML = '<option value="">é¸æ“‡èªªè©±è€…</option>';
            protagonistSelect.innerHTML = '<option value="">é¸æ“‡ä¸»è§’</option>';
            
            console.log('æ›´æ–°èªªè©±è€…é¸æ“‡ï¼Œè§’è‰²æ•¸é‡:', characters.length); // é™¤éŒ¯ç”¨
            
            characters.forEach(char => {
                // èªªè©±è€…é¸æ“‡
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = char.name;
                select.appendChild(option);
                
                // ä¸»è§’é¸æ“‡
                const protagonistOption = document.createElement('option');
                protagonistOption.value = char.id;
                protagonistOption.textContent = char.name;
                protagonistSelect.appendChild(protagonistOption);
                
                console.log('æ–°å¢é¸é …:', char.name, 'ID:', char.id); // é™¤éŒ¯ç”¨
            });
        }

        // æ›´æ–°è§’è‰²é¸æ“‡æ¡†ï¼ˆç”¨æ–¼å°èªªç”Ÿæˆï¼‰
function updateCharacterCheckboxes() {
    const container = document.getElementById('character-checkboxes');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (characters.length === 0) {
        container.innerHTML = '<div style="color: #666; font-style: italic;">è«‹å…ˆåœ¨è§’è‰²ç®¡ç†ä¸­å»ºç«‹è§’è‰²</div>';
        return;
    }
    
    characters.forEach(character => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.style.cssText = `
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        `;
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = character.id;
        checkbox.style.marginRight = '10px';
        
        const info = document.createElement('div');
        info.style.flex = '1';
        info.innerHTML = `
            <div style="font-weight: bold; color: #2d5a2d;">${character.name}</div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">${character.personality}</div>
        `;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(info);
        container.appendChild(checkboxDiv);
    });
}
        // é¡¯ç¤ºæ–°å¢è§’è‰²è¡¨å–®
        function showCreateCharacter() {
            switchTab('character');
            clearCharacterForm();
        }

        // å„²å­˜è§’è‰²
        // å„²å­˜è§’è‰²
function saveCharacter() {
    const name = document.getElementById('char-name').value.trim();
    const personality = document.getElementById('char-personality').value.trim();
    const tone = document.getElementById('char-tone').value.trim();
    const behavior = document.getElementById('char-behavior').value.trim();

    if (!name) {
        alert('è«‹è¼¸å…¥è§’è‰²åç¨±ï¼');
        return;
    }

    console.log('=== å„²å­˜è§’è‰²é–‹å§‹ ===');
    console.log('ç•¶å‰ç·¨è¼¯è§’è‰²ID:', currentEditingCharacter);
    console.log('è¡¨å–®æ•¸æ“š:', {name, personality, tone, behavior});

    if (currentEditingCharacter) {
        // ç·¨è¼¯ç¾æœ‰è§’è‰²
        console.log('ç·¨è¼¯æ¨¡å¼ - æŸ¥æ‰¾è§’è‰²...');
        const index = characters.findIndex(c => c.id === currentEditingCharacter || String(c.id) === String(currentEditingCharacter) || c.id == currentEditingCharacter);
        
        console.log('æ‰¾åˆ°è§’è‰²ç´¢å¼•:', index);
        
        if (index !== -1) {
            characters[index] = {
                id: characters[index].id, // ä¿æŒåŸæœ‰ID
                name,
                personality,
                tone,
                behavior
            };
            console.log('è§’è‰²å·²æ›´æ–°:', characters[index]);
        } else {
            console.error('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è§’è‰²ï¼');
            alert('å„²å­˜å¤±æ•—ï¼šæ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è§’è‰²ï¼');
            return;
        }
    } else {
        // æ–°å¢è§’è‰²
        console.log('æ–°å¢æ¨¡å¼ - å‰µå»ºæ–°è§’è‰²...');
        const newCharacter = {
            id: `char_${Date.now()}_${Math.random()}`, // ç¢ºä¿å”¯ä¸€çš„å­—ç¬¦ä¸²ID
            name,
            personality,
            tone,
            behavior
        };
        characters.push(newCharacter);
        console.log('æ–°è§’è‰²å·²æ·»åŠ :', newCharacter);
    }

    updateCharacterList();
    updateSpeakerSelect();
    clearCharacterForm();
    console.log('=== å„²å­˜è§’è‰²å®Œæˆ ===');
    alert('è§’è‰²å·²å„²å­˜ï¼');
}

        // æ¸…é™¤è§’è‰²è¡¨å–®
        function clearCharacterForm() {
            document.getElementById('char-name').value = '';
            document.getElementById('char-personality').value = '';
            document.getElementById('char-tone').value = '';
            document.getElementById('char-behavior').value = '';
            currentEditingCharacter = null;
        }

        // æ ¹æ“šIDç·¨è¼¯è§’è‰²ï¼ˆæ–°å‡½æ•¸ï¼Œé¿å…åç¨±è¡çªï¼‰
function editCharacterById(id) {
    console.log('=== ç·¨è¼¯è§’è‰²é–‹å§‹ ===');
    console.log('å‚³å…¥ID:', id, 'é¡å‹:', typeof id);
    console.log('æ‰€æœ‰è§’è‰²:', characters);
    
    // å˜—è©¦å¤šç¨®æ–¹å¼æŸ¥æ‰¾è§’è‰²
    let character = characters.find(c => c.id === id);
    if (!character) {
        character = characters.find(c => String(c.id) === String(id));
    }
    if (!character) {
        character = characters.find(c => c.id == id);
    }
    
    console.log('æ‰¾åˆ°çš„è§’è‰²:', character);
    
    if (character) {
        currentEditingCharacter = character.id; // ä½¿ç”¨æ‰¾åˆ°çš„è§’è‰²çš„çœŸå¯¦ID
        
        // å¡«å…¥è¡¨å–®
        const nameField = document.getElementById('char-name');
        const personalityField = document.getElementById('char-personality');
        const toneField = document.getElementById('char-tone');
        const behaviorField = document.getElementById('char-behavior');
        
        if (nameField) nameField.value = character.name || '';
        if (personalityField) personalityField.value = character.personality || '';
        if (toneField) toneField.value = character.tone || '';
        if (behaviorField) behaviorField.value = character.behavior || '';
        
        console.log('è¡¨å–®å·²å¡«å…¥:', {
            name: character.name,
            personality: character.personality,
            tone: character.tone,
            behavior: character.behavior
        });
        
        // åˆ‡æ›åˆ°è§’è‰²ç·¨è¼¯é é¢
        switchTab('character');
        console.log('=== ç·¨è¼¯è§’è‰²å®Œæˆ ===');
    } else {
        console.error('æ‰¾ä¸åˆ°è§’è‰²ï¼');
        console.log('æŸ¥æ‰¾å¤±æ•—ï¼Œæ‰€æœ‰è§’è‰²ID:', characters.map(c => ({id: c.id, name: c.name, type: typeof c.id})));
        alert('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è§’è‰²ï¼è«‹é‡æ–°è¼‰å…¥é é¢è©¦è©¦ã€‚');
    }
}

// æ ¹æ“šIDåˆªé™¤è§’è‰²ï¼ˆæ–°å‡½æ•¸ï¼Œé¿å…åç¨±è¡çªï¼‰
function deleteCharacterById(id) {
    console.log('=== åˆªé™¤è§’è‰²é–‹å§‹ ===');
    console.log('è¦åˆªé™¤çš„ID:', id, 'é¡å‹:', typeof id);
    
    // å˜—è©¦å¤šç¨®æ–¹å¼æŸ¥æ‰¾è§’è‰²
    let character = characters.find(c => c.id === id);
    if (!character) {
        character = characters.find(c => String(c.id) === String(id));
    }
    if (!character) {
        character = characters.find(c => c.id == id);
    }
    
    console.log('æ‰¾åˆ°è¦åˆªé™¤çš„è§’è‰²:', character);
    
    if (!character) {
        alert('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è§’è‰²ï¼');
        return;
    }
    
    if (confirm(`ç¢ºå®šè¦åˆªé™¤è§’è‰²ã€Œ${character.name}ã€å—ï¼Ÿ`)) {
        const originalLength = characters.length;
        
        // å˜—è©¦å¤šç¨®æ–¹å¼åˆªé™¤
        characters = characters.filter(c => c.id !== id);
        if (characters.length === originalLength) {
            characters = characters.filter(c => String(c.id) !== String(id));
        }
        if (characters.length === originalLength) {
            characters = characters.filter(c => c.id != id);
        }
        
        console.log('åˆªé™¤å¾Œè§’è‰²æ•¸é‡:', characters.length);
        console.log('å‰©é¤˜è§’è‰²:', characters);
        
        updateCharacterList();
        updateSpeakerSelect();
        console.log('=== åˆªé™¤è§’è‰²å®Œæˆ ===');
    }
}
       // ç·¨è¼¯è§’è‰²
function editCharacter(id) {
    console.log('ç·¨è¼¯è§’è‰²ID:', id, 'é¡å‹:', typeof id); // é™¤éŒ¯ç”¨
    const character = characters.find(c => c.id == id); // ä½¿ç”¨ == è€Œä¸æ˜¯ ===
    console.log('æ‰¾åˆ°è§’è‰²:', character); // é™¤éŒ¯ç”¨
    if (character) {
        currentEditingCharacter = id;
        document.getElementById('char-name').value = character.name || '';
        document.getElementById('char-personality').value = character.personality || '';
        document.getElementById('char-tone').value = character.tone || '';
        document.getElementById('char-behavior').value = character.behavior || '';
        switchTab('character');
    } else {
        console.error('æ‰¾ä¸åˆ°è§’è‰²ï¼ŒID:', id, 'ç¾æœ‰è§’è‰²:', characters);
        alert('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è§’è‰²ï¼');
    }
}

        // åˆªé™¤è§’è‰²
        // åˆªé™¤è§’è‰²
function deleteCharacter(id) {
    console.log('åˆªé™¤è§’è‰²ID:', id, 'é¡å‹:', typeof id); // é™¤éŒ¯ç”¨
    const character = characters.find(c => c.id == id);
    console.log('è¦åˆªé™¤çš„è§’è‰²:', character); // é™¤éŒ¯ç”¨
    
    if (!character) {
        alert('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è§’è‰²ï¼');
        return;
    }
    
    if (confirm(`ç¢ºå®šè¦åˆªé™¤è§’è‰²ã€Œ${character.name}ã€å—ï¼Ÿ`)) {
        characters = characters.filter(c => c.id != id); // ä½¿ç”¨ != è€Œä¸æ˜¯ !==
        updateCharacterList();
        updateSpeakerSelect();
        console.log('è§’è‰²å·²åˆªé™¤ï¼Œå‰©é¤˜è§’è‰²:', characters); // é™¤éŒ¯ç”¨
    }
}

        // å®‰å…¨ç²å–API Key
        function getAPIKey() {
    const service = document.getElementById('api-service').value;
    
    switch(service) {
        case 'huggingface':
            return document.getElementById('hf-api-key').value.trim();
        case 'deepseek':
            return document.getElementById('deepseek-api-key').value.trim();
        case 'groq':
            return document.getElementById('groq-api-key').value.trim();
        case 'simulation':
        default:
            return null; // æ¨¡æ“¬æ¨¡å¼ä¸éœ€è¦API Key
    }
}

        // æ–°å¢å°è©±æ™‚æ›´æ–°è§’è‰²è¨˜æ†¶
        function addDialogue() {
            const speakerId = document.getElementById('speaker-select').value;
            const content = document.getElementById('dialogue-input').value.trim();

            console.log('ç™¼é€å°è©± - èªªè©±è€…ID:', speakerId, 'å…§å®¹:', content);

            if (!speakerId) {
                alert('è«‹å…ˆé¸æ“‡èªªè©±è€…ï¼');
                return;
            }

            if (!content) {
                alert('è«‹è¼¸å…¥å°è©±å…§å®¹ï¼');
                return;
            }

            const speaker = characters.find(c => c.id == speakerId);
            
            if (!speaker) {
                alert('æ‰¾ä¸åˆ°é¸æ“‡çš„è§’è‰²ï¼');
                return;
            }

            // æ›´æ–°è§’è‰²è¨˜æ†¶
            updateCharacterMemory(speakerId, content, 'æ‰‹å‹•è¼¸å…¥');

            const dialogue = {
                type: 'dialogue',
                speaker: speaker.name,
                speakerId: speakerId,
                content: content,
                timestamp: new Date()
            };

            dialogues.push(dialogue);
            displayDialogue(dialogue);
            document.getElementById('dialogue-input').value = '';
            
            console.log('å°è©±å·²æ–°å¢:', dialogue);
        }

        // æ–°å¢æ—ç™½
        function addNarrator() {
            const content = prompt('è«‹è¼¸å…¥æ—ç™½å…§å®¹ï¼š');
            if (content) {
                const narrator = {
                    type: 'narrator',
                    content: content,
                    timestamp: new Date()
                };
                dialogues.push(narrator);
                displayNarrator(narrator);
            }
        }

        // é¡¯ç¤ºå°è©±
        function displayDialogue(dialogue) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºä¸»è§’
            const isProtagonist = protagonistId && dialogue.speakerId == protagonistId;
            messageDiv.className = isProtagonist ? 'message protagonist' : 'message other';
            
            messageDiv.innerHTML = `
                <div class="message-header">${dialogue.speaker}</div>
                ${dialogue.content}
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // é¡¯ç¤ºæ—ç™½
        function displayNarrator(narrator) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message narrator';
            messageDiv.innerHTML = narrator.content; // ç§»é™¤æ—ç™½æ¨™é¡Œ
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // AIç”Ÿæˆå°è©±
        function generateAIDialogue() {
            const apiKey = getAPIKey();
            if (!apiKey) {
                alert('è«‹å…ˆè¼¸å…¥OpenRouter API Keyï¼\n\nğŸ”’ å®‰å…¨æç¤ºï¼š\nâ€¢ API Keyåªæœƒæš«æ™‚å„²å­˜åœ¨è¨˜æ†¶é«”ä¸­\nâ€¢ ä¸æœƒè¢«ä¿å­˜åˆ°æª”æ¡ˆæˆ–åˆ†äº«çµ¦ä»–äºº\nâ€¢ é—œé–‰ç€è¦½å™¨å¾Œæœƒè‡ªå‹•æ¸…é™¤\n\nğŸ“ å» openrouter.ai å–å¾—API Key');
                return;
            }
            
            // é¡¯ç¤ºAIæ§åˆ¶é¢æ¿
            document.getElementById('ai-controls').style.display = 'block';
            updateCharacterCheckboxes();
        }

        // ç”Ÿæˆå ´æ™¯
        function generateAIScene() {
            const apiKey = getAPIKey();
            if (!apiKey) {
                alert('è«‹å…ˆè¼¸å…¥OpenRouter API Keyï¼');
                return;
            }
            
            generateSceneDescription();
        }

        // é–‹å§‹å°èªªç”Ÿæˆï¼ˆå®Œå…¨é‡å¯«ï¼Œå„ªå…ˆä½¿ç”¨æ¨¡æ“¬ï¼‰
        // é–‹å§‹å°èªªç”Ÿæˆï¼ˆä¿®å¾©ç‰ˆæœ¬ï¼‰
async function startNovelGeneration() {
    console.log('é–‹å§‹ç”Ÿæˆå°èªª...');
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„è§’è‰²
    const selectedCharacters = getSelectedCharactersForNovel();
    const availableCharacters = selectedCharacters.length > 0 ? selectedCharacters : characters;
    
    if (availableCharacters.length < 2) {
        alert('è«‹è‡³å°‘å»ºç«‹æˆ–é¸æ“‡2å€‹è§’è‰²ä¾†åƒèˆ‡å°èªªå‰µä½œï¼');
        return;
    }
    
    const outline = document.getElementById('novel-outline').value;
    const length = parseInt(document.getElementById('novel-length').value);
    
    // ç²å–çµå°¾é¢¨æ ¼
    const endingSelect = document.getElementById('novel-ending').value;
    const customEnding = document.getElementById('custom-ending').value;
    const ending = endingSelect === 'custom' ? customEnding : endingSelect;
    
    // ç²å–è§’è‰²æ•¸é‡ï¼ˆä½¿ç”¨å¯¦éš›é¸æ“‡çš„è§’è‰²æ•¸é‡ï¼‰
    const characterCount = availableCharacters.length;

    // é©—è­‰è¼¸å…¥
    if (!outline.trim()) {
        alert('è«‹è¼¸å…¥å°èªªå¤§ç¶±ï¼');
        return;
    }

    if (endingSelect === 'custom' && !customEnding.trim()) {
        alert('è«‹æè¿°ä½ æƒ³è¦çš„çµå°¾é¢¨æ ¼ï¼');
        return;
    }

    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'ğŸ“š ç”Ÿæˆä¸­...è«‹ç¨å€™';
    btn.disabled = true;

    try {
        // æ¸…ç©ºç¾æœ‰å…§å®¹
        if (confirm('ç”Ÿæˆæ–°å°èªªå°‡æ¸…ç©ºç¾æœ‰å…§å®¹ï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
            dialogues = [];
            characterMemories = {};
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
        } else {
            return;
        }

        // ä½¿ç”¨é¸æ“‡çš„è§’è‰²ç”Ÿæˆå°èªª
        await generateNovelWithSelectedCharacters(outline, length, ending, availableCharacters);
        
        hideNovelGeneration();
        showSecurityTip('ğŸ“š å°èªªç”Ÿæˆå®Œæˆï¼');
        
    } catch (error) {
        console.error('å°èªªç”Ÿæˆå¤±æ•—:', error);
        alert('å°èªªç”Ÿæˆå¤±æ•—ï¼š' + error.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// ä½¿ç”¨é¸æ“‡çš„è§’è‰²ç”Ÿæˆå°èªª
async function generateNovelWithSelectedCharacters(outline, length, ending, selectedCharacters) {
    console.log('ä½¿ç”¨é¸æ“‡çš„è§’è‰²ç”Ÿæˆå°èªª...', {outline, length, ending, characters: selectedCharacters.map(c => c.name)});
    
    showSecurityTip('ğŸ“ æ­£åœ¨æ§‹æ€å°èªªçµæ§‹...');
    
    // ç”Ÿæˆç« ç¯€
    const chapters = generateChapterPlan(outline, ending, length);
    
    showSecurityTip(`âœï¸ é–‹å§‹å‰µä½œ ${chapters.length} å€‹ç« ç¯€...`);
    
    // é€ç« ç”Ÿæˆå…§å®¹
    for (let i = 0; i < chapters.length; i++) {
        const chapter = chapters[i];
        showSecurityTip(`ğŸ“– æ­£åœ¨å‰µä½œç¬¬ ${i + 1} ç« ï¼š${chapter.title}`);
        
        // ç« ç¯€æ¨™é¡Œ
        const titleNarrator = {
            type: 'narrator',
            content: `=== ç¬¬${i + 1}ç« ï¼š${chapter.title} ===`,
            timestamp: new Date(),
            generated: true,
            isChapterTitle: true
        };
        dialogues.push(titleNarrator);
        displayNarrator(titleNarrator);
        
        // ç”Ÿæˆç« ç¯€å…§å®¹ï¼ˆä½¿ç”¨é¸æ“‡çš„è§’è‰²ï¼‰
        await generateSimulatedChapterContent(chapter, selectedCharacters, outline, i + 1);
        
        // ç« ç¯€é–“éš”
        await new Promise(resolve => setTimeout(resolve, 800));
    }
    
    // çµå°¾
    const endingNarrator = {
        type: 'narrator',
        content: `=== å…¨æ–‡å®Œ ===\n\nï¼ˆæœ¬å°èªªç”±AIæ ¹æ“šå¤§ç¶±ã€Œ${outline.substring(0, 30)}...ã€è‡ªå‹•ç”Ÿæˆï¼‰`,
        timestamp: new Date(),
        generated: true
    };
    dialogues.push(endingNarrator);
    displayNarrator(endingNarrator);
}

        // ç”Ÿæˆå°èªªè§’è‰²
        // ç²å–ç”¨æˆ¶é¸æ“‡çš„è§’è‰²ï¼ˆæ–°å¢å‡½æ•¸ï¼‰
function getSelectedCharactersForNovel() {
    const checkboxes = document.querySelectorAll('#character-checkboxes input[type="checkbox"]:checked');
    const selectedCharacters = [];
    
    checkboxes.forEach(checkbox => {
        const characterId = checkbox.value;
        const character = characters.find(c => c.id === characterId);
        if (character) {
            selectedCharacters.push(character);
        }
    });
    
    return selectedCharacters;
}

// ä¿®æ”¹åŸå‡½æ•¸
function generateNovelCharacters(count, outline) {
    // å„ªå…ˆä½¿ç”¨ç”¨æˆ¶é¸æ“‡çš„è§’è‰²
    const selectedCharacters = getSelectedCharactersForNovel();
    
    if (selectedCharacters.length >= 2) {
        return selectedCharacters;
    }
    
    // å¦‚æœæ²’æœ‰è¶³å¤ çš„é¸æ“‡è§’è‰²ï¼Œä½¿ç”¨ç¾æœ‰è§’è‰²
    if (characters.length >= 2) {
        return characters.slice(0, Math.min(count, characters.length));
    }
    
    // æœ€å¾Œæ‰ä½¿ç”¨æ¨¡æ¿è§’è‰²
    const characterTemplates = [
        { name: 'å°æ‚ ', personality: 'æ´»æ½‘é–‹æœ—', tone: 'ç›´æ¥ç†±æƒ…', behavior: 'å–œæ­¡å†’éšªï¼Œæ•¢æ–¼è¡¨é”' },
        { name: 'é˜¿ç¿”', personality: 'æ²‰ç©©å¯é ', tone: 'æº«å’Œç†æ€§', behavior: 'æ·±æ€ç†Ÿæ…®ï¼Œä¿è­·ä»–äºº' },
        { name: 'ç¾é¦™', personality: 'æº«æŸ”å–„è‰¯', tone: 'è¼•è²ç´°èª', behavior: 'é«”è²¼å…¥å¾®ï¼Œå–„è§£äººæ„' },
        { name: 'å¤§é›„', personality: 'å¹½é»˜é¢¨è¶£', tone: 'è¼•é¬†è©¼è«§', behavior: 'æ„›é–‹ç©ç¬‘ï¼ŒåŒ–è§£å°·å°¬' }
    ];
    
    return characterTemplates.slice(0, count);
}

        // ç”Ÿæˆç« ç¯€è¨ˆåŠƒ
        function generateChapterPlan(outline, ending, length) {
            const baseChapters = [
                { title: 'ç›¸é‡', theme: 'è§’è‰²ç™»å ´èˆ‡åˆæ¬¡äº’å‹•', mood: 'light' },
                { title: 'ç›¸è­˜', theme: 'æ·±å…¥äº†è§£èˆ‡å‹èª¼å»ºç«‹', mood: 'warm' },
                { title: 'è¡çª', theme: 'å•é¡Œå‡ºç¾èˆ‡é—œä¿‚ç·Šå¼µ', mood: 'tense' },
                { title: 'æˆé•·', theme: 'è§’è‰²é¢å°å›°é›£ä¸¦æˆé•·', mood: 'emotional' },
                { title: 'è§£æ±º', theme: 'å•é¡Œè§£æ±ºèˆ‡é—œä¿‚ä¿®å¾©', mood: 'hopeful' }
            ];
            
            // æ ¹æ“šå­—æ•¸èª¿æ•´ç« ç¯€æ•¸é‡
            let chapterCount = 3;
            if (length >= 10000) chapterCount = 4;
            if (length >= 15000) chapterCount = 5;
            if (length >= 20000) chapterCount = 6;
            
            return baseChapters.slice(0, chapterCount);
        }

        // ç”Ÿæˆæ¨¡æ“¬ç« ç¯€å…§å®¹
// ç”Ÿæˆèˆ‡å¤§ç¶±ç›¸é—œçš„ç« ç¯€å…§å®¹ï¼ˆæ”¯æ´çœŸå¯¦APIï¼‰
async function generateSimulatedChapterContent(chapter, characters, outline, chapterNum) {
    console.log(`ç”Ÿæˆç¬¬${chapterNum}ç« ï¼Œå¤§ç¶±ï¼š${outline}`);
    
    const apiService = document.getElementById('api-service').value;
    const apiKey = getAPIKeyByService(apiService);
    
    // å¦‚æœæœ‰API Keyä¸”ä¸æ˜¯æ¨¡æ“¬æ¨¡å¼ï¼Œä½¿ç”¨çœŸå¯¦API
    if (apiKey && apiService !== 'simulation') {
        try {
            console.log(`ä½¿ç”¨ ${apiService} APIç”Ÿæˆç¬¬${chapterNum}ç« ...`);
            await generateChapterWithAPI(apiKey, apiService, chapter, characters, outline, chapterNum);
            showSecurityTip(`ğŸ¤– ${apiService.toUpperCase()} ç”Ÿæˆç¬¬${chapterNum}ç« å®Œæˆ`);
            return;
        } catch (error) {
            console.error(`${apiService} APIå¤±æ•—ï¼Œæ”¹ç”¨æœ¬åœ°ç”Ÿæˆ:`, error);
            showSecurityTip(`ğŸ”„ APIå¤±æ•—ï¼Œæ”¹ç”¨æœ¬åœ°ç”Ÿæˆç¬¬${chapterNum}ç« `);
        }
    }
    
    // APIå¤±æ•—æˆ–æ²’æœ‰API Keyæ™‚ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
    console.log(`ä½¿ç”¨æœ¬åœ°ç”Ÿæˆç¬¬${chapterNum}ç« ...`);
    const outlineKeywords = extractOutlineKeywords(outline);
    const contentPieces = generateOutlineRelatedContent(chapter, characters, outline, outlineKeywords, chapterNum);
    
    for (const piece of contentPieces) {
        if (piece.startsWith('æ—ç™½ï¼š')) {
            const content = piece.replace('æ—ç™½ï¼š', '');
            const narrator = {
                type: 'narrator',
                content: content,
                timestamp: new Date(),
                generated: true
            };
            dialogues.push(narrator);
            displayNarrator(narrator);
            
        } else if (piece.startsWith('å‹•ä½œï¼š')) {
            const content = piece.replace('å‹•ä½œï¼š', '');
            const action = {
                type: 'narrator',
                content: `ã€”${content}ã€•`,
                timestamp: new Date(),
                generated: true,
                isAction: true
            };
            dialogues.push(action);
            displayActionDescription(action);
            
        } else {
            const match = piece.match(/^(.+?)ï¼šã€Œ(.+)ã€$/);
            if (match) {
                const [, speaker, content] = match;
                const dialogue = {
                    type: 'dialogue',
                    speaker: speaker,
                    speakerId: 'novel_' + speaker,
                    content: content,
                    timestamp: new Date(),
                    generated: true
                };
                dialogues.push(dialogue);
                displayDialogue(dialogue);
            }
        }
        
        await new Promise(resolve => setTimeout(resolve, 800));
    }
}

// æ–°å¢ï¼šæå–å¤§ç¶±é—œéµè©
function extractOutlineKeywords(outline) {
    const keywords = {
        location: [],
        emotion: [],
        action: [],
        theme: []
    };
    
    // åœ°é»ç›¸é—œ
    const locations = ['å­¸æ ¡', 'æ•™å®¤', 'å’–å•¡å»³', 'å…¬åœ’', 'å®¶', 'åœ–æ›¸é¤¨', 'è¡—é“', 'æµ·é‚Š', 'å±±ä¸Š', 'è¾¦å…¬å®¤', 'é†«é™¢', 'å•†åº—', 'é¤å»³'];
    locations.forEach(loc => {
        if (outline.includes(loc)) keywords.location.push(loc);
    });
    
    // æƒ…æ„Ÿç›¸é—œ
    const emotions = ['å‹æƒ…', 'æ„›æƒ…', 'å¿«æ¨‚', 'æ‚²å‚·', 'æ„Ÿå‹•', 'æº«é¦¨', 'ç·Šå¼µ', 'èˆˆå¥®', 'æµªæ¼«', 'æº«æš–', 'é—œæ‡·', 'æ”¯æŒ'];
    emotions.forEach(emotion => {
        if (outline.includes(emotion)) keywords.emotion.push(emotion);
    });
    
    // å‹•ä½œç›¸é—œ
    const actions = ['ç›¸é‡', 'èªè­˜', 'åˆ†é›¢', 'é‡é€¢', 'è¡çª', 'å’Œè§£', 'æˆé•·', 'å­¸ç¿’', 'å¹«åŠ©', 'åˆä½œ', 'ç«¶çˆ­', 'ç´„æœƒ'];
    actions.forEach(action => {
        if (outline.includes(action)) keywords.action.push(action);
    });
    
    // ä¸»é¡Œç›¸é—œ
    const themes = ['é’æ˜¥', 'æ ¡åœ’', 'è·å ´', 'å®¶åº­', 'å¤¢æƒ³', 'æŒ‘æˆ°', 'æˆåŠŸ', 'å¤±æ•—', 'åŠªåŠ›', 'å …æŒ'];
    themes.forEach(theme => {
        if (outline.includes(theme)) keywords.theme.push(theme);
    });
    
    return keywords;
}

// æ–°å¢ï¼šç”Ÿæˆèˆ‡å¤§ç¶±ç›¸é—œçš„å…§å®¹
function generateOutlineRelatedContent(chapter, characters, outline, keywords, chapterNum) {
    const content = [];
    
    // æ ¹æ“šå¤§ç¶±è¨­å®šå ´æ™¯
    let setting = 'å¹³å‡¡çš„ä¸€å¤©é–‹å§‹äº†';
    if (keywords.location.length > 0) {
        setting = `åœ¨${keywords.location[0]}è£¡ï¼Œæ•…äº‹æ­£åœ¨å±•é–‹`;
    } else if (outline.includes('å®¤å…§')) {
        setting = 'åœ¨æº«é¦¨çš„å®¤å…§ç’°å¢ƒä¸­';
    } else if (outline.includes('æˆ¶å¤–')) {
        setting = 'åœ¨é–‹é—Šçš„æˆ¶å¤–ç©ºé–“è£¡';
    }
    
    // ç¢ºä¿æœ‰è¶³å¤ çš„è§’è‰²
    const character1 = characters[0];
    const character2 = characters[1] || characters[0];
    
    content.push(`æ—ç™½ï¼š${setting}ï¼Œ${chapter.title}çš„æ•…äº‹å³å°‡é–‹å§‹ã€‚`);
    
    // æ ¹æ“šå¤§ç¶±ä¸»é¡Œç”Ÿæˆå°è©±
    if (keywords.emotion.includes('å‹æƒ…')) {
        content.push(`${character1.name}ï¼šã€Œæˆ‘è¦ºå¾—æˆ‘å€‘èƒ½æˆç‚ºå¾ˆå¥½çš„æœ‹å‹ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character1.name}çœŸèª åœ°çœ‹è‘—${character2.name}ï¼Œçœ¼ä¸­é–ƒçˆè‘—å‹å–„çš„å…‰èŠ’ã€‚`);
        content.push(`${character2.name}ï¼šã€Œæˆ‘ä¹Ÿé€™éº¼èªç‚ºï¼Œå¾ˆé«˜èˆˆèƒ½èªè­˜ä½ ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character2.name}å¾®ç¬‘è‘—é»é ­å›æ‡‰ã€‚`);
        
    } else if (keywords.emotion.includes('æ„›æƒ…') || keywords.emotion.includes('æµªæ¼«')) {
        content.push(`${character1.name}ï¼šã€Œå’Œä½ åœ¨ä¸€èµ·çš„æ™‚å…‰ç¸½æ˜¯é‚£éº¼ç¾å¥½ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character1.name}æº«æŸ”åœ°å‡è¦–è‘—${character2.name}ã€‚`);
        content.push(`${character2.name}ï¼šã€Œæˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ„Ÿå—...ã€`);
        content.push(`å‹•ä½œï¼š${character2.name}è‡‰ç´…äº†ï¼Œè¼•è²å›æ‡‰ã€‚`);
        
    } else if (keywords.action.includes('å­¸ç¿’') || keywords.location.includes('å­¸æ ¡') || outline.includes('å­¸ç¿’')) {
        content.push(`${character1.name}ï¼šã€Œé—œæ–¼é€™å€‹å•é¡Œï¼Œä½ æœ‰ä»€éº¼æƒ³æ³•å—ï¼Ÿã€`);
        content.push(`å‹•ä½œï¼š${character1.name}æŒ‡è‘—é¢å‰çš„è³‡æ–™ï¼Œè¡¨æƒ…å°ˆæ³¨ã€‚`);
        content.push(`${character2.name}ï¼šã€Œè®“æˆ‘ä»”ç´°æƒ³æƒ³...æˆ‘è¦ºå¾—å¯èƒ½æ˜¯é€™æ¨£çš„ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character2.name}çšºçœ‰æ€è€ƒï¼Œç„¶å¾Œçœ¼ç›ä¸€äº®ã€‚`);
        
    } else if (keywords.action.includes('å†’éšª') || keywords.action.includes('æ¢ç´¢')) {
        content.push(`${character1.name}ï¼šã€Œæˆ‘å€‘å»é‚£é‚Šçœ‹çœ‹å§ï¼èªªä¸å®šæœƒæœ‰æ–°ç™¼ç¾ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character1.name}èˆˆå¥®åœ°æŒ‡å‘é æ–¹ï¼Œçœ¼ä¸­å……æ»¿å¥½å¥‡ã€‚`);
        content.push(`${character2.name}ï¼šã€Œå¥½çš„ï¼Œä¸€èµ·å»æ¢ç´¢å§ï¼ã€`);
        content.push(`å‹•ä½œï¼š${character2.name}ä¹Ÿè¢«é€™ä»½ç†±æƒ…æ„ŸæŸ“ï¼Œè·Ÿè‘—ç«™äº†èµ·ä¾†ã€‚`);
        
    } else if (keywords.action.includes('è¡çª')) {
        content.push(`${character1.name}ï¼šã€Œæˆ‘ä¸åŒæ„ä½ çš„çœ‹æ³•ï¼Œé€™æ¨£åšæ˜¯ä¸å°çš„ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character1.name}èªæ°£å …å®šï¼Œè¡¨æƒ…åš´è‚…ã€‚`);
        content.push(`${character2.name}ï¼šã€Œä½†æ˜¯æˆ‘æœ‰æˆ‘çš„ç†ç”±...ã€`);
        content.push(`å‹•ä½œï¼š${character2.name}ä½ä¸‹é ­ï¼Œçœ‹èµ·ä¾†æœ‰äº›å§”å±ˆã€‚`);
        
    } else if (keywords.action.includes('å’Œè§£')) {
        content.push(`${character1.name}ï¼šã€Œå°ä¸èµ·ï¼Œæˆ‘ä¹‹å‰èªªè©±å¤ªé‡äº†ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character1.name}çœŸèª åœ°é“æ­‰ï¼Œçœ¼ä¸­å¸¶è‘—æ­‰æ„ã€‚`);
        content.push(`${character2.name}ï¼šã€Œæ²’é—œä¿‚ï¼Œæˆ‘ä¹Ÿæœ‰ä¸å°çš„åœ°æ–¹ã€‚ã€`);
        content.push(`å‹•ä½œï¼š${character2.name}å¯¬å®¹åœ°ç¬‘äº†ç¬‘ã€‚`);
        
    } else {
        // ä½¿ç”¨å¤§ç¶±çš„å…·é«”å…§å®¹ç”Ÿæˆå°è©±
        const outlineWords = outline.split(/[ï¼Œã€‚ã€ï¼ï¼Ÿ\s]/).filter(w => w.trim() && w.length > 1);
        
        if (outlineWords.length > 0) {
            const relevantWord = outlineWords[Math.min(chapterNum - 1, outlineWords.length - 1)];
            content.push(`${character1.name}ï¼šã€Œé—œæ–¼${relevantWord}é€™ä»¶äº‹ï¼Œæˆ‘æƒ³å’Œä½ å¥½å¥½è«‡è«‡ã€‚ã€`);
            content.push(`å‹•ä½œï¼š${character1.name}èªçœŸåœ°çœ‹è‘—${character2.name}ã€‚`);
            content.push(`${character2.name}ï¼šã€Œå¥½çš„ï¼Œæˆ‘å¾ˆæ¨‚æ„è½ä½ çš„æƒ³æ³•ã€‚ã€`);
            content.push(`å‹•ä½œï¼š${character2.name}å°ˆæ³¨åœ°è½è‘—ï¼Œé»äº†é»é ­ã€‚`);
        } else {
            // å¦‚æœç„¡æ³•è§£æå¤§ç¶±ï¼Œä½¿ç”¨é€šç”¨å°è©±
            content.push(`${character1.name}ï¼šã€Œä»Šå¤©æ„Ÿè¦ºæœƒæ˜¯ç‰¹åˆ¥çš„ä¸€å¤©ã€‚ã€`);
            content.push(`å‹•ä½œï¼š${character1.name}æœ›å‘çª—å¤–ï¼Œè‹¥æœ‰æ‰€æ€ã€‚`);
            content.push(`${character2.name}ï¼šã€Œæ˜¯çš„ï¼Œæˆ‘ä¹Ÿæœ‰é€™ç¨®æ„Ÿè¦ºã€‚ã€`);
            content.push(`å‹•ä½œï¼š${character2.name}è´ŠåŒåœ°é»é ­ã€‚`);
        }
    }
    
    // æ·»åŠ ç« ç¯€ç™¼å±•
    content.push(`æ—ç™½ï¼šå…©äººçš„å°è©±é€æ¼¸æ·±å…¥ï¼Œ${outline.substring(0, 20)}...çš„æ•…äº‹æ­£åœ¨å±•é–‹ã€‚`);
    
    // æ ¹æ“šæƒ…ç·’æ·»åŠ çµå°¾
    if (keywords.emotion.includes('æº«é¦¨') || keywords.emotion.includes('å¿«æ¨‚')) {
        content.push(`æ—ç™½ï¼šæº«æš–çš„æ°›åœåœ¨å…©äººä¹‹é–“æµæ·Œï¼Œé€™å€‹ç¾å¥½çš„æ™‚åˆ»å°‡æœƒæ·±æ·±å°åœ¨ä»–å€‘çš„è¨˜æ†¶ä¸­ã€‚`);
    } else if (keywords.emotion.includes('ç·Šå¼µ') || keywords.emotion.includes('è¡çª')) {
        content.push(`æ—ç™½ï¼šç©ºæ°£ä¸­å½Œæ¼«è‘—ç·Šå¼µçš„æ°£æ¯ï¼Œæƒ…æ³è®Šå¾—è¤‡é›œèµ·ä¾†ã€‚`);
    } else {
        content.push(`æ—ç™½ï¼š${generateChapterEnding(chapter.mood || 'neutral')}`);
    }
    
    return content;
}

        // ç”Ÿæˆå ´æ™¯è¨­å®š
        function generateSceneSetting(mood) {
            const settings = {
                light: ['é™½å…‰é€éçª—æˆ¶ç‘é€²æ•™å®¤ï¼Œæ–°çš„ä¸€å¤©é–‹å§‹äº†ã€‚', 'å¾®é¢¨è¼•æ’«ï¼Œå¸¶ä¾†æ˜¥å¤©çš„æ°£æ¯ã€‚', 'å’–å•¡å»³è£¡å‚³ä¾†è¼•æŸ”çš„éŸ³æ¨‚è²ã€‚'],
                warm: ['æº«æš–çš„åˆå¾Œï¼Œå…©äººååœ¨å…¬åœ’çš„é•·æ¤…ä¸Šã€‚', 'å¤•é™½è¥¿ä¸‹ï¼Œå°‡ä¸€åˆ‡éƒ½æŸ“æˆé‡‘é»ƒè‰²ã€‚', 'å®¶çš„æº«é¦¨æ°›åœåŒ…åœè‘—æ¯å€‹äººã€‚'],
                tense: ['çƒé›²å¯†å¸ƒï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—ç·Šå¼µçš„æ°£æ°›ã€‚', 'æ•™å®¤è£¡å®‰éœå¾—åªèƒ½è½è¦‹å¿ƒè·³è²ã€‚', 'èµ°å»Šä¸Šçš„è…³æ­¥è²é¡¯å¾—æ ¼å¤–éŸ¿äº®ã€‚'],
                emotional: ['é›¨æ»´è¼•æ•²è‘—çª—æˆ¶ï¼Œè¨´èªªè‘—å¿ƒä¸­çš„æƒ…æ„Ÿã€‚', 'æœˆå…‰ä¸‹ï¼ŒçœŸå¿ƒè©±çµ‚æ–¼èªªå‡ºå£ã€‚', 'æ·šæ°´æ¨¡ç³Šäº†è¦–ç·šï¼Œä½†å¿ƒå»è®Šå¾—æ¸…æ™°ã€‚'],
                hopeful: ['é›¨éå¤©æ™´ï¼Œå½©è™¹åœ¨å¤©ç©ºä¸­ç¶»æ”¾ã€‚', 'æ–°çš„æ—©æ™¨å¸¶ä¾†äº†æ–°çš„å¸Œæœ›ã€‚', 'ç¬‘è²å†æ¬¡åœ¨æˆ¿é–“è£¡éŸ¿èµ·ã€‚']
            };
            const options = settings[mood] || settings.light;
            return options[Math.floor(Math.random() * options.length)];
        }

        // ç”Ÿæˆå°è©±å…§å®¹
        function generateDialogueByMood(mood, character, type) {
            const dialogues = {
                light: {
                    opening: ['ä»Šå¤©å¤©æ°£çœŸå¥½å‘¢ï¼', 'ä½ å¥½ï¼Œå¾ˆé«˜èˆˆè¦‹åˆ°ä½ ã€‚', 'æˆ‘å€‘é–‹å§‹å§ï¼'],
                    response: ['æ˜¯å•Šï¼Œå¿ƒæƒ…ä¹Ÿè®Šå¥½äº†ã€‚', 'æˆ‘ä¹Ÿæ˜¯ï¼Œè¬è¬ä½ ã€‚', 'å¥½çš„ï¼Œæˆ‘æº–å‚™å¥½äº†ã€‚'],
                    development: ['é€™è®“æˆ‘æƒ³åˆ°ä¸€ä»¶æœ‰è¶£çš„äº‹ã€‚', 'æˆ‘å€‘å¯ä»¥è©¦è©¦çœ‹é€™å€‹æƒ³æ³•ã€‚', 'ä½ è¦ºå¾—æ€éº¼æ¨£ï¼Ÿ']
                },
                warm: {
                    opening: ['å’Œä½ åœ¨ä¸€èµ·çœŸçš„å¾ˆé–‹å¿ƒã€‚', 'è¬è¬ä½ ä¸€ç›´é™ªä¼´è‘—æˆ‘ã€‚', 'é€™ç¨®æ„Ÿè¦ºçœŸçš„å¾ˆæ£’ã€‚'],
                    response: ['æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ„Ÿå—ã€‚', 'é€™æ˜¯æˆ‘æ‡‰è©²åšçš„ã€‚', 'æˆ‘å¾ˆçæƒœé€™äº›æ™‚å…‰ã€‚'],
                    development: ['æˆ‘æƒ³å’Œä½ åˆ†äº«æ›´å¤šã€‚', 'æˆ‘å€‘çš„å‹èª¼å¾ˆçè²´ã€‚', 'å¸Œæœ›æ™‚é–“èƒ½åœæ­¢åœ¨é€™ä¸€åˆ»ã€‚']
                },
                tense: {
                    opening: ['æˆ‘å€‘éœ€è¦è«‡è«‡ã€‚', 'æƒ…æ³æ¯”æƒ³åƒçš„è¤‡é›œã€‚', 'æˆ‘æœ‰äº›æ“”å¿ƒã€‚'],
                    response: ['æˆ‘çŸ¥é“ï¼Œæˆ‘ä¹Ÿåœ¨æƒ³é€™å€‹å•é¡Œã€‚', 'æ˜¯çš„ï¼Œæˆ‘å€‘å¿…é ˆé¢å°ã€‚', 'å‘Šè¨´æˆ‘ä½ çš„æƒ³æ³•ã€‚'],
                    development: ['æˆ‘å€‘è©²æ€éº¼è¾¦ï¼Ÿ', 'æ™‚é–“ä¸å¤šäº†ã€‚', 'æˆ‘å€‘å¿…é ˆåšå‡ºé¸æ“‡ã€‚']
                },
                emotional: {
                    opening: ['æˆ‘æƒ³å‘Šè¨´ä½ ä¸€ä»¶é‡è¦çš„äº‹ã€‚', 'æˆ‘çš„å¿ƒæƒ…å¾ˆè¤‡é›œã€‚', 'é€™å°æˆ‘ä¾†èªªå¾ˆé‡è¦ã€‚'],
                    response: ['æˆ‘åœ¨è½ï¼Œè«‹èªªå§ã€‚', 'æˆ‘ç†è§£ä½ çš„æ„Ÿå—ã€‚', 'æˆ‘å€‘ä¸€èµ·é¢å°ã€‚'],
                    development: ['è¬è¬ä½ çš„ç†è§£ã€‚', 'æˆ‘æ„Ÿè¦ºå¥½å¤šäº†ã€‚', 'æœ‰ä½ çœŸå¥½ã€‚']
                },
                hopeful: {
                    opening: ['ä¸€åˆ‡éƒ½æœƒå¥½èµ·ä¾†çš„ã€‚', 'æˆ‘å€‘æˆåŠŸäº†ï¼', 'æ–°çš„é–‹å§‹ä¾†äº†ã€‚'],
                    response: ['æ˜¯çš„ï¼Œæˆ‘ä¹Ÿç›¸ä¿¡ã€‚', 'çœŸçš„å¤ªæ£’äº†ï¼', 'æˆ‘å€‘ä¸€èµ·è¿æ¥æœªä¾†ã€‚'],
                    development: ['æ˜å¤©æœƒæ›´å¥½ã€‚', 'æˆ‘å€‘å­¸åˆ°äº†å¾ˆå¤šã€‚', 'é€™æ˜¯æ–°çš„èµ·é»ã€‚']
                }
            };
            
            const moodDialogues = dialogues[mood] || dialogues.light;
            const typeDialogues = moodDialogues[type] || moodDialogues.opening;
            return typeDialogues[Math.floor(Math.random() * typeDialogues.length)];
        }

        // ç”Ÿæˆå‹•ä½œæè¿°
        function generateActionDescription(character, mood, actionType) {
            const actions = {
                speaking: ['èªçœŸåœ°çœ‹è‘—å°æ–¹', 'å¾®ç¬‘è‘—èªªé“', 'è¼•è²ç´°èªåœ°è¡¨é”'],
                responding: ['é»é»é ­è¡¨ç¤ºç†è§£', 'æ€è€ƒç‰‡åˆ»å¾Œå›ç­”', 'çœ¼ä¸­é–ƒçˆè‘—å…‰èŠ’'],
                thinking: ['é™·å…¥æ²‰æ€', 'çšºèµ·çœ‰é ­æ€è€ƒ', 'æœ›å‘é æ–¹']
            };
            
            const actionList = actions[actionType] || actions.speaking;
            const action = actionList[Math.floor(Math.random() * actionList.length)];
            return `${character.name}${action}ï¼Œå±•ç¾å‡º${character.personality}çš„ç‰¹è³ª`;
        }

        // ç”Ÿæˆæƒ…ç¯€ç™¼å±•
        function generatePlotDevelopment(theme) {
            const developments = {
                'è§’è‰²ç™»å ´èˆ‡åˆæ¬¡äº’å‹•': 'æ•…äº‹çš„ä¸»äººå…¬å€‘åœ¨å‘½é‹çš„å®‰æ’ä¸‹ç›¸é‡äº†ã€‚',
                'æ·±å…¥äº†è§£èˆ‡å‹èª¼å»ºç«‹': 'é€šéäº¤æµï¼Œä»–å€‘é–‹å§‹äº†è§£å½¼æ­¤çš„å…§å¿ƒä¸–ç•Œã€‚',
                'å•é¡Œå‡ºç¾èˆ‡é—œä¿‚ç·Šå¼µ': 'ä¸€å€‹æ„å¤–çš„äº‹ä»¶æ‰“ç ´äº†åŸæœ‰çš„å¹³éœã€‚',
                'è§’è‰²é¢å°å›°é›£ä¸¦æˆé•·': 'é¢å°æŒ‘æˆ°ï¼Œæ¯å€‹äººéƒ½åœ¨å°‹æ‰¾è‡ªå·±çš„ç­”æ¡ˆã€‚',
                'å•é¡Œè§£æ±ºèˆ‡é—œä¿‚ä¿®å¾©': 'ç¶“æ­·äº†ç£¨é›£ï¼Œä»–å€‘çµ‚æ–¼æ‰¾åˆ°äº†è§£æ±ºçš„æ–¹æ³•ã€‚'
            };
            return developments[theme] || 'æ•…äº‹åœ¨é€™è£¡æœ‰äº†æ–°çš„è½‰æŠ˜ã€‚';
        }

        // ç”Ÿæˆç« ç¯€çµå°¾
        function generateChapterEnding(mood) {
            const endings = {
                light: 'é€™å€‹æ„‰å¿«çš„æ™‚åˆ»å°‡æ°¸é ç•™åœ¨ä»–å€‘çš„è¨˜æ†¶ä¸­ã€‚',
                warm: 'æº«æš–çš„æƒ…æ„Ÿåœ¨å¿ƒä¸­æ…¢æ…¢ç™¼é…µã€‚',
                tense: 'ç·Šå¼µçš„æ°£æ°›è®“æ¯å€‹äººéƒ½æ„Ÿåˆ°å£“åŠ›ã€‚',
                emotional: 'æ·±æ·±çš„æƒ…æ„Ÿè§¸å‹•äº†åœ¨å ´çš„æ¯ä¸€å€‹äººã€‚',
                hopeful: 'æ–°çš„å¸Œæœ›åœ¨å¿ƒä¸­èŒèŠ½ã€‚'
            };
            return endings[mood] || 'é€™ä¸€ç« åˆ°æ­¤çµæŸï¼Œæ•…äº‹é‚„åœ¨ç¹¼çºŒã€‚';
        }

        // ç”Ÿæˆå°èªªå…§å®¹ï¼ˆæ”¹é€²ç‰ˆï¼ŒåŠ å…¥å‹•ä½œæè¿°ï¼‰
        async function generateNovelContent(outline, length, ending, characterCount) {
            const apiKey = getAPIKey();

            if (!apiKey) {
                alert('å°èªªè‡ªå‹•ç”Ÿæˆéœ€è¦API Keyï¼\n\nè«‹è¼¸å…¥OpenRouter API Keyå¾Œå†è©¦ã€‚');
                return;
            }

            // æ¸…ç©ºç¾æœ‰å°è©±
            if (confirm('ç”Ÿæˆæ–°å°èªªå°‡æ¸…ç©ºç¾æœ‰å…§å®¹ï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
                dialogues = [];
                characterMemories = {};
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
            } else {
                return;
            }

            try {
                // ç”Ÿæˆå°èªªçµæ§‹
                showSecurityTip('ğŸ“ æ­£åœ¨è¦åŠƒå°èªªçµæ§‹...');
                const novelStructure = await generateNovelStructure(apiKey, outline, length, ending, characterCount);
                
                // æ ¹æ“šçµæ§‹ç”Ÿæˆå…·é«”å…§å®¹
                showSecurityTip('âœï¸ é–‹å§‹å‰µä½œå°èªªå…§å®¹...');
                await generateNovelSections(apiKey, novelStructure);
                
            } catch (error) {
                console.error('å°èªªç”Ÿæˆéç¨‹å‡ºéŒ¯:', error);
                throw error;
            }
        }

        // ç”Ÿæˆå°èªªçµæ§‹ï¼ˆä¿®å¾©CORSå•é¡Œï¼‰
        async function generateNovelStructure(apiKey, outline, length, ending, characterCount) {
            const endingDescriptions = {
                happy: 'åœ“æ»¿çš„çµå±€ï¼Œæ‰€æœ‰å•é¡Œå¾—åˆ°è§£æ±ºï¼Œè§’è‰²ç²å¾—æˆé•·',
                open: 'é–‹æ”¾å¼çµå±€ï¼Œç•™çµ¦è®€è€…æƒ³åƒç©ºé–“ï¼ŒæŸäº›å•é¡Œæœªå®Œå…¨è§£æ±º',
                twist: 'æ„å¤–çš„è½‰æŠ˜çµå±€ï¼Œé¡›è¦†è®€è€…é æœŸï¼Œæ­ç¤ºéš±è—çœŸç›¸',
                emotional: 'æ„Ÿäººçš„çµå±€ï¼Œè§¸å‹•äººå¿ƒï¼Œå¼·èª¿æƒ…æ„Ÿå’Œé—œä¿‚',
                cliffhanger: 'æ‡¸å¿µçµå±€ï¼Œç‚ºçºŒé›†é‹ªè·¯ï¼Œç•™ä¸‹é‡å¤§æ‡¸å¿µ'
            };

            const prompt = `ä½ æ˜¯å°ˆæ¥­å°èªªç·¨åŠ‡ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚è¨­è¨ˆå°èªªçµæ§‹ï¼š

ã€å°èªªè¨­å®šã€‘
å¤§ç¶±ï¼š${outline}
ç›®æ¨™å­—æ•¸ï¼š${length}å­—
çµå°¾é¢¨æ ¼ï¼š${typeof ending === 'string' && endingDescriptions[ending] ? endingDescriptions[ending] : ending}
ä¸»è¦è§’è‰²æ•¸ï¼š${characterCount}å€‹

ã€è¦æ±‚ã€‘
1. è¨­è¨ˆ${characterCount}å€‹å„å…·ç‰¹è‰²çš„è§’è‰²ï¼ˆåŒ…å«å§“åã€å¹´é½¡ã€å€‹æ€§ã€èƒŒæ™¯ã€èªªè©±ç‰¹è‰²ï¼‰
2. è¦åŠƒ5-7å€‹ç« ç¯€ï¼Œæ¯ç« 1500-3000å­—
3. æ¯ç« éœ€è¦åŒ…å«å°è©±ã€å‹•ä½œæè¿°ã€å¿ƒç†æ´»å‹•
4. æƒ…ç¯€è¦æœ‰èµ·æ‰¿è½‰åˆï¼Œç¯€å¥ç·Šæ¹Š
5. å°è©±è¦è‡ªç„¶ç”Ÿå‹•ï¼Œç¬¦åˆè§’è‰²å€‹æ€§

ã€è¼¸å‡ºæ ¼å¼ã€‘
è§’è‰²è¨­å®šï¼š
è§’è‰²Aï¼š[å§“å] - [å¹´é½¡] - [å€‹æ€§ç‰¹è‰²] - [èƒŒæ™¯] - [èªªè©±é¢¨æ ¼]
è§’è‰²Bï¼š[å§“å] - [å¹´é½¡] - [å€‹æ€§ç‰¹è‰²] - [èƒŒæ™¯] - [èªªè©±é¢¨æ ¼]
...

ç« ç¯€è¦åŠƒï¼š
ç¬¬ä¸€ç« ï¼š[æ¨™é¡Œ] - [ä¸»è¦æƒ…ç¯€] - [é‡é»å°è©±å ´æ™¯]
ç¬¬äºŒç« ï¼š[æ¨™é¡Œ] - [ä¸»è¦æƒ…ç¯€] - [é‡é»å°è©±å ´æ™¯]
...

åªè¼¸å‡ºçµæ§‹è¦åŠƒï¼Œä¸è¦å…·é«”å…§å®¹ã€‚`;

            try {
                console.log('ç”Ÿæˆå°èªªçµæ§‹...');

                // å˜—è©¦ä¸åŒçš„APIé…ç½®ä¾†é¿å…CORSå•é¡Œ
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin,
                        'Referer': window.location.href
                    },
                    body: JSON.stringify({
                        model: "anthropic/claude-3-haiku", // æ”¹ç”¨æ›´ç©©å®šçš„æ¨¡å‹
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.error('å°èªªçµæ§‹ç”Ÿæˆå¤±æ•—:', response.status, response.statusText);
                    throw new Error(`çµæ§‹ç”Ÿæˆå¤±æ•—: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('å°èªªçµæ§‹ç”ŸæˆæˆåŠŸ');
                return data.choices[0].message.content;

            } catch (error) {
                console.error('çµæ§‹ç”ŸæˆAPIéŒ¯èª¤:', error);
                
                // APIå¤±æ•—æ™‚ä½¿ç”¨æ¨¡æ“¬çµæ§‹
                console.log('ä½¿ç”¨æ¨¡æ“¬çµæ§‹...');
                return generateMockNovelStructure(outline, characterCount, ending);
            }
        }

        // æ¨¡æ“¬å°èªªçµæ§‹ç”Ÿæˆ
        function generateMockNovelStructure(outline, characterCount, ending) {
            const mockCharacters = [
                'è‰¾è‰çµ² - 18æ­² - æ´»æ½‘é–‹æœ—ä½†æœ‰äº›è¡å‹• - é«˜ä¸­å­¸ç”Ÿ - èªªè©±ç›´æ¥ï¼Œå–œæ­¡ç”¨æ„Ÿå˜†å¥',
                'é›·æ© - 19æ­² - æ²‰ç©©å…§å‘ä½†æº«æš– - å¤§å­¸æ–°ç”Ÿ - èªªè©±æº«å’Œï¼Œå¸¸ç”¨ç–‘å•å¥æ€è€ƒ',
                'ç¾å’² - 17æ­² - ç¥ç§˜å†·éœä½†å–„è‰¯ - è½‰å­¸ç”Ÿ - èªªè©±ç°¡æ½”ï¼Œå¶çˆ¾è©©æ„',
                'å¤§è¼” - 20æ­² - å¹½é»˜é¢¨è¶£ä½†è²¬ä»»æ„Ÿå¼· - ç¤¾åœ˜å­¸é•· - èªªè©±å¹½é»˜ï¼Œæ„›é–‹ç©ç¬‘',
                'å°æ˜¥ - 16æ­² - å¤©çœŸå–®ç´”ä½†è°æ˜ - å­¸å¦¹ - èªªè©±å¯æ„›ï¼Œå¸¸ç”¨æ“¬è²è©'
            ];

            const selectedCharacters = mockCharacters.slice(0, characterCount);

            const mockStructure = `è§’è‰²è¨­å®šï¼š
${selectedCharacters.join('\n')}

ç« ç¯€è¦åŠƒï¼š
ç¬¬ä¸€ç« ï¼šç›¸é‡ - ä¸»è¦è§’è‰²åˆæ¬¡è¦‹é¢ï¼Œå»ºç«‹åŸºæœ¬é—œä¿‚ - è‡ªæˆ‘ä»‹ç´¹èˆ‡åˆæ¬¡å°è©±
ç¬¬äºŒç« ï¼šäº†è§£ - è§’è‰²é–“åŠ æ·±èªè­˜ï¼Œæ­ç¤ºèƒŒæ™¯ - æ·±å…¥äº¤æµï¼Œåˆ†äº«éå¾€
ç¬¬ä¸‰ç« ï¼šè¡çª - å‡ºç¾å•é¡Œæˆ–èª¤æœƒï¼Œé—œä¿‚ç·Šå¼µ - çˆ­è«–èˆ‡è§£é‡‹çš„å°è©±
ç¬¬å››ç« ï¼šæˆé•· - è§’è‰²é¢å°å›°é›£ï¼Œé–‹å§‹æ”¹è®Š - å…§å¿ƒç¨ç™½èˆ‡ç›¸äº’é¼“å‹µ
ç¬¬äº”ç« ï¼š${ending === 'happy' ? 'å’Œè§£' : ending === 'twist' ? 'è½‰æŠ˜' : 'çµå±€'} - æ•…äº‹èµ°å‘çµå±€ï¼Œè§£æ±ºå•é¡Œ - æœ€çµ‚çš„é‡è¦å°è©±

å¤§ç¶±èå…¥ï¼š${outline}`;

            return mockStructure;
        }

        // ç”Ÿæˆç« ç¯€å…§å®¹ï¼ˆä¿®å¾©CORSå•é¡Œï¼‰
        async function generateChapterContent(apiKey, structure, chapterTitle, chapterNumber) {
            const prompt = `æ ¹æ“šå°èªªçµæ§‹ç”Ÿæˆå…·é«”ç« ç¯€å…§å®¹ï¼š

ã€å°èªªçµæ§‹ã€‘
${structure}

ã€ç•¶å‰ç« ç¯€ã€‘
${chapterTitle}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. åŒ…å«è±å¯Œçš„å°è©±äº¤æµï¼ˆ60%ï¼‰
2. è©³ç´°çš„å‹•ä½œå’Œè¡¨æƒ…æè¿°ï¼ˆ25%ï¼‰
3. å ´æ™¯å’Œæ°›åœæè¿°ï¼ˆ15%ï¼‰
4. å­—æ•¸800-1200å­—
5. æ¨é€²åŠ‡æƒ…ç™¼å±•

ã€æ ¼å¼è¦æ±‚ã€‘
- å°è©±ï¼šè§’è‰²åï¼šã€Œå°è©±å…§å®¹ã€
- å‹•ä½œï¼šå‹•ä½œï¼š[è§’è‰²åšäº†ä»€éº¼å‹•ä½œã€è¡¨æƒ…è®ŠåŒ–]
- æ—ç™½ï¼šæ—ç™½ï¼š[å ´æ™¯æè¿°ã€å¿ƒç†æ´»å‹•ã€æ°›åœç‡Ÿé€ ]

è«‹æŒ‰ç…§æ­¤æ ¼å¼ç”Ÿæˆæœ¬ç« ç¯€å®Œæ•´å…§å®¹ã€‚`;

            try {
                console.log(`ç”Ÿæˆç¬¬${chapterNumber}ç« å…§å®¹...`);

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        model: "anthropic/claude-3-haiku",
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1800,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    console.error(`ç¬¬${chapterNumber}ç« ç”Ÿæˆå¤±æ•—:`, response.status);
                    // ç”Ÿæˆæ¨¡æ“¬ç« ç¯€å…§å®¹
                    return generateMockChapterContent(chapterTitle, chapterNumber);
                }

                const data = await response.json();
                const chapterContent = data.choices[0].message.content;

                // è§£æä¸¦æ·»åŠ ç« ç¯€å…§å®¹
                await parseAndAddChapterContent(chapterContent);

            } catch (error) {
                console.error(`ç¬¬${chapterNumber}ç« APIéŒ¯èª¤:`, error);
                // ä½¿ç”¨æ¨¡æ“¬å…§å®¹
                const mockContent = generateMockChapterContent(chapterTitle, chapterNumber);
                await parseAndAddChapterContent(mockContent);
            }
        }

        // ç”Ÿæˆæ¨¡æ“¬ç« ç¯€å…§å®¹
        function generateMockChapterContent(chapterTitle, chapterNumber) {
            const mockContents = {
                1: `æ—ç™½ï¼šé™½å…‰é€éæ•™å®¤çš„çª—æˆ¶ç‘é€²ä¾†ï¼Œæ–°çš„ä¸€å¤©é–‹å§‹äº†ã€‚
è‰¾è‰çµ²ï¼šã€Œä»Šå¤©ä¼¼ä¹æœƒæ˜¯å€‹ç‰¹åˆ¥çš„æ—¥å­å‘¢ï¼ã€
å‹•ä½œï¼šè‰¾è‰çµ²èˆˆå¥®åœ°çœ‹å‘çª—å¤–ï¼Œçœ¼ä¸­é–ƒçˆè‘—æœŸå¾…çš„å…‰èŠ’ã€‚
é›·æ©ï¼šã€Œä½ æ€éº¼é€™éº¼æ¨‚è§€ï¼Ÿã€
å‹•ä½œï¼šé›·æ©æº«å’Œåœ°ç¬‘äº†ç¬‘ï¼Œæ•´ç†è‘—æ¡Œä¸Šçš„æ›¸æœ¬ã€‚
æ—ç™½ï¼šæ•™å®¤è£¡ç€°æ¼«è‘—é’æ˜¥çš„æ°£æ¯ï¼Œæ–°çš„æ•…äº‹å³å°‡é–‹å§‹ã€‚`,
                
                2: `æ—ç™½ï¼šåˆå¾Œçš„å’–å•¡å»³è£¡ï¼Œå…©äººé¢å°é¢åè‘—ï¼Œæ°£æ°›æœ‰äº›å¾®å¦™ã€‚
è‰¾è‰çµ²ï¼šã€Œæˆ‘æƒ³æ›´äº†è§£ä½ ã€‚ã€
å‹•ä½œï¼šè‰¾è‰çµ²èªçœŸåœ°å‡è¦–è‘—é›·æ©ï¼Œæ‰‹è¼•è¼•æ¡è‘—å’–å•¡æ¯ã€‚
é›·æ©ï¼šã€Œå…¶å¯¦æˆ‘ä¹Ÿæ˜¯é€™éº¼æƒ³çš„ã€‚ã€
å‹•ä½œï¼šé›·æ©ç•¥å¾®è‡‰ç´…ï¼Œè¦–ç·šç§»å‘æ¡Œé¢ï¼Œç„¶å¾ŒåˆæŠ¬èµ·é ­çœ‹å‘è‰¾è‰çµ²ã€‚
æ—ç™½ï¼šçœŸèª çš„è©±èªåœ¨å…©äººä¹‹é–“æµæ·Œï¼Œè·é›¢æ…¢æ…¢æ‹‰è¿‘ã€‚`,
                
                3: `æ—ç™½ï¼šé›¨å¤©çš„èµ°å»Šä¸Šï¼Œæ°£æ°›è®Šå¾—ç·Šå¼µèµ·ä¾†ã€‚
è‰¾è‰çµ²ï¼šã€Œç‚ºä»€éº¼ä½ è¦é€™æ¨£åšï¼Ÿã€
å‹•ä½œï¼šè‰¾è‰çµ²çš„è²éŸ³ä¸­å¸¶è‘—å¤±æœ›ï¼Œé›™æ‰‹ç·Šæ¡æˆæ‹³ã€‚
é›·æ©ï¼šã€Œæˆ‘æœ‰æˆ‘çš„ç†ç”±...ã€
å‹•ä½œï¼šé›·æ©ä½ä¸‹é ­ï¼Œè¡¨æƒ…ç—›è‹¦ï¼Œä¼¼ä¹åœ¨èˆ‡å…§å¿ƒæ™æ‰ã€‚
æ—ç™½ï¼šèª¤æœƒåƒçƒé›²ä¸€æ¨£ç± ç½©è‘—å…©äººï¼Œéœ€è¦é™½å…‰ä¾†é©…æ•£ã€‚`
            };

            return mockContents[chapterNumber] || mockContents[1];
        }

        // ç”Ÿæˆç« ç¯€å…§å®¹ï¼ˆæ”¹é€²ç‰ˆï¼ŒåŒ…å«å‹•ä½œæè¿°ï¼‰
        async function generateChapterContent(apiKey, structure, chapterTitle, chapterNumber) {
            const prompt = `æ ¹æ“šå°èªªçµæ§‹ç”Ÿæˆå…·é«”ç« ç¯€å…§å®¹ï¼š

ã€å°èªªçµæ§‹ã€‘
${structure}

ã€ç•¶å‰ç« ç¯€ã€‘
${chapterTitle}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. åŒ…å«è±å¯Œçš„å°è©±äº¤æµï¼ˆ60%ï¼‰
2. è©³ç´°çš„å‹•ä½œå’Œè¡¨æƒ…æè¿°ï¼ˆ25%ï¼‰
3. å ´æ™¯å’Œæ°›åœæè¿°ï¼ˆ15%ï¼‰
4. å­—æ•¸1200-1800å­—
5. æ¨é€²åŠ‡æƒ…ç™¼å±•

ã€æ ¼å¼è¦æ±‚ã€‘
- å°è©±ï¼šè§’è‰²åï¼šã€Œå°è©±å…§å®¹ã€
- å‹•ä½œï¼šå‹•ä½œï¼š[è§’è‰²åšäº†ä»€éº¼å‹•ä½œã€è¡¨æƒ…è®ŠåŒ–]
- æ—ç™½ï¼šæ—ç™½ï¼š[å ´æ™¯æè¿°ã€å¿ƒç†æ´»å‹•ã€æ°›åœç‡Ÿé€ ]

ã€ç¯„ä¾‹æ ¼å¼ã€‘
æ—ç™½ï¼šé™½å…‰é€éå’–å•¡å»³çš„ç»ç’ƒçª—ç‘é€²ä¾†ï¼Œåœ¨æœ¨è³ªæ¡Œé¢ä¸Šå½¢æˆæ–‘é§çš„å…‰å½±ã€‚
è‰¾è‰çµ²ï¼šã€Œä½ è¦ºå¾—é€™å€‹æè­°æ€éº¼æ¨£ï¼Ÿã€
å‹•ä½œï¼šè‰¾è‰çµ²ç·Šå¼µåœ°å’¬è‘—ä¸‹å”‡ï¼Œæ‰‹æŒ‡è¼•æ•²è‘—æ¡Œé¢ï¼Œç­‰å¾…è‘—å›ç­”ã€‚
é›·æ©ï¼šã€Œæˆ‘éœ€è¦ä»”ç´°è€ƒæ…®ä¸€ä¸‹ã€‚ã€
å‹•ä½œï¼šé›·æ©çšºèµ·çœ‰é ­ï¼Œè¦–ç·šç§»å‘çª—å¤–ï¼Œé™·å…¥äº†æ²‰æ€ã€‚

è«‹æŒ‰ç…§æ­¤æ ¼å¼ç”Ÿæˆæœ¬ç« ç¯€å®Œæ•´å…§å®¹ã€‚`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-haiku",
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 2000,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                console.error(`ç¬¬${chapterNumber}ç« ç”Ÿæˆå¤±æ•—`);
                return;
            }

            const data = await response.json();
            const chapterContent = data.choices[0].message.content;

            // è§£æä¸¦æ·»åŠ ç« ç¯€å…§å®¹
            await parseAndAddChapterContent(chapterContent);
        }

        // è§£æç« ç¯€å…§å®¹ï¼ˆæ”¹é€²ç‰ˆï¼Œæ”¯æ´å‹•ä½œæè¿°ï¼‰
        async function parseAndAddChapterContent(content) {
            const lines = content.split('\n').filter(line => line.trim());

            for (const line of lines) {
                if (line.startsWith('æ—ç™½ï¼š')) {
                    // æ—ç™½/å ´æ™¯æè¿°
                    const narratorContent = line.replace('æ—ç™½ï¼š', '').trim();
                    const narrator = {
                        type: 'narrator',
                        content: narratorContent,
                        timestamp: new Date(),
                        generated: true,
                        novelGenerated: true
                    };
                    dialogues.push(narrator);
                    displayNarrator(narrator);
                    
                } else if (line.startsWith('å‹•ä½œï¼š')) {
                    // å‹•ä½œæè¿°
                    const actionContent = line.replace('å‹•ä½œï¼š', '').trim();
                    const action = {
                        type: 'narrator',
                        content: `ã€”${actionContent}ã€•`, // ç”¨ç‰¹æ®Šç¬¦è™Ÿæ¨™è¨˜å‹•ä½œ
                        timestamp: new Date(),
                        generated: true,
                        isAction: true,
                        novelGenerated: true
                    };
                    dialogues.push(action);
                    displayActionDescription(action);
                    
                } else {
                    // å°è©±å…§å®¹
                    const match = line.match(/^(.+?)ï¼š[ã€Œã€](.+)[ã€ã€]$/);
                    if (match) {
                        const speakerName = match[1].trim();
                        const dialogueContent = match[2].trim();
                        
                        const dialogue = {
                            type: 'dialogue',
                            speaker: speakerName,
                            speakerId: 'novel_' + speakerName,
                            content: dialogueContent,
                            timestamp: new Date(),
                            generated: true,
                            novelGenerated: true
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                    }
                }
                
                // å»¶é²æ•ˆæœ
                await new Promise(resolve => setTimeout(resolve, 600));
            }
        }

        // é¡¯ç¤ºå‹•ä½œæè¿°
        function displayActionDescription(action) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message narrator';
            messageDiv.style.cssText += `
                font-style: italic;
                color: #666;
                border-left: 4px solid #ffc107;
                background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            `;
            messageDiv.innerHTML = action.content;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ç”Ÿæˆå°èªªçµæ§‹
        async function generateNovelStructure(apiKey, outline, length, ending, characterCount) {
            const endingDescriptions = {
                happy: 'åœ“æ»¿çš„çµå±€ï¼Œæ‰€æœ‰å•é¡Œå¾—åˆ°è§£æ±º',
                open: 'é–‹æ”¾å¼çµå±€ï¼Œç•™çµ¦è®€è€…æƒ³åƒç©ºé–“',
                twist: 'æ„å¤–çš„è½‰æŠ˜ï¼Œé¡›è¦†è®€è€…é æœŸ',
                emotional: 'æ„Ÿäººçš„çµå±€ï¼Œè§¸å‹•äººå¿ƒ',
                cliffhanger: 'æ‡¸å¿µçµå±€ï¼Œç‚ºçºŒé›†é‹ªè·¯'
            };

            const prompt = `ä½ æ˜¯å°ˆæ¥­å°èªªç·¨åŠ‡ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚è¨­è¨ˆå°èªªçµæ§‹ï¼š

å¤§ç¶±ï¼š${outline}
ç›®æ¨™å­—æ•¸ï¼š${length}å­—
çµå°¾é¢¨æ ¼ï¼š${endingDescriptions[ending]}
ä¸»è¦è§’è‰²æ•¸ï¼š${characterCount}å€‹

è«‹ç”Ÿæˆå°èªªçµæ§‹ï¼ŒåŒ…å«ï¼š
1. è§’è‰²è¨­å®šï¼ˆ${characterCount}å€‹ä¸»è¦è§’è‰²çš„å§“åã€å€‹æ€§ã€èƒŒæ™¯ï¼‰
2. ç« ç¯€è¦åŠƒï¼ˆå»ºè­°åˆ†æˆ5-8å€‹ç« ç¯€ï¼‰
3. æ¯ç« é‡é»æƒ…ç¯€
4. å°è©±é‡é»åˆ†é…

æ ¼å¼ï¼š
è§’è‰²è¨­å®šï¼š
Aè§’è‰²ï¼š[å§“å] - [å€‹æ€§] - [èƒŒæ™¯]
Bè§’è‰²ï¼š[å§“å] - [å€‹æ€§] - [èƒŒæ™¯]
...

ç« ç¯€è¦åŠƒï¼š
ç¬¬ä¸€ç« ï¼š[æ¨™é¡Œ] - [é‡é»æƒ…ç¯€]
ç¬¬äºŒç« ï¼š[æ¨™é¡Œ] - [é‡é»æƒ…ç¯€]
...

åªè¼¸å‡ºçµæ§‹ï¼Œä¸è¦å…·é«”å°è©±å…§å®¹ã€‚`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-sonnet", // ç”¨æ›´å¼·çš„æ¨¡å‹ç”Ÿæˆçµæ§‹
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`çµæ§‹ç”Ÿæˆå¤±æ•—: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // æ ¹æ“šçµæ§‹ç”Ÿæˆå…·é«”ç« ç¯€
        async function generateNovelSections(apiKey, structure) {
            const chapters = structure.match(/ç¬¬.+ç« ï¼š.+/g) || [];
            
            showSecurityTip(`ğŸ“š é–‹å§‹ç”Ÿæˆ ${chapters.length} å€‹ç« ç¯€...`);

            for (let i = 0; i < chapters.length; i++) {
                const chapterTitle = chapters[i];
                
                showSecurityTip(`ğŸ“ æ­£åœ¨ç”Ÿæˆç¬¬ ${i + 1} ç« ...`);
                
                // ç”Ÿæˆç« ç¯€æ¨™é¡Œæ—ç™½
                const titleNarrator = {
                    type: 'narrator',
                    content: `=== ${chapterTitle} ===`,
                    timestamp: new Date(),
                    generated: true,
                    isChapterTitle: true
                };
                dialogues.push(titleNarrator);
                displayNarrator(titleNarrator);

                // ç”Ÿæˆè©²ç« ç¯€çš„å°è©±å’Œæ—ç™½
                await generateChapterContent(apiKey, structure, chapterTitle, i + 1);
                
                // æ·»åŠ ç« ç¯€é–“éš”
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // ç”Ÿæˆç« ç¯€å…§å®¹
        async function generateChapterContent(apiKey, structure, chapterTitle, chapterNumber) {
            const prompt = `æ ¹æ“šä»¥ä¸‹å°èªªçµæ§‹ï¼Œç”Ÿæˆå…·é«”çš„ç« ç¯€å…§å®¹ï¼š

å°èªªçµæ§‹ï¼š
${structure}

ç•¶å‰ç« ç¯€ï¼š${chapterTitle}

è«‹ç”Ÿæˆé€™å€‹ç« ç¯€çš„å…·é«”å…§å®¹ï¼ŒåŒ…å«ï¼š
1. 3-5æ®µå°è©±ï¼ˆè§’è‰²åï¼šå°è©±å…§å®¹ï¼‰
2. 2-3æ®µæ—ç™½æè¿°ï¼ˆå ´æ™¯ã€æƒ…æ„Ÿã€å‹•ä½œç­‰ï¼‰
3. å…§å®¹è¦æ¨é€²åŠ‡æƒ…ï¼Œç¬¦åˆç« ç¯€ä¸»é¡Œ
4. å°è©±è¦ç¬¦åˆè§’è‰²å€‹æ€§
5. ç¸½å­—æ•¸æ§åˆ¶åœ¨800-1200å­—

æ ¼å¼ï¼š
æ—ç™½ï¼š[å ´æ™¯æè¿°]
è§’è‰²åï¼š[å°è©±å…§å®¹]
æ—ç™½ï¼š[æƒ…ç¯€æè¿°]
è§’è‰²åï¼š[å°è©±å…§å®¹]
...

ç›´æ¥è¼¸å‡ºå…§å®¹ï¼Œä¸è¦å…¶ä»–èªªæ˜ã€‚`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-haiku",
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 1500,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                console.error(`ç¬¬${chapterNumber}ç« ç”Ÿæˆå¤±æ•—`);
                return;
            }

            const data = await response.json();
            const chapterContent = data.choices[0].message.content;

            // è§£æä¸¦æ·»åŠ ç« ç¯€å…§å®¹
            await parseAndAddChapterContent(chapterContent);
        }

        // è§£æç« ç¯€å…§å®¹
        async function parseAndAddChapterContent(content) {
            const lines = content.split('\n').filter(line => line.trim());

            for (const line of lines) {
                if (line.startsWith('æ—ç™½ï¼š')) {
                    const narratorContent = line.replace('æ—ç™½ï¼š', '').trim();
                    const narrator = {
                        type: 'narrator',
                        content: narratorContent,
                        timestamp: new Date(),
                        generated: true,
                        novelGenerated: true
                    };
                    dialogues.push(narrator);
                    displayNarrator(narrator);
                    
                } else {
                    const match = line.match(/^(.+?)ï¼š(.+)$/);
                    if (match) {
                        const speakerName = match[1].trim();
                        const dialogueContent = match[2].trim();
                        
                        const dialogue = {
                            type: 'dialogue',
                            speaker: speakerName,
                            speakerId: 'novel_' + speakerName, // å°èªªç”Ÿæˆçš„è§’è‰²ID
                            content: dialogueContent,
                            timestamp: new Date(),
                            generated: true,
                            novelGenerated: true
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                    }
                }
                
                // æ·»åŠ å»¶é²æ•ˆæœ
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // éš±è—å°èªªç”Ÿæˆé¢æ¿
        function hideNovelGeneration() {
            document.getElementById('novel-generation').style.display = 'none';
        }

        // é–‹å§‹AIç”Ÿæˆï¼ˆæ¥å…¥OpenRouter APIï¼‰
        async function startAIGeneration() {
            const apiKey = getAPIKey();
            const context = document.getElementById('scene-context').value;
            const style = document.getElementById('dialogue-style').value;
            const count = parseInt(document.getElementById('generation-count').value) || 2;
            
            // ç²å–é¸ä¸­çš„è§’è‰²
            const checkboxes = document.querySelectorAll('#character-checkboxes input[type="checkbox"]:checked');
            const selectedCharacters = Array.from(checkboxes).map(cb => {
                const charId = cb.value;
                return characters.find(c => c.id == charId);
            }).filter(Boolean);

            if (selectedCharacters.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡1å€‹è§’è‰²é€²è¡Œå°è©±ï¼');
                return;
            }

            // æª¢æŸ¥API Key
            if (!apiKey) {
                alert('è«‹å…ˆè¼¸å…¥OpenRouter API Keyï¼\n\næ²’æœ‰API Keyå°‡ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆã€‚');
                // ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆ
                return await simulateAIGeneration(selectedCharacters, context, style);
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ğŸ¤– AIæ€è€ƒä¸­...';
            btn.disabled = true;

            try {
                console.log('ä½¿ç”¨OpenRouter APIç”Ÿæˆå°è©±...');
                await generateWithOpenRouter(apiKey, selectedCharacters, context, style, count);
                hideAIControls();
                showSecurityTip('ğŸ¤– OpenRouter AIå°è©±ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('OpenRouter APIéŒ¯èª¤:', error);
                console.log('APIå¤±æ•—ï¼Œæ”¹ç”¨æ¨¡æ“¬ç”Ÿæˆ...');
                
                // APIå¤±æ•—æ™‚ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆ
                await simulateAIGeneration(selectedCharacters, context, style);
                hideAIControls();
                showSecurityTip('ğŸ¤– APIå¤±æ•—ï¼Œå·²æ”¹ç”¨æ¨¡æ“¬ç”Ÿæˆ');
                
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ä½¿ç”¨OpenRouter APIç”Ÿæˆå°è©±ï¼ˆæ”¹é€²ç‰ˆï¼‰
        async function generateWithOpenRouter(apiKey, characters, context, style, count) {
            // å»ºæ§‹è§’è‰²æè¿°
            const characterDescriptions = characters.map(char => 
                `${char.name}ï¼šå€‹æ€§${char.personality}ï¼Œèªªè©±èªæ°£${char.tone}ï¼Œè¡Œç‚ºç‰¹è‰²${char.behavior}`
            ).join('\n');

            // ç²å–æœ€è¿‘çš„å°è©±æ­·å²ä¸¦åˆ†æ
            const recentDialogues = dialogues.slice(-3).map(d => {
                if (d.type === 'dialogue') {
                    return `${d.speaker}ï¼š${d.content}`;
                } else if (d.type === 'narrator') {
                    return `(å ´æ™¯ï¼š${d.content})`;
                }
                return '';
            }).filter(Boolean);

            // åˆ†ææœ€å¾Œä¸€å¥è©±ï¼Œåˆ¤æ–·éœ€è¦ä»€éº¼æ¨£çš„å›æ‡‰
            const lastDialogue = dialogues.length > 0 ? dialogues[dialogues.length - 1] : null;
            let contextHint = '';
            
            if (lastDialogue && lastDialogue.type === 'dialogue') {
                if (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?')) {
                    contextHint = '(å‰é¢æœ‰å•é¡Œéœ€è¦å›ç­”)';
                } else if (lastDialogue.content.includes('ã€‚') || lastDialogue.content.includes('ï¼')) {
                    contextHint = '(éœ€è¦å°å‰é¢çš„è©±åšå‡ºå›æ‡‰æˆ–å»¶çºŒè©±é¡Œ)';
                }
            }

            // é¢¨æ ¼èªªæ˜
            const styleDescriptions = {
                natural: 'è‡ªç„¶æ—¥å¸¸çš„å°è©±ï¼Œåƒæœ‹å‹é–“çš„è¼•é¬†èŠå¤©',
                dramatic: 'æˆ²åŠ‡åŒ–ã€å……æ»¿æƒ…æ„Ÿå’Œå¼µåŠ›çš„å°è©±',
                romantic: 'æº«é¦¨æµªæ¼«ã€å……æ»¿æ„Ÿæƒ…çš„å°è©±',
                humorous: 'è¼•é¬†å¹½é»˜ã€æ´»æ½‘æœ‰è¶£çš„å°è©±',
                tense: 'ç·Šå¼µåš´è‚…ã€å……æ»¿å£“åŠ›çš„å°è©±'
            };

            const prompt = `ä½ æ˜¯å°ˆæ¥­ç·¨åŠ‡ï¼Œè«‹ç”Ÿæˆç¬¦åˆè¦æ±‚çš„å°è©±ï¼š

== è§’è‰²è¨­å®š ==
${characterDescriptions}

== å°è©±æƒ…å¢ƒ ==
å ´æ™¯ï¼š${context || 'æ—¥å¸¸å ´æ™¯'}
é¢¨æ ¼ï¼š${styleDescriptions[style] || 'è‡ªç„¶å°è©±'}
${contextHint}

== æœ€è¿‘å°è©± ==
${recentDialogues.length > 0 ? recentDialogues.join('\n') : '(å°è©±é–‹å§‹)'}

== ç”Ÿæˆè¦æ±‚ ==
1. ç”Ÿæˆ${count}å¥é€£è²«çš„å°è©±
2. æ¯å¥éƒ½è¦ç¬¦åˆè§’è‰²å€‹æ€§
3. è¦å»¶çºŒå‰é¢çš„è©±é¡Œæˆ–åˆç†è½‰æ›
4. å¦‚æœå‰é¢æœ‰å•é¡Œè¦å›ç­”ï¼Œå¦‚æœæ˜¯é™³è¿°è¦å›æ‡‰
5. é¿å…é‡è¤‡å·²èªªéçš„å…§å®¹
6. å°è©±è¦è‡ªç„¶æµæš¢ï¼ŒåƒçœŸäººèŠå¤©

== è¼¸å‡ºæ ¼å¼ ==
è§’è‰²åï¼šå°è©±å…§å®¹
è§’è‰²åï¼šå°è©±å…§å®¹
(åªè¼¸å‡ºå°è©±ï¼Œä¸è¦å…¶ä»–èªªæ˜)`;

            try {
                console.log('ç™¼é€æ”¹é€²ç‰ˆAPIè«‹æ±‚...');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                    },
                    body: JSON.stringify({
                        model: "anthropic/claude-3-haiku", // æ”¹ç”¨æ›´å¿«æ›´ä¾¿å®œçš„æ¨¡å‹
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 800,
                        temperature: 0.9, // æé«˜å‰µæ„æ€§
                        top_p: 0.95,
                        stream: false
                    })
                });

                console.log('APIå›æ‡‰ç‹€æ…‹:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIéŒ¯èª¤:', errorText);
                    throw new Error(`APIè«‹æ±‚å¤±æ•— (${response.status})`);
                }

                const data = await response.json();
                console.log('APIæˆåŠŸå›æ‡‰');
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIå›æ‡‰æ ¼å¼éŒ¯èª¤');
                }

                const generatedText = data.choices[0].message.content;
                console.log('ç”Ÿæˆå…§å®¹:', generatedText);

                // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å°è©±
                await parseAndAddGeneratedDialogue(generatedText, characters);

            } catch (error) {
                console.error('APIè«‹æ±‚å®Œå…¨å¤±æ•—:', error.message);
                throw error;
            }
        }

        // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å°è©±ï¼ˆæ”¹é€²ç‰ˆï¼‰
        async function parseAndAddGeneratedDialogue(text, availableCharacters) {
            const lines = text.split('\n').filter(line => line.trim());
            console.log('è§£æå°è©±è¡Œæ•¸:', lines.length);
            
            for (const line of lines) {
                // åŒ¹é…æ ¼å¼ï¼šè§’è‰²åç¨±ï¼šå°è©±å…§å®¹
                const match = line.match(/^(.+?)ï¼š(.+)$/);
                if (match) {
                    const speakerName = match[1].trim();
                    const content = match[2].trim();
                    
                    console.log('è§£æåˆ°å°è©± -', 'è§’è‰²:', speakerName, 'å…§å®¹:', content);
                    
                    // å°‹æ‰¾å°æ‡‰çš„è§’è‰²
                    const character = availableCharacters.find(char => 
                        char.name === speakerName || 
                        char.name.includes(speakerName) || 
                        speakerName.includes(char.name)
                    );
                    
                    if (character) {
                        // æ›´æ–°è§’è‰²è¨˜æ†¶
                        updateCharacterMemory(character.id, content, 'OpenRouterç”Ÿæˆ');
                        
                        const dialogue = {
                            type: 'dialogue',
                            speaker: character.name,
                            speakerId: character.id,
                            content: content,
                            timestamp: new Date(),
                            generated: true,
                            apiGenerated: true // æ¨™è¨˜ç‚ºçœŸå¯¦APIç”Ÿæˆ
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                        
                        console.log('å°è©±å·²æ·»åŠ :', dialogue);
                        
                        // æ·»åŠ å»¶é²è®“å°è©±é€ä¸€å‡ºç¾
                        await new Promise(resolve => setTimeout(resolve, 800));
                    } else {
                        console.warn('æ‰¾ä¸åˆ°åŒ¹é…çš„è§’è‰²:', speakerName);
                    }
                } else {
                    console.warn('ç„¡æ³•è§£æçš„å°è©±æ ¼å¼:', line);
                }
            }
        }

        // ä½¿ç”¨OpenRouter APIç”Ÿæˆå°è©±
        async function generateDialogueWithClaude(apiKey, characters, context, style) {
            // ä½¿ç”¨é è¨­çš„Claude 3 Sonnetæ¨¡å‹
            const selectedModel = "anthropic/claude-3-sonnet";
            
            // å»ºæ§‹è§’è‰²æè¿°
            const characterDescriptions = characters.map(char => 
                `${char.name}ï¼šå€‹æ€§${char.personality}ï¼Œèªªè©±èªæ°£${char.tone}ï¼Œè¡Œç‚ºç‰¹è‰²${char.behavior}`
            ).join('\n');

            // ç²å–æœ€è¿‘çš„å°è©±æ­·å²
            const recentDialogues = dialogues.slice(-5).map(d => {
                if (d.type === 'dialogue') {
                    return `${d.speaker}ï¼š${d.content}`;
                } else {
                    return `(${d.content})`;
                }
            }).join('\n');

            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å°è©±ç·¨åŠ‡ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¨­å®šç”Ÿæˆ2-3è¼ªè‡ªç„¶çš„å°è©±ï¼š

è§’è‰²è¨­å®šï¼š
${characterDescriptions}

å°è©±æƒ…å¢ƒï¼š${context || 'æ—¥å¸¸äº’å‹•'}
å°è©±é¢¨æ ¼ï¼š${style}

${recentDialogues ? `æœ€è¿‘å°è©±æ­·å²ï¼š\n${recentDialogues}\n` : ''}

è«‹ç”Ÿæˆç¬¦åˆå„è§’è‰²å€‹æ€§çš„å°è©±ï¼Œæ¯å€‹è§’è‰²è‡³å°‘èªªä¸€å¥è©±ã€‚æ ¼å¼ï¼š
è§’è‰²åç¨±ï¼šå°è©±å…§å®¹

è«‹ç›´æ¥è¼¸å‡ºå°è©±ï¼Œä¸è¦å…¶ä»–èªªæ˜ã€‚`;

            try {
                // ä½¿ç”¨ä»£ç†æœå‹™å™¨ä¾†é¿å…CORSå•é¡Œ
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = 'https://openrouter.ai/api/v1/chat/completions';
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.8,
                        top_p: 0.9,
                        stream: false
                    })
                });

                if (!response.ok) {
                    // å¦‚æœä»£ç†å¤±æ•—ï¼Œå˜—è©¦æ¨¡æ“¬ç”Ÿæˆ
                    console.warn('APIè«‹æ±‚å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆ');
                    return await simulateAIGeneration(characters, context, style);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIå›æ‡‰æ ¼å¼éŒ¯èª¤');
                }

                const generatedText = data.choices[0].message.content;
                console.log('AIç”Ÿæˆå…§å®¹:', generatedText);

                // è§£æç”Ÿæˆçš„å°è©±
                await parseAndAddGeneratedDialogue(generatedText, characters);

            } catch (error) {
                console.error('OpenRouter APIéŒ¯èª¤:', error);
                // ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                console.log('ä½¿ç”¨æ¨¡æ“¬AIç”Ÿæˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ');
                await simulateAIGeneration(characters, context, style);
            }
        }

        // æ”¹é€²çš„æ¨¡æ“¬AIç”Ÿæˆï¼ˆæ›´é€£è²«ï¼‰
        async function simulateAIGeneration(characters, context, style) {
            console.log('ä½¿ç”¨æ”¹é€²ç‰ˆæ¨¡æ“¬ç”Ÿæˆï¼Œè§’è‰²:', characters.map(c => c.name));
            
            // åˆ†æç•¶å‰å°è©±æƒ…å¢ƒ
            const lastDialogue = dialogues.length > 0 ? dialogues[dialogues.length - 1] : null;
            const isQuestion = lastDialogue && lastDialogue.type === 'dialogue' && 
                             (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?'));
            
            // é€£è²«å°è©±ç”Ÿæˆç­–ç•¥
            for (let i = 0; i < Math.min(characters.length, 2); i++) {
                const character = characters[i];
                
                // åˆå§‹åŒ–è§’è‰²è¨˜æ†¶
                initializeCharacterMemory(character.id);
                
                // ç”Ÿæˆé€£è²«çš„å›æ‡‰
                const generatedContent = generateCoherentResponse(character, style, lastDialogue, isQuestion, i);
                
                if (generatedContent) {
                    // æ›´æ–°è§’è‰²è¨˜æ†¶
                    updateCharacterMemory(character.id, generatedContent, `æ¨¡æ“¬ç”Ÿæˆ-${style}`);
                    
                    const dialogue = {
                        type: 'dialogue',
                        speaker: character.name,
                        speakerId: character.id,
                        content: generatedContent,
                        timestamp: new Date(),
                        generated: true,
                        simulated: true
                    };
                    
                    dialogues.push(dialogue);
                    displayDialogue(dialogue);
                    
                    // æ›´æ–°æœ€å¾Œå°è©±å¼•ç”¨
                    lastDialogue = dialogue;
                    
                    // å»¶é²æ•ˆæœ
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            showSecurityTip('ğŸ¤– ä½¿ç”¨æ™ºèƒ½æ¨¡æ“¬ç”Ÿæˆ');
        }

        // ç”Ÿæˆé€£è²«å›æ‡‰
        function generateCoherentResponse(character, style, lastDialogue, isQuestion, order) {
            // é€£è²«å›æ‡‰åº«
            const coherentResponses = {
                è‰¾è‰çµ²: {
                    // å›ç­”å•é¡Œ
                    answer: {
                        natural: ["æˆ‘è¦ºå¾—æ˜¯é€™æ¨£...", "å—¯ï¼Œæ‡‰è©²æ˜¯...", "æˆ‘æƒ³å¯èƒ½æ˜¯...", "æ“šæˆ‘äº†è§£..."],
                        dramatic: ["æ²’éŒ¯ï¼å°±æ˜¯é€™æ¨£ï¼", "æˆ‘å¿…é ˆå‘Šè¨´ä½ çœŸç›¸ï¼", "é€™å€‹å•é¡Œå¾ˆé‡è¦ï¼"],
                        romantic: ["ä½ é€™æ¨£å•è®“æˆ‘å¾ˆé–‹å¿ƒ...", "æˆ‘å¾ˆæ¨‚æ„å‘Šè¨´ä½ ...", "å’Œä½ åˆ†äº«é€™å€‹çœŸå¥½..."],
                        humorous: ["å“ˆå“ˆï¼Œé€™å€‹å•é¡Œæœ‰æ„æ€ï¼", "è®“æˆ‘æƒ³æƒ³...æ‡‰è©²æ˜¯é€™æ¨£...", "ä½ å•å¾—çœŸå¦™ï¼"],
                        tense: ["é€™å€‹å•é¡Œå¾ˆé—œéµ...", "æˆ‘å¿…é ˆä»”ç´°å›ç­”...", "æƒ…æ³å¯èƒ½æ˜¯é€™æ¨£..."]
                    },
                    // å›æ‡‰é™³è¿°
                    respond: {
                        natural: ["ä½ èªªå¾—å°ã€‚", "æˆ‘ä¹Ÿé€™éº¼æƒ³ã€‚", "ç¢ºå¯¦æ˜¯é€™æ¨£ã€‚", "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚"],
                        dramatic: ["å®Œå…¨æ­£ç¢ºï¼", "ä½ èªªåˆ°é‡é»äº†ï¼", "å°±æ˜¯é€™æ¨£ï¼"],
                        romantic: ["ä½ ç¸½æ˜¯é€™éº¼é«”è²¼ã€‚", "å’Œä½ æƒ³æ³•ä¸€è‡´çœŸå¥½ã€‚", "ä½ ç†è§£æˆ‘çš„æ„Ÿå—ã€‚"],
                        humorous: ["å“ˆå“ˆï¼Œæˆ‘å€‘æƒ³åˆ°ä¸€èµ·äº†ï¼", "ä½ èªªå¾—å¤ªå°äº†ï¼", "è‹±é›„æ‰€è¦‹ç•¥åŒï¼"],
                        tense: ["ä½ èªªå¾—æ²’éŒ¯ã€‚", "æƒ…æ³ç¢ºå¯¦å¦‚æ­¤ã€‚", "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ“”æ†‚ã€‚"]
                    },
                    // é–‹å•Ÿæ–°è©±é¡Œ
                    initiate: {
                        natural: ["å°äº†ï¼Œæˆ‘æƒ³åˆ°ä¸€ä»¶äº‹...", "èªªåˆ°é€™å€‹...", "æˆ‘æƒ³å’Œä½ èŠèŠ..."],
                        dramatic: ["æˆ‘æœ‰é‡è¦çš„äº‹è¦èªªï¼", "ä½ ä¸€å®šè¦è½é€™å€‹ï¼"],
                        romantic: ["æˆ‘ä¸€ç›´æƒ³å‘Šè¨´ä½ ...", "æœ‰ä»¶äº‹æƒ³å’Œä½ åˆ†äº«..."],
                        humorous: ["ä½ çŸ¥é“ä¸€ä»¶æœ‰è¶£çš„äº‹å—ï¼Ÿ", "æˆ‘æƒ³åˆ°å€‹å¥½ç©çš„..."],
                        tense: ["æˆ‘å€‘éœ€è¦è«‡è«‡...", "æœ‰ä»¶äº‹è®“æˆ‘æ“”å¿ƒ..."]
                    }
                },
                é›·æ©: {
                    answer: {
                        natural: ["æˆ‘èªç‚º...", "æ ¹æ“šæˆ‘çš„ç¶“é©—...", "æ‡‰è©²æ˜¯é€™æ¨£...", "æˆ‘çš„çœ‹æ³•æ˜¯..."],
                        dramatic: ["äº‹å¯¦æ˜¯é€™æ¨£çš„ã€‚", "æˆ‘å¿…é ˆå‘Šè¨´ä½ ...", "çœŸç›¸åªæœ‰ä¸€å€‹ã€‚"],
                        romantic: ["æˆ‘å¾ˆæ¨‚æ„å›ç­”ã€‚", "èƒ½å’Œä½ è¨è«–é€™å€‹çœŸå¥½...", "ä½ å•å¾—å¾ˆå¥½..."],
                        humorous: ["é€™å€‹å•é¡Œä¸éŒ¯ã€‚", "è®“æˆ‘å¥½å¥½æƒ³æƒ³...", "ä½ ç¸½æ˜¯å•å¾—å¾ˆæœ‰è¶£ã€‚"],
                        tense: ["é€™å¾ˆè¤‡é›œ...", "æˆ‘å€‘éœ€è¦è¬¹æ…è€ƒæ…®...", "æƒ…æ³å¯èƒ½æ˜¯..."]
                    },
                    respond: {
                        natural: ["æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚", "ä½ åˆ†æå¾—å¾ˆå¥½ã€‚", "ç¢ºå¯¦å¦‚æ­¤ã€‚"],
                        dramatic: ["ä½ èªªå¾—å°ï¼Œæˆ‘å€‘å¿…é ˆè¡Œå‹•ã€‚", "æˆ‘å®Œå…¨åŒæ„ã€‚", "é€™æ­£æ˜¯é—œéµã€‚"],
                        romantic: ["ä½ çš„æƒ³æ³•å¾ˆæº«æš–ã€‚", "æˆ‘å¾ˆæ„Ÿæ¿€ä½ çš„åˆ†äº«ã€‚", "å’Œä½ ä¸€è‡´çœŸå¥½ã€‚"],
                        humorous: ["ä½ çš„è§€é»å¾ˆæœ‰è¶£ã€‚", "æˆ‘å–œæ­¡ä½ é€™æ¨£æƒ³ã€‚", "èªªå¾—å¥½ã€‚"],
                        tense: ["ä½ çš„æ“”æ†‚æ˜¯å°çš„ã€‚", "æˆ‘å€‘å¿…é ˆé‡è¦–é€™é»ã€‚", "æƒ…æ³ç¢ºå¯¦åš´é‡ã€‚"]
                    },
                    initiate: {
                        natural: ["æˆ‘æƒ³è¨è«–ä¸€ä¸‹...", "æœ‰ä»¶äº‹æƒ³å’Œä½ è«‡...", "é—œæ–¼..."],
                        dramatic: ["æˆ‘å€‘é¢è‡¨é‡è¦å•é¡Œã€‚", "æœ‰ä»¶äº‹å¿…é ˆå‘Šè¨´ä½ ã€‚"],
                        romantic: ["æˆ‘æƒ³å’Œä½ åˆ†äº«...", "æœ‰å€‹æƒ³æ³•æƒ³èªªçµ¦ä½ è½..."],
                        humorous: ["æƒ³èŠé»è¼•é¬†çš„å—ï¼Ÿ", "æˆ‘æƒ³åˆ°ä»¶æœ‰è¶£çš„äº‹..."],
                        tense: ["æˆ‘å€‘é¢è‡¨å•é¡Œ...", "æœ‰ä»¶äº‹è®“æˆ‘æ“”å¿ƒ..."]
                    }
                }
            };

            // æ±ºå®šå›æ‡‰é¡å‹
            let responseType = 'initiate';
            if (lastDialogue && lastDialogue.type === 'dialogue' && 
                lastDialogue.speakerId !== character.id) {
                if (isQuestion) {
                    responseType = 'answer';
                } else {
                    responseType = 'respond';
                }
            }

            // ç²å–é©åˆçš„å›æ‡‰
            const characterResponses = coherentResponses[character.name] || coherentResponses['è‰¾è‰çµ²'];
            const typeResponses = characterResponses[responseType] || characterResponses['respond'];
            const styleResponses = typeResponses[style] || typeResponses['natural'];

            // éæ¿¾å·²ä½¿ç”¨çš„å›æ‡‰
            const availableResponses = styleResponses.filter(response => 
                !hasCharacterSaidSimilar(character.id, response)
            );

            if (availableResponses.length === 0) {
                // å‚™ç”¨å›æ‡‰
                const fallbacks = ["æˆ‘æ˜ç™½ã€‚", "æ˜¯é€™æ¨£å•Šã€‚", "æˆ‘æƒ³ä¹Ÿæ˜¯ã€‚"];
                return fallbacks[order % fallbacks.length];
            }

            return availableResponses[order % availableResponses.length];
        }

        // ç°¡åŒ–çš„å°è©±ç”Ÿæˆ
        function generateSimpleResponse(character, style, lastDialogue, order) {
            // åŸºç¤å°è©±åº«
            const dialogueBank = {
                è‰¾è‰çµ²: {
                    natural: [
                        "æˆ‘è¦ºå¾—é€™å€‹æƒ³æ³•ä¸éŒ¯ã€‚",
                        "ä½ èªªå¾—å°å‘¢ï¼",
                        "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ„Ÿè¦ºã€‚",
                        "é€™æ¨£æƒ³å¾ˆæœ‰æ„æ€ã€‚",
                        "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚",
                        "ç¢ºå¯¦æ˜¯é€™æ¨£çš„ã€‚",
                        "æˆ‘å€‘æƒ³åˆ°ä¸€èµ·å»äº†ã€‚",
                        "é€™å€‹è§€é»å¾ˆæ£’ã€‚"
                    ],
                    dramatic: [
                        "é€™çœŸçš„å¤ªé©šäººäº†ï¼",
                        "æˆ‘å®Œå…¨æ²’æƒ³åˆ°æœƒé€™æ¨£ï¼",
                        "é€™æ”¹è®Šäº†ä¸€åˆ‡ï¼",
                        "å¤ªä¸å¯æ€è­°äº†ï¼",
                        "æˆ‘å€‘å¿…é ˆè¡Œå‹•èµ·ä¾†ï¼",
                        "é€™æ˜¯é—œéµæ™‚åˆ»ï¼",
                        "æƒ…æ³æ¯”æƒ³åƒçš„åš´é‡ï¼",
                        "æˆ‘å€‘ä¸èƒ½è¢–æ‰‹æ—è§€ï¼"
                    ],
                    romantic: [
                        "å’Œä½ èŠå¤©çœŸçš„å¾ˆé–‹å¿ƒã€‚",
                        "ä½ ç¸½æ˜¯é€™éº¼é«”è²¼ã€‚",
                        "é€™ç¨®æ„Ÿè¦ºå¾ˆæº«æš–ã€‚",
                        "æœ‰ä½ çœŸå¥½ã€‚",
                        "ä½ çš„è©±è®“æˆ‘å¾ˆæ„Ÿå‹•ã€‚",
                        "å’Œä½ åœ¨ä¸€èµ·å¾ˆèˆ’æœã€‚",
                        "ä½ ç†è§£æˆ‘çš„æƒ³æ³•ã€‚",
                        "è¬è¬ä½ çš„é™ªä¼´ã€‚"
                    ],
                    humorous: [
                        "å“ˆå“ˆï¼Œä½ çœŸå¹½é»˜ï¼",
                        "é€™å€‹æƒ³æ³•å¤ªæœ‰è¶£äº†ï¼",
                        "æˆ‘éƒ½è¦ç¬‘æ­»äº†ï¼",
                        "ä½ ç¸½æ˜¯é€™éº¼æç¬‘ã€‚",
                        "ç”Ÿæ´»å°±è¦é€™æ¨£è¼•é¬†ï¼",
                        "ä½ çš„ç¬‘è©±çœŸæ£’ï¼",
                        "æˆ‘å€‘çœŸæœƒè‡ªå¨›è‡ªæ¨‚ã€‚",
                        "å¤ªå¥½ç©äº†ï¼"
                    ],
                    tense: [
                        "æƒ…æ³æœ‰äº›è¤‡é›œã€‚",
                        "æˆ‘å€‘å¾—å°å¿ƒè™•ç†ã€‚",
                        "é€™è®“æˆ‘æœ‰é»æ“”å¿ƒã€‚",
                        "æˆ‘å€‘éœ€è¦æƒ³å€‹è¾¦æ³•ã€‚",
                        "æ™‚é–“å¯èƒ½ä¸å¤šäº†ã€‚",
                        "æƒ…æ³ä¸å¤ªæ¨‚è§€ã€‚",
                        "æˆ‘å€‘å¿…é ˆè¬¹æ…è¡Œäº‹ã€‚",
                        "é€™çœŸè®“äººç·Šå¼µã€‚"
                    ]
                },
                é›·æ©: {
                    natural: [
                        "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚",
                        "é€™ç¢ºå¯¦æ˜¯å€‹å¥½è§€é»ã€‚",
                        "æˆ‘å€‘å¯ä»¥ä»”ç´°è€ƒæ…®ä¸€ä¸‹ã€‚",
                        "ä½ åˆ†æå¾—å¾ˆæœ‰é“ç†ã€‚",
                        "æˆ‘ä¹Ÿæ˜¯é€™æ¨£èªç‚ºçš„ã€‚",
                        "é€™å€‹æƒ³æ³•å€¼å¾—æ·±æ€ã€‚",
                        "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚",
                        "ä½ èªªå¾—å¾ˆä¸­è‚¯ã€‚"
                    ],
                    dramatic: [
                        "æˆ‘æœƒæ‰¿æ“”èµ·è²¬ä»»ã€‚",
                        "æˆ‘å€‘å¿…é ˆå‹‡æ•¢é¢å°ã€‚",
                        "é€™æ˜¯æˆ‘å€‘çš„ä½¿å‘½ã€‚",
                        "æˆ‘ä¸æœƒè®“ä½ å¤±æœ›ã€‚",
                        "è®“æˆ‘ä¾†ä¿è­·å¤§å®¶ã€‚",
                        "æˆ‘å€‘ä¸€èµ·å…‹æœå›°é›£ã€‚",
                        "é€™æ˜¯æ­£ç¢ºçš„é¸æ“‡ã€‚",
                        "æˆ‘å€‘çµ•ä¸èƒ½æ”¾æ£„ã€‚"
                    ],
                    romantic: [
                        "èƒ½å’Œä½ åˆ†äº«é€™äº›çœŸå¥½ã€‚",
                        "ä½ çš„æƒ³æ³•ç¸½æ˜¯å¾ˆæº«æš–ã€‚",
                        "æˆ‘å¾ˆçæƒœé€™æ¨£çš„æ™‚å…‰ã€‚",
                        "å’Œä½ åœ¨ä¸€èµ·å¾ˆå®‰å¿ƒã€‚",
                        "ä½ è®“æˆ‘æ„Ÿåˆ°å¾ˆå¹¸ç¦ã€‚",
                        "é€™ç¨®æ„Ÿè¦ºå¾ˆç¾å¥½ã€‚",
                        "æˆ‘å¾ˆæ„Ÿæ¿€æœ‰ä½ é™ªä¼´ã€‚",
                        "ä½ æ˜¯æˆ‘é‡è¦çš„äººã€‚"
                    ],
                    humorous: [
                        "ä½ çš„å¹½é»˜æ„Ÿå¾ˆä¸éŒ¯ã€‚",
                        "é€™æ¨£æƒ³ç¢ºå¯¦æœ‰è¶£ã€‚",
                        "ä½ ç¸½èƒ½å¸¶ä¾†æ­¡æ¨‚ã€‚",
                        "æˆ‘å€‘åˆ¥å¤ªåš´è‚…äº†ã€‚",
                        "è¼•é¬†ä¸€é»ä¹Ÿå¥½ã€‚",
                        "ä½ èªªå¾—å°ï¼Œè¦æ¨‚è§€ã€‚",
                        "é€™æ¨£æƒ³å¿ƒæƒ…æœƒæ›´å¥½ã€‚",
                        "è¬è¬ä½ è®“æˆ‘é–‹å¿ƒã€‚"
                    ],
                    tense: [
                        "æˆ‘å€‘éœ€è¦å†·éœåˆ†æã€‚",
                        "è®“æˆ‘ä¾†æƒ³æƒ³è¾¦æ³•ã€‚",
                        "æˆ‘å€‘å¿…é ˆä¿æŒç†æ€§ã€‚",
                        "ç›¸ä¿¡æˆ‘ï¼Œæœƒæœ‰è§£æ±ºæ–¹æ¡ˆã€‚",
                        "æˆ‘å€‘ä¸€æ­¥æ­¥ä¾†è™•ç†ã€‚",
                        "å…ˆä¸è¦å¤ªæ“”å¿ƒã€‚",
                        "æˆ‘æœƒæƒ³è¾¦æ³•çš„ã€‚",
                        "æˆ‘å€‘ä¸€èµ·è§£æ±ºé€™å€‹å•é¡Œã€‚"
                    ]
                },
                æ—ç™½è€…: {
                    natural: ["æ™‚å…‰åœ¨å°è©±ä¸­éœéœæµæ·Œã€‚", "æˆ¿é–“è£¡æ°£æ°›æº«é¦¨å’Œè«§ã€‚", "é™½å…‰é€éçª—æˆ¶ç‘é€²ä¾†ã€‚"],
                    dramatic: ["ç©ºæ°£ä¸­ç€°æ¼«è‘—ç·Šå¼µæ°£æ¯ã€‚", "é—œéµæ™‚åˆ»å³å°‡åˆ°ä¾†ã€‚", "æƒ…æ³è®Šå¾—è¶Šä¾†è¶Šç·Šæ€¥ã€‚"],
                    romantic: ["æº«é¦¨çš„æ°£æ°›åŒ…åœè‘—å…©äººã€‚", "ç¾å¥½çš„æ™‚å…‰åœ¨ç¹¼çºŒã€‚", "æ„›æ„åœ¨ç©ºä¸­æµæ·Œã€‚"],
                    humorous: ["æ­¡è²ç¬‘èªå……æ»¿æˆ¿é–“ã€‚", "å¿«æ¨‚çš„æ°£æ°›æ„ŸæŸ“è‘—æ¯å€‹äººã€‚", "è¼•é¬†çš„æ™‚å…‰çœŸç¾å¥½ã€‚"],
                    tense: ["ç·Šå¼µçš„æ°£æ°›è¶Šä¾†è¶Šæ¿ƒã€‚", "å±æ©Ÿæ„Ÿé€æ¼¸åŠ é‡ã€‚", "æ¯å€‹äººéƒ½æ„Ÿåˆ°å£“åŠ›ã€‚"]
                }
            };

            // ç²å–è§’è‰²å°è©±é¸é …
            const characterDialogues = dialogueBank[character.name] || dialogueBank['è‰¾è‰çµ²'];
            const styleDialogues = characterDialogues[style] || characterDialogues['natural'];
            
            // éæ¿¾å·²ä½¿ç”¨çš„å°è©±
            const availableDialogues = styleDialogues.filter(content => 
                !hasCharacterSaidSimilar(character.id, content)
            );

            // å¦‚æœæ²’æœ‰å¯ç”¨å°è©±ï¼Œä½¿ç”¨å‚™ç”¨
            if (availableDialogues.length === 0) {
                const fallbacks = ["æˆ‘æ˜ç™½äº†ã€‚", "æ˜¯é€™æ¨£å•Šã€‚", "æˆ‘æƒ³ä¹Ÿæ˜¯ã€‚", "æœ‰é“ç†ã€‚"];
                return fallbacks[order % fallbacks.length];
            }

            // ç°¡å–®çš„é€£è²«æ€§è™•ç†
            let selectedIndex = order;
            
            // å¦‚æœå‰é¢æœ‰å°è©±ï¼Œå˜—è©¦åšå‡ºç›¸é—œå›æ‡‰
            if (lastDialogue && lastDialogue.type === 'dialogue' && lastDialogue.speakerId !== character.id) {
                // å¦‚æœå‰é¢æ˜¯å•é¡Œï¼Œå„ªå…ˆé¸æ“‡å›ç­”æ€§è³ªçš„å°è©±
                if (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?')) {
                    // å°‹æ‰¾é©åˆå›ç­”çš„å°è©±
                    const answerDialogues = availableDialogues.filter(d => 
                        d.includes('æˆ‘è¦ºå¾—') || d.includes('æˆ‘èªç‚º') || d.includes('ç¢ºå¯¦') || d.includes('æˆ‘åŒæ„')
                    );
                    if (answerDialogues.length > 0) {
                        return answerDialogues[0];
                    }
                }
                
                // å¦‚æœå‰é¢æ˜¯é™³è¿°ï¼Œé¸æ“‡å›æ‡‰æ€§å°è©±
                const responseDialogues = availableDialogues.filter(d => 
                    d.includes('ä½ èªªå¾—å°') || d.includes('æˆ‘ä¹Ÿ') || d.includes('åŒæ„') || d.includes('ç†è§£')
                );
                if (responseDialogues.length > 0) {
                    selectedIndex = 0;
                }
            }

            return availableDialogues[selectedIndex % availableDialogues.length];
        }

        // ç²å–å°è©±æƒ…å¢ƒ
        function getConversationContext() {
            const recentDialogues = dialogues.slice(-5);
            return {
                recentTopics: extractTopics(recentDialogues),
                currentMood: determineMood(recentDialogues),
                participantCount: new Set(recentDialogues.map(d => d.speakerId)).size,
                lastSpeaker: recentDialogues.length > 0 ? recentDialogues[recentDialogues.length - 1].speaker : null
            };
        }

        // æå–å°è©±ä¸»é¡Œ
        function extractTopics(dialogues) {
            const keywords = [];
            dialogues.forEach(d => {
                if (d.type === 'dialogue') {
                    // ç°¡å–®çš„é—œéµè©æå–
                    const words = d.content.match(/[\u4e00-\u9fa5]+/g) || [];
                    keywords.push(...words.filter(w => w.length > 1));
                }
            });
            return [...new Set(keywords)].slice(0, 5);
        }

        // åˆ¤æ–·å°è©±æƒ…ç·’
        function determineMood(dialogues) {
            const emotionalWords = {
                happy: ['é–‹å¿ƒ', 'é«˜èˆˆ', 'å¿«æ¨‚', 'å“ˆå“ˆ', 'å¥½', 'æ£’', 'å¤ªå¥½äº†'],
                sad: ['é›£é', 'å‚·å¿ƒ', 'å¤±æœ›', 'ä¸é–‹å¿ƒ', 'ç³Ÿç³•'],
                angry: ['ç”Ÿæ°£', 'æ†¤æ€’', 'ä¸çˆ½', 'è¨å­'],
                excited: ['èˆˆå¥®', 'æ¿€å‹•', 'å¤ªæ£’äº†', 'ä¸å¯æ€è­°', 'é©šäºº'],
                calm: ['å¹³éœ', 'å®‰éœ', 'ç©©å®š', 'å¥½çš„', 'çŸ¥é“äº†']
            };
            
            const recentContent = dialogues.slice(-3).map(d => d.content).join(' ');
            
            for (let mood in emotionalWords) {
                for (let word of emotionalWords[mood]) {
                    if (recentContent.includes(word)) {
                        return mood;
                    }
                }
            }
            return 'neutral';
        }

        // ç”Ÿæˆå€‹æ€§åŒ–ä¸”é€£è²«çš„å°è©±
        async function generatePersonalizedDialogue(character, style, context, conversationContext, order) {
            // åˆ†æå°è©±é€£è²«æ€§
            const flowAnalysis = analyzeConversationFlow();
            
            // æ ¹æ“šåˆ†æçµæœé¸æ“‡åˆé©çš„å›æ‡‰ç­–ç•¥
            let responseStrategy = determineResponseStrategy(character, flowAnalysis, order);
            
            // ç”Ÿæˆé€£è²«çš„å°è©±å…§å®¹
            return generateCoherentResponse(character, style, context, flowAnalysis, responseStrategy, order);
        }

        // æ±ºå®šå›æ‡‰ç­–ç•¥
        function determineResponseStrategy(character, flowAnalysis, order) {
            // å¦‚æœæœ‰ç›´æ¥å•é¡Œéœ€è¦å›ç­”
            if (flowAnalysis.needsResponse && flowAnalysis.lastSpeaker && 
                flowAnalysis.lastSpeaker.speakerId !== character.id) {
                return 'answer_question';
            }
            
            // å¦‚æœå‰ä¸€å€‹è§’è‰²å‰›èªªå®Œï¼Œéœ€è¦å›æ‡‰
            if (flowAnalysis.lastSpeaker && flowAnalysis.lastSpeaker.speakerId !== character.id) {
                if (flowAnalysis.conversationFlow === 'question_asked') {
                    return 'answer_question';
                } else {
                    return 'respond_to_statement';
                }
            }
            
            // å¦‚æœæ˜¯åŒä¸€å€‹è§’è‰²æ¥çºŒèªªè©±
            if (flowAnalysis.lastSpeaker && flowAnalysis.lastSpeaker.speakerId === character.id) {
                return 'continue_thought';
            }
            
            // å¦‚æœæ˜¯å°è©±é–‹å§‹æˆ–æ–°è©±é¡Œ
            if (order === 0 || !flowAnalysis.lastSpeaker) {
                return 'initiate_topic';
            }
            
            return 'general_response';
        }

        // ç”Ÿæˆé€£è²«çš„å›æ‡‰
        function generateCoherentResponse(character, style, context, flowAnalysis, strategy, order) {
            // é€£è²«å°è©±æ¨¡æ¿ï¼ŒåŸºæ–¼è§’è‰²å€‹æ€§å’Œå›æ‡‰ç­–ç•¥
            const coherentDialogues = {
                è‰¾è‰çµ²: {
                    answer_question: {
                        natural: ["æˆ‘è¦ºå¾—æ˜¯é€™æ¨£çš„...", "å—¯ï¼Œæˆ‘æƒ³æ‡‰è©²æ˜¯...", "æ“šæˆ‘æ‰€çŸ¥...", "æˆ‘çš„çœ‹æ³•æ˜¯..."],
                        dramatic: ["å¤©å“ªï¼é€™å€‹å•é¡Œ...", "é€™çœŸçš„å¾ˆé‡è¦ï¼", "æˆ‘å¿…é ˆå‘Šè¨´ä½ ...", "é€™æ”¹è®Šäº†ä¸€åˆ‡ï¼"],
                        romantic: ["ä½ é€™æ¨£å•è®“æˆ‘æƒ³åˆ°...", "å’Œä½ è¨è«–é€™å€‹çœŸçš„å¾ˆæ£’...", "æˆ‘å¾ˆé«˜èˆˆä½ å•é€™å€‹..."],
                        humorous: ["å“ˆå“ˆï¼Œé€™å€‹å•é¡Œå¾ˆæœ‰è¶£ï¼", "ä½ å•åˆ°é‡é»äº†ï¼", "è®“æˆ‘æƒ³æƒ³...æ‡‰è©²æ˜¯é€™æ¨£..."],
                        tense: ["é€™å€‹å•é¡Œå¾ˆé—œéµ...", "æˆ‘å€‘å¿…é ˆä»”ç´°è€ƒæ…®...", "æƒ…æ³å¯èƒ½æ¯”æˆ‘å€‘æƒ³çš„è¤‡é›œ..."]
                    },
                    respond_to_statement: {
                        natural: ["ä½ èªªå¾—å°ã€‚", "æˆ‘ä¹Ÿæ˜¯é€™éº¼æƒ³çš„ã€‚", "é€™å€‹æƒ³æ³•ä¸éŒ¯ã€‚", "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚"],
                        dramatic: ["å®Œå…¨æ­£ç¢ºï¼", "é€™å°±æ˜¯æˆ‘æƒ³èªªçš„ï¼", "ä½ èªªåˆ°é‡é»äº†ï¼", "æ²’éŒ¯ï¼Œå°±æ˜¯é€™æ¨£ï¼"],
                        romantic: ["ä½ ç¸½æ˜¯é€™éº¼é«”è²¼ã€‚", "å’Œä½ æƒ³æ³•ä¸€è‡´çœŸå¥½ã€‚", "ä½ ç†è§£æˆ‘çš„æ„Ÿå—ã€‚"],
                        humorous: ["å“ˆå“ˆï¼Œæˆ‘å€‘æƒ³åˆ°ä¸€èµ·å»äº†ï¼", "ä½ è®€æ‡‚æˆ‘çš„å¿ƒæ€äº†ï¼", "è‹±é›„æ‰€è¦‹ç•¥åŒï¼"],
                        tense: ["ä½ èªªå¾—æ²’éŒ¯ï¼Œæˆ‘å€‘å¾—å°å¿ƒã€‚", "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ“”æ†‚ã€‚", "æƒ…æ³ç¢ºå¯¦å¦‚ä½ æ‰€èªªã€‚"]
                    },
                    continue_thought: {
                        natural: ["è€Œä¸”æˆ‘é‚„æƒ³è£œå……...", "å°äº†ï¼Œé‚„æœ‰ä¸€é»...", "å¦å¤–...", "æˆ‘æƒ³å†èªª..."],
                        dramatic: ["ä¸åªå¦‚æ­¤ï¼", "é‚„æœ‰æ›´é‡è¦çš„æ˜¯...", "ç­‰ç­‰ï¼Œé‚„æœ‰...", "æˆ‘é‚„æ²’èªªå®Œ..."],
                        romantic: ["é‚„æœ‰...", "æˆ‘æƒ³å†å‘Šè¨´ä½ ...", "å¦å¤–...", "é‚„æƒ³å’Œä½ åˆ†äº«..."],
                        humorous: ["å°äº†å°äº†ï¼", "æˆ‘å·®é»å¿˜äº†...", "é‚„æœ‰ä¸€ä»¶æœ‰è¶£çš„äº‹...", "èªªåˆ°é€™å€‹..."],
                        tense: ["æ›´ç³Ÿçš„æ˜¯...", "é‚„æœ‰ä¸€å€‹å•é¡Œ...", "æˆ‘å€‘é‚„è¦è€ƒæ…®...", "åˆ¥å¿˜äº†..."]
                    },
                    initiate_topic: {
                        natural: ["æˆ‘æƒ³å’Œä½ èŠèŠ...", "ä½ çŸ¥é“å—...", "æˆ‘å‰›æ‰æƒ³åˆ°...", "æœ‰ä»¶äº‹æƒ³å‘Šè¨´ä½ ..."],
                        dramatic: ["æˆ‘æœ‰é‡è¦çš„äº‹è¦èªªï¼", "ä½ ä¸€å®šè¦è½é€™å€‹ï¼", "ç™¼ç”Ÿäº†ä¸å¾—äº†çš„äº‹ï¼"],
                        romantic: ["å’Œä½ åœ¨ä¸€èµ·çœŸå¥½...", "æˆ‘ä¸€ç›´æƒ³å‘Šè¨´ä½ ...", "æœ‰å€‹æƒ³æ³•æƒ³å’Œä½ åˆ†äº«..."],
                        humorous: ["ä½ è½éé€™å€‹ç¬‘è©±å—ï¼Ÿ", "æˆ‘æƒ³åˆ°ä¸€ä»¶æœ‰è¶£çš„äº‹...", "ä¾†èŠé»è¼•é¬†çš„..."],
                        tense: ["æˆ‘å€‘éœ€è¦è«‡è«‡...", "æœ‰å€‹åš´é‡çš„å•é¡Œ...", "æƒ…æ³æœ‰äº›ä¸å°å‹..."]
                    }
                },
                é›·æ©: {
                    answer_question: {
                        natural: ["æˆ‘èªç‚º...", "æ ¹æ“šæˆ‘çš„ç¶“é©—...", "é€™å€‹å•é¡Œ...", "è®“æˆ‘æƒ³æƒ³..."],
                        dramatic: ["é€™æ˜¯å€‹é‡è¦çš„å•é¡Œã€‚", "æˆ‘å¿…é ˆèª å¯¦åœ°èªª...", "äº‹å¯¦æ˜¯...", "æˆ‘å€‘å¿…é ˆé¢å°ç¾å¯¦..."],
                        romantic: ["æˆ‘å¾ˆæ¨‚æ„å›ç­”ä½ ã€‚", "é€™è®“æˆ‘æƒ³åˆ°æˆ‘å€‘...", "ä½ å•å¾—å¾ˆå¥½..."],
                        humorous: ["é€™å€‹å•é¡Œæœ‰æ„æ€ã€‚", "è®“æˆ‘å¥½å¥½æƒ³æƒ³...", "ä½ çœŸæœƒå•å•é¡Œã€‚"],
                        tense: ["é€™å€‹å•é¡Œå¾ˆè¤‡é›œ...", "æˆ‘å€‘éœ€è¦è¬¹æ…è€ƒæ…®...", "æƒ…æ³å¯èƒ½æ˜¯é€™æ¨£..."]
                    },
                    respond_to_statement: {
                        natural: ["æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚", "ä½ èªªå¾—æœ‰é“ç†ã€‚", "é€™ç¢ºå¯¦æ˜¯å€‹å¥½è§€é»ã€‚"],
                        dramatic: ["ä½ èªªå¾—å°ï¼Œæˆ‘å€‘å¿…é ˆè¡Œå‹•ã€‚", "æˆ‘å®Œå…¨åŒæ„ä½ çš„çœ‹æ³•ã€‚", "é€™æ­£æ˜¯æˆ‘å€‘éœ€è¦çš„ã€‚"],
                        romantic: ["ä½ çš„æƒ³æ³•ç¸½æ˜¯å¾ˆæº«æš–ã€‚", "æˆ‘å¾ˆæ„Ÿæ¿€ä½ çš„åˆ†äº«ã€‚", "å’Œä½ æƒ³æ³•ä¸€è‡´çœŸå¥½ã€‚"],
                        humorous: ["ä½ çš„è§€é»å¾ˆæœ‰è¶£ã€‚", "æˆ‘å–œæ­¡ä½ é€™æ¨£æƒ³ã€‚", "ä½ ç¸½æ˜¯èƒ½å¸¶ä¾†æ–°è¦–è§’ã€‚"],
                        tense: ["ä½ çš„æ“”æ†‚æ˜¯å°çš„ã€‚", "æˆ‘å€‘å¿…é ˆèªçœŸå°å¾…ã€‚", "æƒ…æ³ç¢ºå¯¦å¦‚ä½ æ‰€èªªã€‚"]
                    },
                    continue_thought: {
                        natural: ["æˆ‘æƒ³è£œå……ä¸€é»...", "é‚„æœ‰å°±æ˜¯...", "å¦å¤–...", "æˆ‘è¦ºå¾—é‚„éœ€è¦è€ƒæ…®..."],
                        dramatic: ["æ›´é‡è¦çš„æ˜¯...", "æˆ‘å€‘é‚„å¿…é ˆ...", "ä¸èƒ½å¿˜è¨˜...", "é—œéµåœ¨æ–¼..."],
                        romantic: ["æˆ‘é‚„æƒ³èªª...", "å¦å¤–...", "é‚„æœ‰ä¸€ä»¶äº‹...", "æˆ‘æƒ³å‘Šè¨´ä½ ..."],
                        humorous: ["å°äº†...", "é‚„æœ‰ä¸€é»...", "æˆ‘å·®é»å¿˜äº†...", "èªªåˆ°é€™å€‹..."],
                        tense: ["æˆ‘å€‘é‚„è¦æ³¨æ„...", "åˆ¥å¿˜äº†...", "æ›´é‡è¦çš„æ˜¯...", "æˆ‘æ“”å¿ƒçš„æ˜¯..."]
                    },
                    initiate_topic: {
                        natural: ["æˆ‘æƒ³è¨è«–ä¸€ä¸‹...", "æœ‰ä»¶äº‹æƒ³å’Œä½ è«‡è«‡...", "æˆ‘åœ¨æƒ³...", "é—œæ–¼..."],
                        dramatic: ["æˆ‘å€‘éœ€è¦è«‡è«–ä¸€å€‹é‡è¦å•é¡Œã€‚", "æœ‰ä»¶äº‹æˆ‘å¿…é ˆå‘Šè¨´ä½ ã€‚", "æƒ…æ³ç™¼ç”Ÿäº†è®ŠåŒ–ã€‚"],
                        romantic: ["æˆ‘æƒ³å’Œä½ åˆ†äº«...", "æœ‰å€‹æƒ³æ³•æƒ³å‘Šè¨´ä½ ...", "æˆ‘ä¸€ç›´åœ¨æƒ³æˆ‘å€‘..."],
                        humorous: ["ä½ æƒ³èŠé»ä»€éº¼ï¼Ÿ", "æˆ‘æƒ³åˆ°ä¸€ä»¶äº‹...", "ä¾†è«‡é»æœ‰è¶£çš„..."],
                        tense: ["æˆ‘å€‘é¢è‡¨ä¸€å€‹å•é¡Œ...", "æœ‰ä»¶äº‹è®“æˆ‘æ“”å¿ƒ...", "æˆ‘å€‘éœ€è¦æº–å‚™..."]
                    }
                }
            };

            // ç²å–å°æ‡‰çš„å°è©±æ¨¡æ¿
            const characterDialogues = coherentDialogues[character.name] || coherentDialogues['è‰¾è‰çµ²'];
            const strategyDialogues = characterDialogues[strategy] || characterDialogues['general_response'] || characterDialogues['respond_to_statement'];
            const styleDialogues = strategyDialogues[style] || strategyDialogues['natural'];

            // éæ¿¾å·²ä½¿ç”¨çš„å°è©±
            const availableDialogues = styleDialogues.filter(content => 
                !hasCharacterSaidSimilar(character.id, content)
            );

            if (availableDialogues.length === 0) {
                return generateFallbackResponse(character, style, flowAnalysis);
            }

            // åŸºæ–¼ç•¶å‰è©±é¡Œèª¿æ•´å°è©±
            let selectedDialogue = availableDialogues[order % availableDialogues.length];
            
            // å¦‚æœæœ‰å…·é«”è©±é¡Œï¼Œå˜—è©¦çµåˆè©±é¡Œå…§å®¹
            if (flowAnalysis.currentTopic && flowAnalysis.currentTopic.type !== 'general') {
                selectedDialogue = adaptToTopic(selectedDialogue, flowAnalysis.currentTopic, character);
            }

            return selectedDialogue;
        }

        // æ ¹æ“šè©±é¡Œèª¿æ•´å°è©±
        function adaptToTopic(dialogue, topic, character) {
            const topicAdaptations = {
                weather: {
                    è‰¾è‰çµ²: ["å°å•Šï¼Œå¤©æ°£çœŸçš„...", "æˆ‘è¦ºå¾—é€™å€‹å¤©æ°£...", "å¤©æ°£è®“æˆ‘æƒ³åˆ°..."],
                    é›·æ©: ["é—œæ–¼å¤©æ°£ï¼Œæˆ‘æƒ³...", "é€™æ¨£çš„å¤©æ°£ç¢ºå¯¦...", "å¤©æ°£æ–¹é¢..."]
                },
                feeling: {
                    è‰¾è‰çµ²: ["æˆ‘çš„æ„Ÿè¦ºæ˜¯...", "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ„Ÿå—...", "ä½ çš„æ„Ÿè¦ºæˆ‘èƒ½ç†è§£..."],
                    é›·æ©: ["æˆ‘ç†è§£ä½ çš„æ„Ÿå—...", "é—œæ–¼é€™ç¨®æ„Ÿè¦º...", "æˆ‘ä¹Ÿæœ‰é¡ä¼¼çš„æƒ³æ³•..."]
                },
                question: {
                    è‰¾è‰çµ²: ["é—œæ–¼ä½ çš„å•é¡Œ...", "é€™å€‹å•é¡Œè®“æˆ‘æƒ³åˆ°...", "ä½ å•å¾—å¾ˆå¥½..."],
                    é›·æ©: ["è®“æˆ‘å›ç­”ä½ çš„å•é¡Œ...", "é€™å€‹å•é¡Œ...", "æ ¹æ“šä½ çš„å•é¡Œ..."]
                }
            };

            const adaptations = topicAdaptations[topic.type];
            if (adaptations && adaptations[character.name]) {
                const adaptedOptions = adaptations[character.name];
                return adaptedOptions[Math.floor(Math.random() * adaptedOptions.length)];
            }

            return dialogue;
        }

        // å‚™ç”¨å›æ‡‰ç”Ÿæˆ
        function generateFallbackResponse(character, style, flowAnalysis) {
            const fallbacks = {
                è‰¾è‰çµ²: ["å—¯ï¼Œæˆ‘æ˜ç™½äº†ã€‚", "æ˜¯é€™æ¨£å•Šã€‚", "æˆ‘æƒ³ä¹Ÿæ˜¯ã€‚", "æœ‰é“ç†ã€‚"],
                é›·æ©: ["æˆ‘ç†è§£ã€‚", "ç¢ºå¯¦å¦‚æ­¤ã€‚", "ä½ èªªå¾—å°ã€‚", "æˆ‘åŒæ„ã€‚"]
            };

            const characterFallbacks = fallbacks[character.name] || fallbacks['è‰¾è‰çµ²'];
            return characterFallbacks[Math.floor(Math.random() * characterFallbacks.length)];
        }

        // åˆ†æå°è©±é€£è²«æ€§å’Œè©±é¡Œ
        function analyzeConversationFlow() {
            const recentDialogues = dialogues.slice(-5);
            
            return {
                lastSpeaker: recentDialogues.length > 0 ? recentDialogues[recentDialogues.length - 1] : null,
                currentTopic: extractCurrentTopic(recentDialogues),
                conversationFlow: analyzeFlow(recentDialogues),
                questionAsked: hasOpenQuestion(recentDialogues),
                emotionalTone: analyzeEmotionalTone(recentDialogues),
                needsResponse: needsDirectResponse(recentDialogues)
            };
        }

        // æå–ç•¶å‰è©±é¡Œ
        function extractCurrentTopic(dialogues) {
            if (dialogues.length === 0) return null;
            
            const lastDialogue = dialogues[dialogues.length - 1];
            if (lastDialogue.type !== 'dialogue') return null;
            
            const content = lastDialogue.content;
            
            // è­˜åˆ¥è©±é¡Œé—œéµè©
            const topicKeywords = {
                greeting: ['ä½ å¥½', 'å—¨', 'å“ˆå›‰', 'æ—©å®‰', 'æ™šå®‰'],
                question: ['ä»€éº¼', 'ç‚ºä»€éº¼', 'æ€éº¼', 'å“ªè£¡', 'èª°', 'ä½•æ™‚', 'å¦‚ä½•'],
                feeling: ['è¦ºå¾—', 'æ„Ÿè¦º', 'æƒ³', 'èªç‚º', 'å–œæ­¡', 'è¨å­'],
                suggestion: ['æˆ‘å€‘', 'å¯ä»¥', 'è¦ä¸è¦', 'å»ºè­°', 'ä¸å¦‚'],
                agreement: ['å°', 'æ˜¯çš„', 'æ²’éŒ¯', 'åŒæ„', 'ç¢ºå¯¦'],
                disagreement: ['ä¸', 'éŒ¯', 'ä¸å°', 'ä¸åŒæ„', 'ä½†æ˜¯'],
                weather: ['å¤©æ°£', 'ä¸‹é›¨', 'æ™´å¤©', 'é¢¨', 'å†·', 'ç†±'],
                time: ['æ™‚é–“', 'æ—©ä¸Š', 'ä¸‹åˆ', 'æ™šä¸Š', 'æ˜å¤©', 'æ˜¨å¤©'],
                place: ['é€™è£¡', 'é‚£è£¡', 'åœ°æ–¹', 'æˆ¿é–“', 'å¤–é¢', 'å®¶']
            };
            
            for (let topic in topicKeywords) {
                for (let keyword of topicKeywords[topic]) {
                    if (content.includes(keyword)) {
                        return { type: topic, keyword: keyword, content: content };
                    }
                }
            }
            
            return { type: 'general', content: content };
        }

        // åˆ†æå°è©±æµå‘
        function analyzeFlow(dialogues) {
            if (dialogues.length < 2) return 'start';
            
            const lastTwo = dialogues.slice(-2);
            const [prev, current] = lastTwo;
            
            if (prev.speakerId === current.speakerId) return 'continuation';
            if (current.content.includes('ï¼Ÿ') || current.content.includes('?')) return 'question_asked';
            if (prev.content.includes('ï¼Ÿ') || prev.content.includes('?')) return 'answering_question';
            
            return 'normal_exchange';
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰æœªå›ç­”çš„å•é¡Œ
        function hasOpenQuestion(dialogues) {
            const lastDialogue = dialogues[dialogues.length - 1];
            if (!lastDialogue || lastDialogue.type !== 'dialogue') return false;
            
            return lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?');
        }

        // åˆ†ææƒ…ç·’åŸºèª¿
        function analyzeEmotionalTone(dialogues) {
            const recentContent = dialogues.slice(-3).map(d => d.content).join(' ');
            
            const emotionPatterns = {
                excited: ['å¤ªæ£’äº†', 'çœŸçš„å—', 'ä¸å¯æ€è­°', 'é©šäºº', 'å“‡'],
                happy: ['é–‹å¿ƒ', 'é«˜èˆˆ', 'å¿«æ¨‚', 'å¥½', 'æ£’', 'å“ˆå“ˆ'],
                concerned: ['æ“”å¿ƒ', 'ç…©æƒ±', 'å›°æ“¾', 'å•é¡Œ', 'éº»ç…©'],
                sad: ['é›£é', 'å‚·å¿ƒ', 'å¤±æœ›', 'ä¸å¥½', 'ç³Ÿç³•'],
                curious: ['æƒ³çŸ¥é“', 'å¥½å¥‡', 'æœ‰è¶£', 'ç‚ºä»€éº¼', 'æ€éº¼æ¨£'],
                calm: ['å¥½çš„', 'äº†è§£', 'çŸ¥é“', 'å—¯', 'æ˜¯']
            };
            
            for (let emotion in emotionPatterns) {
                for (let pattern of emotionPatterns[emotion]) {
                    if (recentContent.includes(pattern)) {
                        return emotion;
                    }
                }
            }
            
            return 'neutral';
        }

        // åˆ¤æ–·æ˜¯å¦éœ€è¦ç›´æ¥å›æ‡‰
        function needsDirectResponse(dialogues) {
            const lastDialogue = dialogues[dialogues.length - 1];
            if (!lastDialogue || lastDialogue.type !== 'dialogue') return false;
            
            const content = lastDialogue.content;
            
            // éœ€è¦å›æ‡‰çš„æƒ…æ³
            const responseNeeded = [
                'ä½ è¦ºå¾—', 'ä½ èªç‚º', 'ä½ æƒ³', 'ä½ çŸ¥é“',
                'å°å§', 'æ˜¯å—', 'å¥½å—', 'å¯ä»¥å—',
                'ï¼Ÿ', '?'
            ];
            
            return responseNeeded.some(pattern => content.includes(pattern));
        }

        // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å°è©±
        async function parseAndAddGeneratedDialogue(text, availableCharacters) {
            const lines = text.split('\n').filter(line => line.trim());
            
            for (const line of lines) {
                const match = line.match(/^(.+?)ï¼š(.+)$/);
                if (match) {
                    const speakerName = match[1].trim();
                    const content = match[2].trim();
                    
                    // å°‹æ‰¾å°æ‡‰çš„è§’è‰²
                    const character = availableCharacters.find(char => 
                        char.name === speakerName || char.name.includes(speakerName) || speakerName.includes(char.name)
                    );
                    
                    if (character) {
                        const dialogue = {
                            type: 'dialogue',
                            speaker: character.name,
                            speakerId: character.id,
                            content: content,
                            timestamp: new Date(),
                            generated: true // æ¨™è¨˜ç‚ºAIç”Ÿæˆ
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                        
                        // æ·»åŠ çŸ­æš«å»¶é²è®“å°è©±é€ä¸€å‡ºç¾
                        await new Promise(resolve => setTimeout(resolve, 800));
                    }
                }
            }
        }

        // ç”Ÿæˆå ´æ™¯æè¿°ï¼ˆä½¿ç”¨OpenRouter APIï¼‰
        async function generateSceneDescription() {
            const apiKey = getAPIKey();
            
            try {
                if (apiKey) {
                    // å˜—è©¦ä½¿ç”¨OpenRouter API
                    await generateSceneWithOpenRouter(apiKey);
                } else {
                    // æ²’æœ‰API Keyï¼Œä½¿ç”¨é€£è²«å ´æ™¯ç”Ÿæˆ
                    const sceneText = generateCoherentScene();
                    
                    const narrator = {
                        type: 'narrator',
                        content: sceneText,
                        timestamp: new Date(),
                        generated: true,
                        simulated: true
                    };
                    
                    dialogues.push(narrator);
                    displayNarrator(narrator);
                    showSecurityTip('ğŸ¬ ä½¿ç”¨æœ¬åœ°å ´æ™¯ç”Ÿæˆ');
                }

            } catch (error) {
                console.error('å ´æ™¯ç”ŸæˆéŒ¯èª¤:', error);
                // APIå¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
                const fallbackScene = generateCoherentScene();
                
                const narrator = {
                    type: 'narrator',
                    content: fallbackScene,
                    timestamp: new Date(),
                    generated: true,
                    simulated: true
                };
                
                dialogues.push(narrator);
                displayNarrator(narrator);
                showSecurityTip('ğŸ¬ APIå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å ´æ™¯ç”Ÿæˆ');
            }
        }

        // ä½¿ç”¨OpenRouterç”Ÿæˆå ´æ™¯æè¿°
        async function generateSceneWithOpenRouter(apiKey) {
            // ç²å–æœ€è¿‘çš„å°è©±ä¾†ç†è§£æƒ…å¢ƒ
            const recentContext = dialogues.slice(-3).map(d => {
                if (d.type === 'dialogue') {
                    return `${d.speaker}èªªï¼š${d.content}`;
                }
                return d.content;
            }).join('ï¼Œ');

            const prompt = `è«‹æ ¹æ“šä»¥ä¸‹å°è©±æƒ…å¢ƒï¼Œç”Ÿæˆä¸€æ®µç°¡æ½”å„ªç¾çš„å ´æ™¯æè¿°æˆ–éå ´æ—ç™½ï¼š

ç›®å‰æƒ…å¢ƒï¼š${recentContext || 'æ•…äº‹é–‹å§‹'}
ç•¶å‰å ´æ™¯ï¼š${currentScene.location}ï¼Œ${currentScene.timeOfDay}ï¼Œ${currentScene.weather}

è¦æ±‚ï¼š
1. ç”Ÿæˆ20-50å­—çš„å ´æ™¯æè¿°
2. è¦æœ‰æ–‡å­¸æ€§ï¼Œç¬¦åˆæ•…äº‹æ°›åœ
3. ä¿æŒèˆ‡ç•¶å‰å ´æ™¯è¨­å®šçš„ä¸€è‡´æ€§
4. åªè¼¸å‡ºæ—ç™½å…§å®¹ï¼Œä¸è¦å…¶ä»–èªªæ˜`;

            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = 'https://openrouter.ai/api/v1/chat/completions';
            
            const response = await fetch(proxyUrl + targetUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-sonnet",
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 200,
                    temperature: 0.7,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`APIéŒ¯èª¤ (${response.status})`);
            }

            const data = await response.json();
            const sceneText = data.choices[0].message.content.trim();

            // æ·»åŠ å ´æ™¯æè¿°
            const narrator = {
                type: 'narrator',
                content: sceneText,
                timestamp: new Date(),
                generated: true,
                apiGenerated: true
            };
            
            dialogues.push(narrator);
            displayNarrator(narrator);
            showSecurityTip('ğŸ¬ OpenRouterå ´æ™¯ç”Ÿæˆå®Œæˆ');
        }

        // åˆ†æä¸¦æ›´æ–°å ´æ™¯ç‹€æ…‹
        function analyzeAndUpdateScene() {
            const recentDialogues = dialogues.slice(-5);
            
            // å¾å°è©±ä¸­æå–å ´æ™¯ç·šç´¢
            recentDialogues.forEach(dialogue => {
                if (dialogue.type === 'dialogue') {
                    const content = dialogue.content.toLowerCase();
                    
                    // æª¢æ¸¬åœ°é»è®ŠåŒ–çš„é—œéµè©
                    if (content.includes('èµ°') || content.includes('å»') || content.includes('åˆ°')) {
                        if (content.includes('å¤–é¢') || content.includes('å‡ºå»') || content.includes('è¡—ä¸Š')) {
                            currentScene.location = 'æˆ¶å¤–';
                        } else if (content.includes('å›ä¾†') || content.includes('é€²ä¾†') || content.includes('æˆ¿é–“')) {
                            currentScene.location = 'å®¤å…§';
                        } else if (content.includes('å’–å•¡å»³') || content.includes('é¤å»³')) {
                            currentScene.location = 'å’–å•¡å»³';
                        } else if (content.includes('å…¬åœ’')) {
                            currentScene.location = 'å…¬åœ’';
                        } else if (content.includes('å­¸æ ¡') || content.includes('æ•™å®¤')) {
                            currentScene.location = 'å­¸æ ¡';
                        }
                    }
                    
                    // æª¢æ¸¬æ™‚é–“è®ŠåŒ–
                    if (content.includes('æ™šä¸Š') || content.includes('å¤œæ™š') || content.includes('å¤©é»‘')) {
                        currentScene.timeOfDay = 'å¤œæ™š';
                    } else if (content.includes('æ—©ä¸Š') || content.includes('ä¸Šåˆ')) {
                        currentScene.timeOfDay = 'æ—©æ™¨';
                    } else if (content.includes('ä¸‹åˆ') || content.includes('å‚æ™š')) {
                        currentScene.timeOfDay = 'å‚æ™š';
                    }
                    
                    // æª¢æ¸¬å¤©æ°£è®ŠåŒ–
                    if (content.includes('ä¸‹é›¨') || content.includes('é›¨')) {
                        currentScene.weather = 'é›¨å¤©';
                    } else if (content.includes('æ™´') || content.includes('é™½å…‰')) {
                        currentScene.weather = 'æ™´æœ—';
                    } else if (content.includes('é¢¨')) {
                        currentScene.weather = 'æœ‰é¢¨';
                    }
                    
                    // æª¢æ¸¬æ°›åœè®ŠåŒ–
                    if (content.includes('ç·Šå¼µ') || content.includes('å±éšª') || content.includes('å°å¿ƒ')) {
                        currentScene.atmosphere = 'ç·Šå¼µ';
                    } else if (content.includes('é–‹å¿ƒ') || content.includes('å¿«æ¨‚') || content.includes('å“ˆå“ˆ')) {
                        currentScene.atmosphere = 'æ­¡æ¨‚';
                    } else if (content.includes('æµªæ¼«') || content.includes('ç¾å¥½') || content.includes('æº«é¦¨')) {
                        currentScene.atmosphere = 'æº«é¦¨';
                    } else if (content.includes('å¹³éœ') || content.includes('å®‰éœ')) {
                        currentScene.atmosphere = 'å¹³éœ';
                    }
                }
            });
        }

        // ç”Ÿæˆé€£è²«çš„å ´æ™¯æè¿°
        function generateCoherentScene() {
            analyzeAndUpdateScene();
            
            const sceneTemplates = {
                å®¤å…§: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "é™½å…‰é€éçª—æˆ¶ç‘é€²æˆ¿é–“ï¼Œåœ¨åœ°æ¿ä¸Šå½¢æˆæº«æš–çš„å…‰æ–‘ã€‚",
                            "å®¤å…§çš„å…‰ç·šæŸ”å’Œè€Œæ˜äº®ï¼Œç‡Ÿé€ å‡ºèˆ’é©çš„æ°›åœã€‚",
                            "å¾®é¢¨å¾åŠé–‹çš„çª—æˆ¶å¹é€²ä¾†ï¼Œå¸¶ä¾†å¤–é¢çš„æ¸…æ–°ç©ºæ°£ã€‚"
                        ],
                        é›¨å¤©: [
                            "é›¨æ»´è¼•æ•²è‘—çª—ç»ç’ƒï¼Œç™¼å‡ºè¦å¾‹çš„ç¯€æ‹è²ã€‚",
                            "å®¤å…§é¡¯å¾—æ ¼å¤–æº«æš–ï¼Œèˆ‡å¤–é¢çš„é›¨å¤©å½¢æˆå°æ¯”ã€‚",
                            "é›¨è²æˆç‚ºäº†å°è©±çš„èƒŒæ™¯éŸ³æ¨‚ã€‚"
                        ],
                        æœ‰é¢¨: [
                            "çª—ç°¾åœ¨å¾®é¢¨ä¸­è¼•æŸ”åœ°é£„å‹•è‘—ã€‚",
                            "é¢¨è²åœ¨æˆ¿é–“è£¡è¼•æŸ”åœ°è¿´éŸ¿ã€‚"
                        ]
                    },
                    å¤œæ™š: {
                        æ™´æœ—: [
                            "æœˆå…‰é€éçª—æˆ¶ç‘é€²ä¾†ï¼Œç‚ºæˆ¿é–“å¢æ·»äº†ä¸€çµ²è©©æ„ã€‚",
                            "å®¤å…§çš„ç‡ˆå…‰æº«æš–è€ŒæŸ”å’Œï¼Œå‰µé€ å‡ºå¯§éœçš„å¤œæ™šæ°›åœã€‚",
                            "å¤œæ™šçš„å¯§éœåŒ…åœè‘—é€™å€‹æº«é¦¨çš„ç©ºé–“ã€‚"
                        ],
                        é›¨å¤©: [
                            "å¤œé›¨æ•²æ‰“è‘—çª—æˆ¶ï¼Œä½¿å®¤å…§é¡¯å¾—æ›´åŠ æº«æš–å®‰å…¨ã€‚",
                            "é›¨å¤œçš„å®¤å…§æ ¼å¤–å¯§éœèˆ’é©ã€‚"
                        ]
                    }
                },
                æˆ¶å¤–: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "é™½å…‰ç‘åœ¨è¡—é“ä¸Šï¼Œå¾®é¢¨è¼•æ’«éè‡‰é °ã€‚",
                            "å¤©ç©ºæ¹›è—ï¼Œç™½é›²æ‚ æ‚ é£„éã€‚",
                            "æº«æš–çš„é™½å…‰è®“ä¸€åˆ‡éƒ½é¡¯å¾—ç”Ÿæ©Ÿå‹ƒå‹ƒã€‚"
                        ],
                        é›¨å¤©: [
                            "é›¨æ»´å¾å¤©ç©ºé£„è½ï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—æ¸…æ–°çš„å‘³é“ã€‚",
                            "é›¨å¾Œçš„ç©ºæ°£æ ¼å¤–æ¸…æ–°ï¼Œæ´—æ·¨äº†åŸå¸‚çš„å¡µåŸƒã€‚"
                        ]
                    },
                    å¤œæ™š: {
                        æ™´æœ—: [
                            "å¤œç©ºä¸­æ˜Ÿæ˜Ÿé–ƒçˆï¼Œè¡—ç‡ˆç…§äº®äº†å‰æ–¹çš„è·¯ã€‚",
                            "æ¶¼çˆ½çš„å¤œé¢¨å¸¶ä¾†äº†é æ–¹çš„èŠ±é¦™ã€‚",
                            "å¤œæ™šçš„åŸå¸‚åœ¨ç‡ˆç«ä¸­é¡¯å¾—æ ¼å¤–ç¾éº—ã€‚"
                        ]
                    }
                },
                å’–å•¡å»³: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "å’–å•¡å»³è£¡ç€°æ¼«è‘—é¦™æ¿ƒçš„å’–å•¡å‘³ï¼Œé™½å…‰å¾çª—æˆ¶ç‘é€²ä¾†ã€‚",
                            "è¼•æŸ”çš„éŸ³æ¨‚åœ¨å’–å•¡å»³è£¡æ’­æ”¾è‘—ï¼Œç‡Ÿé€ å‡ºæ‚ é–’çš„æ°›åœã€‚",
                            "å…¶ä»–å®¢äººçš„ä½è²äº¤è«‡è²æˆç‚ºäº†èˆ’é©çš„èƒŒæ™¯éŸ³ã€‚"
                        ]
                    },
                    å‚æ™š: {
                        æ™´æœ—: [
                            "å‚æ™šçš„å’–å•¡å»³ç‡ˆå…‰æº«æš–ï¼Œçª—å¤–å¤•é™½è¥¿ä¸‹ã€‚",
                            "å’–å•¡å»³åœ¨å¤•é™½çš„ç…§å°„ä¸‹é¡¯å¾—æ ¼å¤–æº«é¦¨ã€‚"
                        ]
                    }
                },
                å…¬åœ’: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "å…¬åœ’è£¡ç¶ æ¨¹æˆè”­ï¼Œé³¥å…’åœ¨æé ­æ­Œå”±ã€‚",
                            "å¾®é¢¨å¹éæ¨¹è‘‰ï¼Œç™¼å‡ºæ²™æ²™çš„è²éŸ¿ã€‚",
                            "é™½å…‰é€éæ¨¹è‘‰ç‘ä¸‹æ–‘é§çš„å…‰å½±ã€‚"
                        ]
                    },
                    å‚æ™š: {
                        æ™´æœ—: [
                            "å¤•é™½è¥¿ä¸‹ï¼Œå…¬åœ’è£¡çš„ä¸€åˆ‡éƒ½è¢«æŸ“æˆäº†é‡‘é»ƒè‰²ã€‚",
                            "å‚æ™šçš„å…¬åœ’æ ¼å¤–å¯§éœï¼Œåªæœ‰å¾®é¢¨å’Œé³¥é³´è²ã€‚"
                        ]
                    }
                }
            };
            
            // ç²å–ç•¶å‰å ´æ™¯çš„æè¿°é¸é …
            const locationScenes = sceneTemplates[currentScene.location] || sceneTemplates['å®¤å…§'];
            const timeScenes = locationScenes[currentScene.timeOfDay] || locationScenes['ç™½å¤©'];
            const weatherScenes = timeScenes[currentScene.weather] || timeScenes['æ™´æœ—'];
            
            if (weatherScenes.length === 0) {
                return generateDefaultScene();
            }
            
            // æ ¹æ“šæ°›åœèª¿æ•´æè¿°
            let selectedScene = weatherScenes[Math.floor(Math.random() * weatherScenes.length)];
            
            // æ ¹æ“šç•¶å‰æ°›åœæ·»åŠ ä¿®é£¾
            switch (currentScene.atmosphere) {
                case 'ç·Šå¼µ':
                    selectedScene += ' ç©ºæ°£ä¸­ä¼¼ä¹ç€°æ¼«è‘—ä¸€çµ²ç·Šå¼µçš„æ°£æ¯ã€‚';
                    break;
                case 'æ­¡æ¨‚':
                    selectedScene += ' æ­¡å¿«çš„æ°›åœè®“ä¸€åˆ‡éƒ½é¡¯å¾—æ›´åŠ ç¾å¥½ã€‚';
                    break;
                case 'æº«é¦¨':
                    selectedScene += ' æº«é¦¨çš„æ°£æ°›è®“äººæ„Ÿåˆ°å¿ƒæƒ…æ„‰æ‚¦ã€‚';
                    break;
                case 'å¹³éœ':
                    selectedScene += ' ä¸€åˆ‡éƒ½é¡¯å¾—é‚£éº¼å¹³éœç¥¥å’Œã€‚';
                    break;
            }
            
            return selectedScene;
        }

        // é è¨­å ´æ™¯æè¿°
        function generateDefaultScene() {
            return "æ™‚å…‰éœéœåœ°æµæ·Œè‘—ï¼Œå‘¨åœçš„ä¸€åˆ‡éƒ½é¡¯å¾—é‚£éº¼è‡ªç„¶è€Œå’Œè«§ã€‚";
        }

        // æ›´æ–°å°èªªé è¦½
        function updateNovelPreview() {
            const preview = document.getElementById('novel-preview');
            let novelText = '';

            dialogues.forEach(item => {
                if (item.type === 'dialogue') {
                    novelText += `<p><strong>${item.speaker}ï¼š</strong>ã€Œ${item.content}ã€</p>`;
                } else if (item.type === 'narrator') {
                    novelText += `<p style="text-align: center; font-style: italic; color: #666; margin: 20px 0;">${item.content}</p>`;
                }
            });

            preview.innerHTML = novelText || '<p style="text-align: center; color: #666;">å°šæœªå»ºç«‹å°è©±å…§å®¹...</p>';
        }

        // åŒ¯å‡ºå°èªª
        function exportNovel() {
            if (dialogues.length === 0) {
                alert('è«‹å…ˆå»ºç«‹ä¸€äº›å°è©±å…§å®¹ï¼');
                return;
            }

            const format = document.getElementById('export-format').value;
            
            switch(format) {
                case 'txt':
                    exportToTXT();
                    break;
                case 'docx':
                    exportToWord();
                    break;
                case 'pdf':
                    exportToPDF();
                    break;
                default:
                    alert('è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼');
            }
        }

        // åŒ¯å‡ºç‚ºTXT
        function exportToTXT() {
            let novelText = 'AIå¤šè§’è‰²å°è©±å°èªª\n' + '='.repeat(30) + '\n\n';
            
            dialogues.forEach(item => {
                if (item.type === 'dialogue') {
                    novelText += `${item.speaker}ï¼šã€Œ${item.content}ã€\n\n`;
                } else if (item.type === 'narrator') {
                    novelText += `${item.content}\n\n`;
                }
            });

            const blob = new Blob([novelText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å°è©±å°èªª.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // åŒ¯å‡ºç‚ºWordæ–‡ä»¶
        function exportToWord() {
            try {
                const doc = new docx.Document({
                    sections: [{
                        properties: {},
                        children: [
                            new docx.Paragraph({
                                text: "AIå¤šè§’è‰²å°è©±å°èªª",
                                heading: docx.HeadingLevel.TITLE,
                                alignment: docx.AlignmentType.CENTER,
                            }),
                            new docx.Paragraph({
                                text: "",
                                spacing: { after: 400 }
                            }),
                            ...dialogues.map(item => {
                                if (item.type === 'dialogue') {
                                    return new docx.Paragraph({
                                        children: [
                                            new docx.TextRun({
                                                text: `${item.speaker}ï¼š`,
                                                bold: true,
                                            }),
                                            new docx.TextRun({
                                                text: `ã€Œ${item.content}ã€`,
                                            }),
                                        ],
                                        spacing: { after: 200 }
                                    });
                                } else if (item.type === 'narrator') {
                                    return new docx.Paragraph({
                                        text: item.content,
                                        italics: true,
                                        alignment: docx.AlignmentType.CENTER,
                                        spacing: { after: 200 }
                                    });
                                }
                            }).filter(Boolean)
                        ]
                    }]
                });

                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, "å°è©±å°èªª.docx");
                });
            } catch (error) {
                console.error('WordåŒ¯å‡ºéŒ¯èª¤:', error);
                alert('WordåŒ¯å‡ºåŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–æ ¼å¼ã€‚');
            }
        }

        // åŒ¯å‡ºç‚ºPDFï¼ˆåœ–ç‰‡æ¨£å¼ï¼‰
        function exportToPDF() {
            if (dialogues.length === 0) {
                alert('è«‹å…ˆå»ºç«‹ä¸€äº›å°è©±å…§å®¹ï¼');
                return;
            }

            // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„PDFé è¦½å®¹å™¨
            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = `
                width: 210mm;
                min-height: 297mm;
                background: white;
                padding: 20mm;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
                position: absolute;
                left: -9999px;
                top: 0;
                box-sizing: border-box;
            `;

            // æ·»åŠ æ¨™é¡Œ
            const title = document.createElement('div');
            title.style.cssText = `
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                color: #333;
                margin-bottom: 30px;
                padding-bottom: 10px;
                border-bottom: 3px solid #4facfe;
            `;
            title.textContent = 'AIå¤šè§’è‰²å°è©±å°èªª';
            pdfContainer.appendChild(title);

            // æ·»åŠ å°è©±å…§å®¹
            dialogues.forEach(item => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    border-radius: 15px;
                    max-width: 80%;
                    word-wrap: break-word;
                `;

                if (item.type === 'dialogue') {
                    const isProtagonist = protagonistId && item.speakerId == protagonistId;
                    
                    if (isProtagonist) {
                        messageDiv.style.cssText += `
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            color: white;
                            margin-left: auto;
                            margin-right: 0;
                        `;
                    } else {
                        messageDiv.style.cssText += `
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            margin-left: 0;
                            margin-right: auto;
                        `;
                    }

                    const speakerName = document.createElement('div');
                    speakerName.style.cssText = `
                        font-weight: bold;
                        font-size: 14px;
                        margin-bottom: 8px;
                        opacity: 0.9;
                    `;
                    speakerName.textContent = item.speaker;

                    const content = document.createElement('div');
                    content.style.cssText = `
                        font-size: 16px;
                        line-height: 1.5;
                    `;
                    content.textContent = item.content;

                    messageDiv.appendChild(speakerName);
                    messageDiv.appendChild(content);

                } else if (item.type === 'narrator') {
                    messageDiv.style.cssText += `
                        background: #f8f9fa;
                        color: #495057;
                        text-align: center;
                        font-style: italic;
                        margin: 20px auto;
                        border-left: 4px solid #6c757d;
                    `;
                    messageDiv.textContent = item.content;
                }

                pdfContainer.appendChild(messageDiv);
            });

            // æš«æ™‚æ·»åŠ åˆ°é é¢ä»¥é€²è¡Œæˆªåœ–
            document.body.appendChild(pdfContainer);

            // ä½¿ç”¨html2canvasæˆªåœ–ä¸¦è½‰æ›ç‚ºPDF
            html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: 'white',
                width: pdfContainer.scrollWidth,
                height: pdfContainer.scrollHeight
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                // A4å°ºå¯¸
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // ç¬¬ä¸€é 
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // å¦‚æœå…§å®¹è¶…éä¸€é ï¼Œæ·»åŠ æ–°é é¢
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('å°è©±å°èªª.pdf');
                
                // æ¸…ç†è‡¨æ™‚å…ƒç´ 
                document.body.removeChild(pdfContainer);
            }).catch(error => {
                console.error('PDFåŒ¯å‡ºéŒ¯èª¤:', error);
                alert('PDFåŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é¸æ“‡å…¶ä»–æ ¼å¼ã€‚');
                document.body.removeChild(pdfContainer);
            });
        }

        // å„²å­˜å°ˆæ¡ˆ
        function saveProject() {
            const projectData = {
                characters: characters,
                dialogues: dialogues,
                timestamp: new Date()
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å°èªªå°ˆæ¡ˆ.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // é‡æ–°é¡¯ç¤ºèŠå¤©å…§å®¹
        function refreshChatDisplay() {
            const container = document.getElementById('chat-container');
            container.innerHTML = '<div class="message narrator"><div class="message-header">ç³»çµ±æç¤º</div>æ­¡è¿ä½¿ç”¨AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±ï¼è«‹å…ˆå»ºç«‹è§’è‰²ï¼Œç„¶å¾Œé–‹å§‹å‰µä½œå°è©±ã€‚</div>';
            
            dialogues.forEach(item => {
                if (item.type === 'dialogue') {
                    displayDialogue(item);
                } else if (item.type === 'narrator') {
                    displayNarrator(item);
                }
            });
        }

        // æ¸…ç©ºå°è©±ï¼ˆåŒæ™‚é‡ç½®å ´æ™¯ç‹€æ…‹ï¼‰
        function clearChat() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å°è©±å—ï¼Ÿé€™å°‡é‡ç½®æ‰€æœ‰è§’è‰²çš„è¨˜æ†¶å’Œå ´æ™¯è¨­å®šã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                dialogues = [];
                characterMemories = {}; // æ¸…ç©ºæ‰€æœ‰è§’è‰²è¨˜æ†¶
                // é‡ç½®å ´æ™¯ç‹€æ…‹
                currentScene = {
                    location: 'å®¤å…§',
                    timeOfDay: 'ç™½å¤©',
                    weather: 'æ™´æœ—',
                    atmosphere: 'å¹³éœ',
                    established: false
                };
                const container = document.getElementById('chat-container');
                container.innerHTML = '<div class="message narrator"><div class="message-header">ç³»çµ±æç¤º</div>æ­¡è¿ä½¿ç”¨AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±ï¼è«‹å…ˆå»ºç«‹è§’è‰²ï¼Œç„¶å¾Œé–‹å§‹å‰µä½œå°è©±ã€‚</div>';
                showSecurityTip('ğŸ’¬ å°è©±å·²æ¸…ç©ºï¼Œè§’è‰²è¨˜æ†¶å’Œå ´æ™¯å·²é‡ç½®');
            }
        }

        // æ”¹é€²çš„æœ¬åœ°ç”Ÿæˆï¼ˆç•¶APIå¤±æ•—æ™‚ä½¿ç”¨ï¼‰
function generateBackupOptions(speaker, context) {
    console.log('ä½¿ç”¨å‚™ç”¨æœ¬åœ°ç”Ÿæˆ');
    
    const speakerName = speaker.name;
    const isCheerful = speaker.personality && speaker.personality.includes('æ´»æ½‘');
    const isCalm = speaker.personality && speaker.personality.includes('æ²‰ç©©');
    
    const backupOptions = {
        è‰¾è‰çµ²: [
            "æˆ‘è¦ºå¾—é€™å€‹æƒ³æ³•å¾ˆæ£’ï¼",
            "è®“æˆ‘å€‘ç¹¼çºŒé€™å€‹è©±é¡Œå§ã€‚",
            "ä½ èªªå¾—å¾ˆæœ‰é“ç†å‘¢ã€‚",
            "æˆ‘æƒ³åˆ†äº«ä¸€ä¸‹æˆ‘çš„çœ‹æ³•ã€‚"
        ],
        é›·æ©: [
            "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚",
            "é€™éœ€è¦ä»”ç´°è€ƒæ…®ä¸€ä¸‹ã€‚",
            "æˆ‘å€‘å¯ä»¥å¾å¦ä¸€å€‹è§’åº¦çœ‹ã€‚",
            "è®“æˆ‘æƒ³æƒ³é€™å€‹å•é¡Œã€‚"
        ]
    };
    
    // å¦‚æœæ‰¾ä¸åˆ°ç‰¹å®šè§’è‰²ï¼Œä½¿ç”¨é€šç”¨é¸é …
    const characterOptions = backupOptions[speakerName] || [
        "æˆ‘æ˜ç™½ä½ çš„æ„æ€ã€‚",
        "é€™å€‹è©±é¡Œå¾ˆæœ‰è¶£ã€‚",
        "æˆ‘å€‘ç¹¼çºŒèŠèŠå§ã€‚",
        "ä½ èªªå¾—å°ã€‚"
    ];
    
    return characterOptions;
}

        // è¼‰å…¥ç¯„æœ¬
        function loadTemplate() {
            alert('è§’è‰²ç¯„æœ¬å·²è¼‰å…¥ï¼ä½ å¯ä»¥åœ¨è§’è‰²åˆ—è¡¨ä¸­çœ‹åˆ°é è¨­è§’è‰²ã€‚');
        }
        
// ä½¿ç”¨APIç”Ÿæˆç« ç¯€å…§å®¹
async function generateChapterWithAPI(apiKey, apiService, chapter, characters, outline, chapterNum) {
    const characterDescriptions = characters.map(char => 
        `${char.name}ï¼šå€‹æ€§${char.personality}ï¼Œèªªè©±èªæ°£${char.tone}`
    ).join('\n');
    
    const prompt = `ä½ æ˜¯å°ˆæ¥­å°èªªç·¨åŠ‡ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è¨­å®šç”Ÿæˆç¬¬${chapterNum}ç« çš„å…§å®¹ï¼š

ã€å°èªªå¤§ç¶±ã€‘
${outline}

ã€è§’è‰²è¨­å®šã€‘
${characterDescriptions}

ã€ç« ç¯€ä¸»é¡Œã€‘
ç¬¬${chapterNum}ç« ï¼š${chapter.title}
ä¸»è¦æƒ…ç¯€ï¼š${chapter.theme}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. ç”Ÿæˆç¬¦åˆå¤§ç¶±çš„ç« ç¯€å…§å®¹
2. åŒ…å«3-5æ®µå°è©±ï¼Œç¬¦åˆè§’è‰²å€‹æ€§
3. åŒ…å«2-3æ®µå ´æ™¯æè¿°æˆ–å‹•ä½œæè¿°
4. å…§å®¹è¦æ¨é€²åŠ‡æƒ…ï¼Œèˆ‡å¤§ç¶±ç›¸é—œ
5. å­—æ•¸æ§åˆ¶åœ¨300-500å­—

ã€è¼¸å‡ºæ ¼å¼ã€‘
æ—ç™½ï¼š[å ´æ™¯æè¿°]
${characters[0].name}ï¼šã€Œ[å°è©±å…§å®¹]ã€
å‹•ä½œï¼š[å‹•ä½œæè¿°]
${characters[1]?.name || characters[0].name}ï¼šã€Œ[å°è©±å…§å®¹]ã€
æ—ç™½ï¼š[æƒ…ç¯€æè¿°]

è«‹ç›´æ¥è¼¸å‡ºå…§å®¹ï¼Œä¸è¦å…¶ä»–èªªæ˜ã€‚`;

    let generatedText = '';
    
    // æ ¹æ“šä¸åŒAPIæœå‹™èª¿ç”¨
    switch (apiService) {
        case 'huggingface':
            generatedText = await generateWithHuggingFaceForNovel(apiKey, prompt);
            break;
        case 'deepseek':
            generatedText = await generateWithDeepSeekForNovel(apiKey, prompt);
            break;
        case 'groq':
            generatedText = await generateWithGroqForNovel(apiKey, prompt);
            break;
        default:
            throw new Error('æœªæ”¯æ´çš„APIæœå‹™');
    }
    
    // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å…§å®¹
    if (generatedText) {
        await parseAndAddChapterContent(generatedText);
    } else {
        throw new Error('APIè¿”å›ç©ºå…§å®¹');
    }
}

// ä½¿ç”¨DeepSeekç”Ÿæˆå°èªªå…§å®¹
async function generateWithDeepSeekForNovel(apiKey, prompt) {
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            model: 'deepseek-chat',
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 800,
            temperature: 0.8,
            top_p: 0.9,
            stream: false
        })
    });

    if (!response.ok) {
        throw new Error(`DeepSeek APIéŒ¯èª¤: ${response.status}`);
    }

    const data = await response.json();
    if (data.error) {
        throw new Error(`DeepSeekéŒ¯èª¤: ${data.error.message}`);
    }
    
    return data.choices[0]?.message?.content || '';
}

// ä½¿ç”¨Groqç”Ÿæˆå°èªªå…§å®¹
async function generateWithGroqForNovel(apiKey, prompt) {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            model: 'llama3-8b-8192',
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 800,
            temperature: 0.8,
            top_p: 0.9,
            stream: false
        })
    });

    if (!response.ok) {
        throw new Error(`Groq APIéŒ¯èª¤: ${response.status}`);
    }

    const data = await response.json();
    if (data.error) {
        throw new Error(`GroqéŒ¯èª¤: ${data.error.message}`);
    }
    
    return data.choices[0]?.message?.content || '';
}

// ä½¿ç”¨Hugging Faceç”Ÿæˆå°èªªå…§å®¹
async function generateWithHuggingFaceForNovel(apiKey, prompt) {
    const response = await fetch('https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            inputs: prompt,
            parameters: {
                max_length: 400,
                temperature: 0.8,
                do_sample: true,
                top_p: 0.9
            }
        })
    });

    if (!response.ok) {
        throw new Error(`Hugging Face APIéŒ¯èª¤: ${response.status}`);
    }

    const data = await response.json();
    if (data.error) {
        throw new Error(`Hugging FaceéŒ¯èª¤: ${data.error}`);
    }
    
    return data[0]?.generated_text || '';
}

    </script>
</body>
</html>
