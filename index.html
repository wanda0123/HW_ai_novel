<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .content-area {
            flex: 1;
            padding: 20px;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .message.character {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.protagonist {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        .message.other {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 0;
            margin-right: auto;
        }

        .message.narrator {
            background: #e9ecef;
            color: #495057;
            text-align: center;
            font-style: italic;
            margin: 0 auto;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .character-list {
            list-style: none;
        }

        .character-item {
            background: white;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .character-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .character-desc {
            color: #666;
            font-size: 0.9em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±</h1>
            <p>å‰µé€ ä½ çš„äº’å‹•å¼å°è©±å°èªª</p>
        </div>

        <div class="main-content">
            <!-- å´é‚Šæ¬„ - è§’è‰²ç®¡ç† -->
            <div class="sidebar">
                <div class="section">
                    <h3>ğŸ‘¥ è§’è‰²ç®¡ç†</h3>
                    <button class="btn" onclick="showCreateCharacter()">+ æ–°å¢è§’è‰²</button>
                    <button class="btn btn-secondary" onclick="loadTemplate()">ğŸ“‹ è¼‰å…¥ç¯„æœ¬</button>
                    
                    <div id="character-list">
                        <ul class="character-list">
                            <!-- è§’è‰²åˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                        </ul>
                    </div>
                </div>

                <div class="section">
                    <h3>âš™ï¸ ç³»çµ±è¨­å®š</h3>
                    <div class="input-group">
                        <label>OpenRouter API Keyï¼š</label>
                        <input type="password" id="api-key" placeholder="è«‹è¼¸å…¥ä½ çš„OpenRouter API Key">
                        <small style="color: #666; font-size: 12px;">
                            ğŸ”’ å®‰å…¨æç¤ºï¼šAPI Keyåªæœƒæš«æ™‚å„²å­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œä¸æœƒè¢«ä¿å­˜æˆ–åˆ†äº«
                            <br>ğŸ“ å¾ <a href="https://openrouter.ai/" target="_blank" style="color: #4facfe;">openrouter.ai</a> å–å¾—
                        </small>
                        <div style="margin-top: 8px;">
                            <label style="display: flex; align-items: center; font-size: 12px; color: #666;">
                                <input type="checkbox" id="save-api-key" style="margin-right: 5px;">
                                æš«æ™‚å„²å­˜åˆ°æœ¬åœ°ç€è¦½å™¨ (åƒ…é™æ­¤æ¬¡ä½¿ç”¨)
                            </label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ä¸»è§’è¨­å®šï¼š</label>
                        <select id="protagonist-select">
                            <option value="">é¸æ“‡ä¸»è§’</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>åŒ¯å‡ºæ ¼å¼ï¼š</label>
                        <select id="export-format">
                            <option value="txt">ç´”æ–‡å­— (.txt)</option>
                            <option value="docx">Wordæ–‡ä»¶ (.docx)</option>
                            <option value="pdf">PDFæ–‡ä»¶ (.pdf)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportNovel()">ğŸ“„ åŒ¯å‡ºå°èªª</button>
                    <button class="btn btn-secondary" onclick="saveProject()">ğŸ’¾ å„²å­˜å°ˆæ¡ˆ</button>
                </div>
            </div>

            <!-- ä¸»è¦å…§å®¹å€ -->
            <div class="content-area">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('chat')">ğŸ’¬ å°è©±å‰µä½œ</div>
                    <div class="tab" onclick="switchTab('character')">ğŸ‘¤ è§’è‰²ç·¨è¼¯</div>
                    <div class="tab" onclick="switchTab('preview')">ğŸ“– é è¦½å°èªª</div>
                </div>

                <!-- å°è©±å‰µä½œå€ -->
                <div id="chat-tab" class="tab-content">
                    <div class="section">
                        <h3>ğŸ’¬ å°è©±å‰µä½œå€</h3>
                        <div class="chat-container" id="chat-container">
                            <div class="message narrator">
                                <div class="message-header">ç³»çµ±æç¤º</div>
                                æ­¡è¿ä½¿ç”¨AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±ï¼è«‹å…ˆå»ºç«‹è§’è‰²ï¼Œç„¶å¾Œé–‹å§‹å‰µä½œå°è©±ã€‚
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <select id="speaker-select" style="flex: 0 0 150px;">
                                <option value="">é¸æ“‡èªªè©±è€…</option>
                            </select>
                            <input type="text" id="dialogue-input" placeholder="è¼¸å…¥å°è©±å…§å®¹..." style="flex: 1;" onkeypress="handleEnterKey(event)">
                            <button class="btn" onclick="addDialogue()" id="send-btn">ç™¼é€</button>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="addNarrator()">+ æ–°å¢æ—ç™½</button>
                            <button class="btn" onclick="generateDialogueOptions()" id="choice-btn">ğŸ¯ ç”Ÿæˆå°è©±é¸é …</button>
                            <button class="btn" onclick="generateFullNovel()" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);">ğŸ“š AIè‡ªå‹•ç”Ÿæˆå°èªª</button>
                            <button class="btn" onclick="generateAIScene()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">ğŸ¬ AIç”Ÿæˆå ´æ™¯</button>
                            <button class="btn" onclick="clearChat()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">ğŸ—‘ï¸ æ¸…ç©ºå°è©±</button>
                        </div>
                        
                        <!-- å°è©±é¸é …å€åŸŸ -->
                        <div id="dialogue-options" style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; display: none;">
                            <h4 style="margin-bottom: 10px; color: #333;">ğŸ’¬ é¸æ“‡å›æ‡‰</h4>
                            <div id="dialogue-choices"></div>
                            <button class="btn btn-secondary" onclick="hideDialogueOptions()" style="margin-top: 10px;">å–æ¶ˆ</button>
                        </div>
                        
                        <!-- è‡ªå‹•ç”Ÿæˆå°èªªè¨­å®š -->
                        <div id="novel-generation" style="margin-top: 15px; padding: 15px; background: #fff8dc; border-radius: 8px; display: none;">
                            <h4 style="margin-bottom: 10px; color: #333;">ğŸ“š è‡ªå‹•ç”Ÿæˆå°èªªè¨­å®š</h4>
                            <div class="input-group">
                                <label>å°èªªå¤§ç¶±ï¼š</label>
                                <textarea id="novel-outline" rows="3" placeholder="è«‹æè¿°å°èªªçš„ä¸»è¦æƒ…ç¯€ï¼Œä¾‹å¦‚ï¼šä¸€å€‹é—œæ–¼å‹æƒ…çš„æ•…äº‹ï¼Œå…©å€‹å­¸ç”Ÿåœ¨å­¸æ ¡ç›¸é‡..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>ç›®æ¨™å­—æ•¸ï¼š</label>
                                <select id="novel-length">
                                    <option value="5000">çŸ­ç¯‡ (ç´„5000å­—)</option>
                                    <option value="10000">ä¸­çŸ­ç¯‡ (ç´„10000å­—)</option>
                                    <option value="15000">ä¸­ç¯‡ (ç´„15000å­—)</option>
                                    <option value="20000">é•·ç¯‡ (ç´„20000å­—)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>çµå°¾é¢¨æ ¼ï¼š</label>
                                <select id="novel-ending" onchange="toggleCustomEnding()">
                                    <option value="happy">åœ“æ»¿çµå±€</option>
                                    <option value="open">é–‹æ”¾å¼çµå±€</option>
                                    <option value="twist">è½‰æŠ˜çµå±€</option>
                                    <option value="emotional">æ„Ÿäººçµå±€</option>
                                    <option value="cliffhanger">æ‡¸å¿µçµå±€</option>
                                    <option value="custom">å…¶ä»– (è‡ªå®šç¾©)</option>
                                </select>
                                <input type="text" id="custom-ending" placeholder="è«‹æè¿°ä½ æƒ³è¦çš„çµå°¾é¢¨æ ¼..." style="margin-top: 8px; display: none;">
                            </div>
                            <div class="input-group">
                                <label>ä¸»è¦è§’è‰²æ•¸é‡ï¼š</label>
                                <select id="character-count" onchange="toggleCustomCharacterCount()">
                                    <option value="2">2å€‹ä¸»è¦è§’è‰²</option>
                                    <option value="3">3å€‹ä¸»è¦è§’è‰²</option>
                                    <option value="4">4å€‹ä¸»è¦è§’è‰² + è·¯äºº</option>
                                    <option value="5">5å€‹ä¸»è¦è§’è‰² + è·¯äºº</option>
                                    <option value="custom">å…¶ä»– (è‡ªå®šç¾©)</option>
                                </select>
                                <input type="number" id="custom-character-count" min="1" max="10" placeholder="è¼¸å…¥è§’è‰²æ•¸é‡ (1-10)" style="margin-top: 8px; display: none;">
                            </div>
                            <button class="btn" onclick="startNovelGeneration()">ğŸš€ é–‹å§‹ç”Ÿæˆå°èªª</button>
                            <button class="btn btn-secondary" onclick="hideNovelGeneration()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²ç·¨è¼¯å€ -->
                <div id="character-tab" class="tab-content hidden">
                    <div class="section">
                        <h3>ğŸ‘¤ è§’è‰²ç·¨è¼¯</h3>
                        <div id="character-editor">
                            <div class="input-group">
                                <label>è§’è‰²åç¨±ï¼š</label>
                                <input type="text" id="char-name" placeholder="è«‹è¼¸å…¥è§’è‰²åç¨±">
                            </div>
                            <div class="input-group">
                                <label>è§’è‰²å€‹æ€§ï¼š</label>
                                <textarea id="char-personality" rows="3" placeholder="æè¿°è§’è‰²çš„å€‹æ€§ç‰¹å¾µ..."></textarea>
                            </div>
                            <div class="input-group">
                                <label>èªªè©±èªæ°£ï¼š</label>
                                <input type="text" id="char-tone" placeholder="ä¾‹å¦‚ï¼šæº«å’Œã€æ´»æ½‘ã€åš´è‚…...">
                            </div>
                            <div class="input-group">
                                <label>è¡Œç‚ºç‰¹è‰²ï¼š</label>
                                <textarea id="char-behavior" rows="2" placeholder="æè¿°è§’è‰²çš„è¡Œç‚ºç¿’æ…£..."></textarea>
                            </div>
                            <button class="btn" onclick="saveCharacter()">ğŸ’¾ å„²å­˜è§’è‰²</button>
                            <button class="btn btn-secondary" onclick="clearCharacterForm()">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- å°èªªé è¦½å€ -->
                <div id="preview-tab" class="tab-content hidden">
                    <div class="section">
                        <h3>ğŸ“– å°èªªé è¦½</h3>
                        <div id="novel-preview" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 400px; font-family: serif; line-height: 1.8;">
                            <p style="text-align: center; color: #666;">å°èªªå…§å®¹æœƒåœ¨é€™è£¡é¡¯ç¤º...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let characters = [];
        let dialogues = [];
        let currentEditingCharacter = null;
        let protagonistId = null;
        let apiKeyMemory = null; // æš«æ™‚å„²å­˜API Keyåœ¨è¨˜æ†¶é«”ä¸­
        let characterMemories = {}; // æ¯å€‹è§’è‰²çš„è¨˜æ†¶åº«
        let currentScene = { // ç•¶å‰å ´æ™¯ç‹€æ…‹
            location: 'å®¤å…§',
            timeOfDay: 'ç™½å¤©',
            weather: 'æ™´æœ—',
            atmosphere: 'å¹³éœ',
            established: false
        };

        // é è¨­è§’è‰²ç¯„æœ¬
        const characterTemplates = [
            {
                name: "è‰¾è‰çµ²",
                personality: "è°æ˜æ©Ÿæ™ºï¼Œæœ‰é»ä»»æ€§ä½†å–„è‰¯",
                tone: "æ´»æ½‘ç›´æ¥ï¼Œå¶çˆ¾æœƒæœ‰é»å°å‚²å¬Œ",
                behavior: "å–œæ­¡æ€è€ƒå•é¡Œï¼Œç¶“å¸¸åšå‡ºæ„å¤–çš„æ±ºå®š"
            },
            {
                name: "é›·æ©",
                personality: "æ²‰ç©©å¯é ï¼Œå…§å¿ƒæº«æŸ”",
                tone: "èªªè©±æº«å’Œä½†å …å®š",
                behavior: "ç¸½æ˜¯å„ªå…ˆè€ƒæ…®ä»–äººï¼Œç¿’æ…£é»˜é»˜æ‰¿æ“”è²¬ä»»"
            },
            {
                name: "æ—ç™½è€…",
                personality: "å®¢è§€å†·éœï¼Œç„¡æ‰€ä¸çŸ¥",
                tone: "ä¸­æ€§æ•˜è¿°ï¼Œå¶çˆ¾å¸¶æœ‰è©©æ„",
                behavior: "è² è²¬å ´æ™¯æè¿°å’Œæƒ…ç¯€æ¨é€²"
            }
        ];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacterTemplates();
            updateCharacterList();
            updateSpeakerSelect();
            
            // è¨­å®šä¸»è§’é¸æ“‡ç›£è½å™¨
            document.getElementById('protagonist-select').addEventListener('change', function() {
                protagonistId = this.value;
                console.log('ä¸»è§’è¨­å®šç‚º:', protagonistId);
                // é‡æ–°é¡¯ç¤ºæ‰€æœ‰å°è©±ä»¥æ›´æ–°æ¨£å¼
                refreshChatDisplay();
            });

            // API Keyå®‰å…¨è™•ç†
            setupAPIKeySecurity();
        });

        // API Keyå®‰å…¨è¨­å®š
        function setupAPIKeySecurity() {
            const apiKeyInput = document.getElementById('api-key');
            const saveCheckbox = document.getElementById('save-api-key');

            // è¼‰å…¥æš«å­˜çš„API Keyï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const tempKey = sessionStorage.getItem('temp_api_key');
            if (tempKey) {
                apiKeyInput.value = tempKey;
                saveCheckbox.checked = true;
            }

            // ç›£è½API Keyè¼¸å…¥è®ŠåŒ–
            apiKeyInput.addEventListener('input', function() {
                apiKeyMemory = this.value;
                
                if (saveCheckbox.checked && this.value) {
                    // åªåœ¨ç•¶å‰ç€è¦½å™¨æœƒè©±ä¸­æš«å­˜
                    sessionStorage.setItem('temp_api_key', this.value);
                } else {
                    // æ¸…é™¤æš«å­˜
                    sessionStorage.removeItem('temp_api_key');
                }
            });

            // ç›£è½å„²å­˜é¸é …è®ŠåŒ–
            saveCheckbox.addEventListener('change', function() {
                if (this.checked && apiKeyInput.value) {
                    sessionStorage.setItem('temp_api_key', apiKeyInput.value);
                    showSecurityTip('API Keyå·²æš«æ™‚å„²å­˜åˆ°æœ¬åœ°ç€è¦½å™¨');
                } else {
                    sessionStorage.removeItem('temp_api_key');
                    showSecurityTip('API Keyæš«å­˜å·²æ¸…é™¤');
                }
            });

            // é é¢é—œé–‰æ™‚æ¸…é™¤æ•æ„Ÿè³‡æ–™
            window.addEventListener('beforeunload', function() {
                if (!saveCheckbox.checked) {
                    apiKeyMemory = null;
                    sessionStorage.removeItem('temp_api_key');
                }
            });
        }

        // é¡¯ç¤ºå®‰å…¨æç¤º
        function showSecurityTip(message) {
            const tip = document.createElement('div');
            tip.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4facfe;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            tip.textContent = message;
            document.body.appendChild(tip);

            setTimeout(() => {
                tip.remove();
            }, 3000);
        }

        // åˆå§‹åŒ–è§’è‰²è¨˜æ†¶
        function initializeCharacterMemory(characterId) {
            if (!characterMemories[characterId]) {
                characterMemories[characterId] = {
                    spokenLines: new Set(), // èªªéçš„è©±
                    conversationHistory: [], // å°è©±æ­·å²
                    mood: 'neutral', // ç•¶å‰æƒ…ç·’ç‹€æ…‹
                    topics: new Set() // è¨è«–éçš„è©±é¡Œ
                };
            }
        }

        // æ›´æ–°è§’è‰²è¨˜æ†¶
        function updateCharacterMemory(characterId, content, context) {
            initializeCharacterMemory(characterId);
            const memory = characterMemories[characterId];
            
            memory.spokenLines.add(content);
            memory.conversationHistory.push({
                content: content,
                timestamp: new Date(),
                context: context
            });
            
            // ä¿æŒè¨˜æ†¶åº«å¤§å°åˆç†ï¼ˆæœ€å¤šä¿ç•™20æ¢è¨˜éŒ„ï¼‰
            if (memory.conversationHistory.length > 20) {
                memory.conversationHistory.shift();
            }
        }

        // æª¢æŸ¥è§’è‰²æ˜¯å¦èªªéé¡ä¼¼çš„è©±
        function hasCharacterSaidSimilar(characterId, content) {
            if (!characterMemories[characterId]) return false;
            
            const memory = characterMemories[characterId];
            const contentLower = content.toLowerCase();
            
            for (let spokenLine of memory.spokenLines) {
                const similarity = calculateSimilarity(contentLower, spokenLine.toLowerCase());
                if (similarity > 0.7) return true; // 70%ç›¸ä¼¼åº¦è¦–ç‚ºé‡è¤‡
            }
            return false;
        }

        // è¨ˆç®—æ–‡å­—ç›¸ä¼¼åº¦
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // Levenshteinè·é›¢ç®—æ³•
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // æ¨™ç±¤åˆ‡æ›
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„activeé¡
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // æ·»åŠ activeé¡åˆ°é»æ“Šçš„æ¨™ç±¤
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°é è¦½æ¨™ç±¤ï¼Œæ›´æ–°é è¦½å…§å®¹
            if (tabName === 'preview') {
                updateNovelPreview();
            }
        }

        // è™•ç†Enteréµç™¼é€
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                addDialogue();
            }
        }

        // è¼‰å…¥è§’è‰²ç¯„æœ¬
        function loadCharacterTemplates() {
            console.log('è¼‰å…¥è§’è‰²ç¯„æœ¬...'); // é™¤éŒ¯ç”¨
            characterTemplates.forEach(template => {
                characters.push({...template, id: Date.now() + Math.random()});
            });
            console.log('ç¯„æœ¬è¼‰å…¥å®Œæˆï¼Œè§’è‰²æ•¸é‡:', characters.length); // é™¤éŒ¯ç”¨
        }

        // æ›´æ–°è§’è‰²åˆ—è¡¨é¡¯ç¤º
        function updateCharacterList() {
            const listContainer = document.querySelector('.character-list');
            listContainer.innerHTML = '';
            
            characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'character-item';
                li.innerHTML = `
                    <div class="character-name">${char.name}</div>
                    <div class="character-desc">${char.personality}</div>
                    <div style="margin-top: 8px;">
                        <button class="btn" style="font-size: 12px; padding: 5px 10px;" onclick="editCharacter('${char.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;" onclick="deleteCharacter('${char.id}')">åˆªé™¤</button>
                    </div>
                `;
                listContainer.appendChild(li);
            });
        }

        // æ›´æ–°èªªè©±è€…é¸æ“‡
        function updateSpeakerSelect() {
            const select = document.getElementById('speaker-select');
            const protagonistSelect = document.getElementById('protagonist-select');
            
            select.innerHTML = '<option value="">é¸æ“‡èªªè©±è€…</option>';
            protagonistSelect.innerHTML = '<option value="">é¸æ“‡ä¸»è§’</option>';
            
            console.log('æ›´æ–°èªªè©±è€…é¸æ“‡ï¼Œè§’è‰²æ•¸é‡:', characters.length); // é™¤éŒ¯ç”¨
            
            characters.forEach(char => {
                // èªªè©±è€…é¸æ“‡
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = char.name;
                select.appendChild(option);
                
                // ä¸»è§’é¸æ“‡
                const protagonistOption = document.createElement('option');
                protagonistOption.value = char.id;
                protagonistOption.textContent = char.name;
                protagonistSelect.appendChild(protagonistOption);
                
                console.log('æ–°å¢é¸é …:', char.name, 'ID:', char.id); // é™¤éŒ¯ç”¨
            });
        }

        // é¡¯ç¤ºæ–°å¢è§’è‰²è¡¨å–®
        function showCreateCharacter() {
            switchTab('character');
            clearCharacterForm();
        }

        // å„²å­˜è§’è‰²
        function saveCharacter() {
            const name = document.getElementById('char-name').value;
            const personality = document.getElementById('char-personality').value;
            const tone = document.getElementById('char-tone').value;
            const behavior = document.getElementById('char-behavior').value;

            if (!name) {
                alert('è«‹è¼¸å…¥è§’è‰²åç¨±ï¼');
                return;
            }

            const character = {
                id: currentEditingCharacter || Date.now() + Math.random(),
                name,
                personality,
                tone,
                behavior
            };

            if (currentEditingCharacter) {
                // ç·¨è¼¯ç¾æœ‰è§’è‰²
                const index = characters.findIndex(c => c.id === currentEditingCharacter);
                characters[index] = character;
            } else {
                // æ–°å¢è§’è‰²
                characters.push(character);
            }

            updateCharacterList();
            updateSpeakerSelect();
            clearCharacterForm();
            alert('è§’è‰²å·²å„²å­˜ï¼');
        }

        // æ¸…é™¤è§’è‰²è¡¨å–®
        function clearCharacterForm() {
            document.getElementById('char-name').value = '';
            document.getElementById('char-personality').value = '';
            document.getElementById('char-tone').value = '';
            document.getElementById('char-behavior').value = '';
            currentEditingCharacter = null;
        }

        // ç·¨è¼¯è§’è‰²
        function editCharacter(id) {
            const character = characters.find(c => c.id === id);
            if (character) {
                currentEditingCharacter = id;
                document.getElementById('char-name').value = character.name;
                document.getElementById('char-personality').value = character.personality;
                document.getElementById('char-tone').value = character.tone;
                document.getElementById('char-behavior').value = character.behavior;
                switchTab('character');
            }
        }

        // åˆªé™¤è§’è‰²
        function deleteCharacter(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å—ï¼Ÿ')) {
                characters = characters.filter(c => c.id !== id);
                updateCharacterList();
                updateSpeakerSelect();
            }
        }

        // å®‰å…¨ç²å–API Key
        function getAPIKey() {
            const inputKey = document.getElementById('api-key').value;
            return inputKey || apiKeyMemory;
        }

        // æ–°å¢å°è©±æ™‚æ›´æ–°è§’è‰²è¨˜æ†¶
        function addDialogue() {
            const speakerId = document.getElementById('speaker-select').value;
            const content = document.getElementById('dialogue-input').value.trim();

            console.log('ç™¼é€å°è©± - èªªè©±è€…ID:', speakerId, 'å…§å®¹:', content);

            if (!speakerId) {
                alert('è«‹å…ˆé¸æ“‡èªªè©±è€…ï¼');
                return;
            }

            if (!content) {
                alert('è«‹è¼¸å…¥å°è©±å…§å®¹ï¼');
                return;
            }

            const speaker = characters.find(c => c.id == speakerId);
            
            if (!speaker) {
                alert('æ‰¾ä¸åˆ°é¸æ“‡çš„è§’è‰²ï¼');
                return;
            }

            // æ›´æ–°è§’è‰²è¨˜æ†¶
            updateCharacterMemory(speakerId, content, 'æ‰‹å‹•è¼¸å…¥');

            const dialogue = {
                type: 'dialogue',
                speaker: speaker.name,
                speakerId: speakerId,
                content: content,
                timestamp: new Date()
            };

            dialogues.push(dialogue);
            displayDialogue(dialogue);
            document.getElementById('dialogue-input').value = '';
            
            console.log('å°è©±å·²æ–°å¢:', dialogue);
        }

        // æ–°å¢æ—ç™½
        function addNarrator() {
            const content = prompt('è«‹è¼¸å…¥æ—ç™½å…§å®¹ï¼š');
            if (content) {
                const narrator = {
                    type: 'narrator',
                    content: content,
                    timestamp: new Date()
                };
                dialogues.push(narrator);
                displayNarrator(narrator);
            }
        }

        // é¡¯ç¤ºå°è©±
        function displayDialogue(dialogue) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºä¸»è§’
            const isProtagonist = protagonistId && dialogue.speakerId == protagonistId;
            messageDiv.className = isProtagonist ? 'message protagonist' : 'message other';
            
            messageDiv.innerHTML = `
                <div class="message-header">${dialogue.speaker}</div>
                ${dialogue.content}
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // é¡¯ç¤ºæ—ç™½
        function displayNarrator(narrator) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message narrator';
            messageDiv.innerHTML = narrator.content; // ç§»é™¤æ—ç™½æ¨™é¡Œ
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // AIç”Ÿæˆå°è©±
        function generateAIDialogue() {
            const apiKey = getAPIKey();
            if (!apiKey) {
                alert('è«‹å…ˆè¼¸å…¥OpenRouter API Keyï¼\n\nğŸ”’ å®‰å…¨æç¤ºï¼š\nâ€¢ API Keyåªæœƒæš«æ™‚å„²å­˜åœ¨è¨˜æ†¶é«”ä¸­\nâ€¢ ä¸æœƒè¢«ä¿å­˜åˆ°æª”æ¡ˆæˆ–åˆ†äº«çµ¦ä»–äºº\nâ€¢ é—œé–‰ç€è¦½å™¨å¾Œæœƒè‡ªå‹•æ¸…é™¤\n\nğŸ“ å» openrouter.ai å–å¾—API Key');
                return;
            }
            
            // é¡¯ç¤ºAIæ§åˆ¶é¢æ¿
            document.getElementById('ai-controls').style.display = 'block';
            updateCharacterCheckboxes();
        }

        // ç”Ÿæˆå ´æ™¯
        function generateAIScene() {
            const apiKey = getAPIKey();
            if (!apiKey) {
                alert('è«‹å…ˆè¼¸å…¥OpenRouter API Keyï¼');
                return;
            }
            
            generateSceneDescription();
        }

        // æ¨¡å¼2ï¼šè‡ªå‹•ç”Ÿæˆå®Œæ•´å°èªªï¼ˆä¿®å¾©ç‰ˆï¼‰
        function generateFullNovel() {
            document.getElementById('novel-generation').style.display = 'block';
        }

        // é–‹å§‹å°èªªç”Ÿæˆï¼ˆä¿®å¾©ç‰ˆï¼‰
        async function startNovelGeneration() {
            const outline = document.getElementById('novel-outline').value;
            const length = parseInt(document.getElementById('novel-length').value);
            
            // ç²å–çµå°¾é¢¨æ ¼
            const endingSelect = document.getElementById('novel-ending').value;
            const customEnding = document.getElementById('custom-ending').value;
            const ending = endingSelect === 'custom' ? customEnding : endingSelect;
            
            // ç²å–è§’è‰²æ•¸é‡
            const characterCountSelect = document.getElementById('character-count').value;
            const customCharacterCount = parseInt(document.getElementById('custom-character-count').value);
            const characterCount = characterCountSelect === 'custom' ? customCharacterCount : parseInt(characterCountSelect);

            // é©—è­‰è¾“å…¥
            if (!outline.trim()) {
                alert('è«‹è¼¸å…¥å°èªªå¤§ç¶±ï¼');
                return;
            }

            if (endingSelect === 'custom' && !customEnding.trim()) {
                alert('è«‹æè¿°ä½ æƒ³è¦çš„çµå°¾é¢¨æ ¼ï¼');
                return;
            }

            if (characterCountSelect === 'custom' && (!customCharacterCount || customCharacterCount < 1 || customCharacterCount > 10)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è§’è‰²æ•¸é‡ (1-10)ï¼');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ğŸ“š ç”Ÿæˆä¸­...è«‹ç¨å€™';
            btn.disabled = true;

            try {
                await generateNovelContent(outline, length, ending, characterCount);
                hideNovelGeneration();
                showSecurityTip('ğŸ“š å°èªªç”Ÿæˆå®Œæˆï¼');
            } catch (error) {
                console.error('å°èªªç”Ÿæˆå¤±æ•—:', error);
                alert('å°èªªç”Ÿæˆå¤±æ•—ï¼š' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ç”Ÿæˆå°èªªå…§å®¹
        async function generateNovelContent(outline, length, ending, characterCount) {
            const apiKey = getAPIKey();

            if (!apiKey) {
                alert('å°èªªè‡ªå‹•ç”Ÿæˆéœ€è¦API Keyï¼\n\nè«‹è¼¸å…¥OpenRouter API Keyå¾Œå†è©¦ã€‚');
                return;
            }

            // æ¸…ç©ºç¾æœ‰å°è©±
            if (confirm('ç”Ÿæˆæ–°å°èªªå°‡æ¸…ç©ºç¾æœ‰å…§å®¹ï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
                dialogues = [];
                characterMemories = {};
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
            } else {
                return;
            }

            // ç”Ÿæˆå°èªªçµæ§‹
            const novelStructure = await generateNovelStructure(apiKey, outline, length, ending, characterCount);
            
            // æ ¹æ“šçµæ§‹ç”Ÿæˆå…·é«”å…§å®¹
            await generateNovelSections(apiKey, novelStructure);
        }

        // ç”Ÿæˆå°èªªçµæ§‹
        async function generateNovelStructure(apiKey, outline, length, ending, characterCount) {
            const endingDescriptions = {
                happy: 'åœ“æ»¿çš„çµå±€ï¼Œæ‰€æœ‰å•é¡Œå¾—åˆ°è§£æ±º',
                open: 'é–‹æ”¾å¼çµå±€ï¼Œç•™çµ¦è®€è€…æƒ³åƒç©ºé–“',
                twist: 'æ„å¤–çš„è½‰æŠ˜ï¼Œé¡›è¦†è®€è€…é æœŸ',
                emotional: 'æ„Ÿäººçš„çµå±€ï¼Œè§¸å‹•äººå¿ƒ',
                cliffhanger: 'æ‡¸å¿µçµå±€ï¼Œç‚ºçºŒé›†é‹ªè·¯'
            };

            const prompt = `ä½ æ˜¯å°ˆæ¥­å°èªªç·¨åŠ‡ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚è¨­è¨ˆå°èªªçµæ§‹ï¼š

å¤§ç¶±ï¼š${outline}
ç›®æ¨™å­—æ•¸ï¼š${length}å­—
çµå°¾é¢¨æ ¼ï¼š${endingDescriptions[ending]}
ä¸»è¦è§’è‰²æ•¸ï¼š${characterCount}å€‹

è«‹ç”Ÿæˆå°èªªçµæ§‹ï¼ŒåŒ…å«ï¼š
1. è§’è‰²è¨­å®šï¼ˆ${characterCount}å€‹ä¸»è¦è§’è‰²çš„å§“åã€å€‹æ€§ã€èƒŒæ™¯ï¼‰
2. ç« ç¯€è¦åŠƒï¼ˆå»ºè­°åˆ†æˆ5-8å€‹ç« ç¯€ï¼‰
3. æ¯ç« é‡é»æƒ…ç¯€
4. å°è©±é‡é»åˆ†é…

æ ¼å¼ï¼š
è§’è‰²è¨­å®šï¼š
Aè§’è‰²ï¼š[å§“å] - [å€‹æ€§] - [èƒŒæ™¯]
Bè§’è‰²ï¼š[å§“å] - [å€‹æ€§] - [èƒŒæ™¯]
...

ç« ç¯€è¦åŠƒï¼š
ç¬¬ä¸€ç« ï¼š[æ¨™é¡Œ] - [é‡é»æƒ…ç¯€]
ç¬¬äºŒç« ï¼š[æ¨™é¡Œ] - [é‡é»æƒ…ç¯€]
...

åªè¼¸å‡ºçµæ§‹ï¼Œä¸è¦å…·é«”å°è©±å…§å®¹ã€‚`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-sonnet", // ç”¨æ›´å¼·çš„æ¨¡å‹ç”Ÿæˆçµæ§‹
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`çµæ§‹ç”Ÿæˆå¤±æ•—: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // æ ¹æ“šçµæ§‹ç”Ÿæˆå…·é«”ç« ç¯€
        async function generateNovelSections(apiKey, structure) {
            const chapters = structure.match(/ç¬¬.+ç« ï¼š.+/g) || [];
            
            showSecurityTip(`ğŸ“š é–‹å§‹ç”Ÿæˆ ${chapters.length} å€‹ç« ç¯€...`);

            for (let i = 0; i < chapters.length; i++) {
                const chapterTitle = chapters[i];
                
                showSecurityTip(`ğŸ“ æ­£åœ¨ç”Ÿæˆç¬¬ ${i + 1} ç« ...`);
                
                // ç”Ÿæˆç« ç¯€æ¨™é¡Œæ—ç™½
                const titleNarrator = {
                    type: 'narrator',
                    content: `=== ${chapterTitle} ===`,
                    timestamp: new Date(),
                    generated: true,
                    isChapterTitle: true
                };
                dialogues.push(titleNarrator);
                displayNarrator(titleNarrator);

                // ç”Ÿæˆè©²ç« ç¯€çš„å°è©±å’Œæ—ç™½
                await generateChapterContent(apiKey, structure, chapterTitle, i + 1);
                
                // æ·»åŠ ç« ç¯€é–“éš”
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // ç”Ÿæˆç« ç¯€å…§å®¹
        async function generateChapterContent(apiKey, structure, chapterTitle, chapterNumber) {
            const prompt = `æ ¹æ“šä»¥ä¸‹å°èªªçµæ§‹ï¼Œç”Ÿæˆå…·é«”çš„ç« ç¯€å…§å®¹ï¼š

å°èªªçµæ§‹ï¼š
${structure}

ç•¶å‰ç« ç¯€ï¼š${chapterTitle}

è«‹ç”Ÿæˆé€™å€‹ç« ç¯€çš„å…·é«”å…§å®¹ï¼ŒåŒ…å«ï¼š
1. 3-5æ®µå°è©±ï¼ˆè§’è‰²åï¼šå°è©±å…§å®¹ï¼‰
2. 2-3æ®µæ—ç™½æè¿°ï¼ˆå ´æ™¯ã€æƒ…æ„Ÿã€å‹•ä½œç­‰ï¼‰
3. å…§å®¹è¦æ¨é€²åŠ‡æƒ…ï¼Œç¬¦åˆç« ç¯€ä¸»é¡Œ
4. å°è©±è¦ç¬¦åˆè§’è‰²å€‹æ€§
5. ç¸½å­—æ•¸æ§åˆ¶åœ¨800-1200å­—

æ ¼å¼ï¼š
æ—ç™½ï¼š[å ´æ™¯æè¿°]
è§’è‰²åï¼š[å°è©±å…§å®¹]
æ—ç™½ï¼š[æƒ…ç¯€æè¿°]
è§’è‰²åï¼š[å°è©±å…§å®¹]
...

ç›´æ¥è¼¸å‡ºå…§å®¹ï¼Œä¸è¦å…¶ä»–èªªæ˜ã€‚`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-haiku",
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 1500,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                console.error(`ç¬¬${chapterNumber}ç« ç”Ÿæˆå¤±æ•—`);
                return;
            }

            const data = await response.json();
            const chapterContent = data.choices[0].message.content;

            // è§£æä¸¦æ·»åŠ ç« ç¯€å…§å®¹
            await parseAndAddChapterContent(chapterContent);
        }

        // è§£æç« ç¯€å…§å®¹
        async function parseAndAddChapterContent(content) {
            const lines = content.split('\n').filter(line => line.trim());

            for (const line of lines) {
                if (line.startsWith('æ—ç™½ï¼š')) {
                    const narratorContent = line.replace('æ—ç™½ï¼š', '').trim();
                    const narrator = {
                        type: 'narrator',
                        content: narratorContent,
                        timestamp: new Date(),
                        generated: true,
                        novelGenerated: true
                    };
                    dialogues.push(narrator);
                    displayNarrator(narrator);
                    
                } else {
                    const match = line.match(/^(.+?)ï¼š(.+)$/);
                    if (match) {
                        const speakerName = match[1].trim();
                        const dialogueContent = match[2].trim();
                        
                        const dialogue = {
                            type: 'dialogue',
                            speaker: speakerName,
                            speakerId: 'novel_' + speakerName, // å°èªªç”Ÿæˆçš„è§’è‰²ID
                            content: dialogueContent,
                            timestamp: new Date(),
                            generated: true,
                            novelGenerated: true
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                    }
                }
                
                // æ·»åŠ å»¶é²æ•ˆæœ
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // éš±è—å°èªªç”Ÿæˆé¢æ¿
        function hideNovelGeneration() {
            document.getElementById('novel-generation').style.display = 'none';
        }

        // é–‹å§‹AIç”Ÿæˆï¼ˆæ¥å…¥OpenRouter APIï¼‰
        async function startAIGeneration() {
            const apiKey = getAPIKey();
            const context = document.getElementById('scene-context').value;
            const style = document.getElementById('dialogue-style').value;
            const count = parseInt(document.getElementById('generation-count').value) || 2;
            
            // ç²å–é¸ä¸­çš„è§’è‰²
            const checkboxes = document.querySelectorAll('#character-checkboxes input[type="checkbox"]:checked');
            const selectedCharacters = Array.from(checkboxes).map(cb => {
                const charId = cb.value;
                return characters.find(c => c.id == charId);
            }).filter(Boolean);

            if (selectedCharacters.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡1å€‹è§’è‰²é€²è¡Œå°è©±ï¼');
                return;
            }

            // æª¢æŸ¥API Key
            if (!apiKey) {
                alert('è«‹å…ˆè¼¸å…¥OpenRouter API Keyï¼\n\næ²’æœ‰API Keyå°‡ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆã€‚');
                // ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆ
                return await simulateAIGeneration(selectedCharacters, context, style);
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ğŸ¤– AIæ€è€ƒä¸­...';
            btn.disabled = true;

            try {
                console.log('ä½¿ç”¨OpenRouter APIç”Ÿæˆå°è©±...');
                await generateWithOpenRouter(apiKey, selectedCharacters, context, style, count);
                hideAIControls();
                showSecurityTip('ğŸ¤– OpenRouter AIå°è©±ç”Ÿæˆå®Œæˆ');
                
            } catch (error) {
                console.error('OpenRouter APIéŒ¯èª¤:', error);
                console.log('APIå¤±æ•—ï¼Œæ”¹ç”¨æ¨¡æ“¬ç”Ÿæˆ...');
                
                // APIå¤±æ•—æ™‚ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆ
                await simulateAIGeneration(selectedCharacters, context, style);
                hideAIControls();
                showSecurityTip('ğŸ¤– APIå¤±æ•—ï¼Œå·²æ”¹ç”¨æ¨¡æ“¬ç”Ÿæˆ');
                
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ä½¿ç”¨OpenRouter APIç”Ÿæˆå°è©±ï¼ˆæ”¹é€²ç‰ˆï¼‰
        async function generateWithOpenRouter(apiKey, characters, context, style, count) {
            // å»ºæ§‹è§’è‰²æè¿°
            const characterDescriptions = characters.map(char => 
                `${char.name}ï¼šå€‹æ€§${char.personality}ï¼Œèªªè©±èªæ°£${char.tone}ï¼Œè¡Œç‚ºç‰¹è‰²${char.behavior}`
            ).join('\n');

            // ç²å–æœ€è¿‘çš„å°è©±æ­·å²ä¸¦åˆ†æ
            const recentDialogues = dialogues.slice(-3).map(d => {
                if (d.type === 'dialogue') {
                    return `${d.speaker}ï¼š${d.content}`;
                } else if (d.type === 'narrator') {
                    return `(å ´æ™¯ï¼š${d.content})`;
                }
                return '';
            }).filter(Boolean);

            // åˆ†ææœ€å¾Œä¸€å¥è©±ï¼Œåˆ¤æ–·éœ€è¦ä»€éº¼æ¨£çš„å›æ‡‰
            const lastDialogue = dialogues.length > 0 ? dialogues[dialogues.length - 1] : null;
            let contextHint = '';
            
            if (lastDialogue && lastDialogue.type === 'dialogue') {
                if (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?')) {
                    contextHint = '(å‰é¢æœ‰å•é¡Œéœ€è¦å›ç­”)';
                } else if (lastDialogue.content.includes('ã€‚') || lastDialogue.content.includes('ï¼')) {
                    contextHint = '(éœ€è¦å°å‰é¢çš„è©±åšå‡ºå›æ‡‰æˆ–å»¶çºŒè©±é¡Œ)';
                }
            }

            // é¢¨æ ¼èªªæ˜
            const styleDescriptions = {
                natural: 'è‡ªç„¶æ—¥å¸¸çš„å°è©±ï¼Œåƒæœ‹å‹é–“çš„è¼•é¬†èŠå¤©',
                dramatic: 'æˆ²åŠ‡åŒ–ã€å……æ»¿æƒ…æ„Ÿå’Œå¼µåŠ›çš„å°è©±',
                romantic: 'æº«é¦¨æµªæ¼«ã€å……æ»¿æ„Ÿæƒ…çš„å°è©±',
                humorous: 'è¼•é¬†å¹½é»˜ã€æ´»æ½‘æœ‰è¶£çš„å°è©±',
                tense: 'ç·Šå¼µåš´è‚…ã€å……æ»¿å£“åŠ›çš„å°è©±'
            };

            const prompt = `ä½ æ˜¯å°ˆæ¥­ç·¨åŠ‡ï¼Œè«‹ç”Ÿæˆç¬¦åˆè¦æ±‚çš„å°è©±ï¼š

== è§’è‰²è¨­å®š ==
${characterDescriptions}

== å°è©±æƒ…å¢ƒ ==
å ´æ™¯ï¼š${context || 'æ—¥å¸¸å ´æ™¯'}
é¢¨æ ¼ï¼š${styleDescriptions[style] || 'è‡ªç„¶å°è©±'}
${contextHint}

== æœ€è¿‘å°è©± ==
${recentDialogues.length > 0 ? recentDialogues.join('\n') : '(å°è©±é–‹å§‹)'}

== ç”Ÿæˆè¦æ±‚ ==
1. ç”Ÿæˆ${count}å¥é€£è²«çš„å°è©±
2. æ¯å¥éƒ½è¦ç¬¦åˆè§’è‰²å€‹æ€§
3. è¦å»¶çºŒå‰é¢çš„è©±é¡Œæˆ–åˆç†è½‰æ›
4. å¦‚æœå‰é¢æœ‰å•é¡Œè¦å›ç­”ï¼Œå¦‚æœæ˜¯é™³è¿°è¦å›æ‡‰
5. é¿å…é‡è¤‡å·²èªªéçš„å…§å®¹
6. å°è©±è¦è‡ªç„¶æµæš¢ï¼ŒåƒçœŸäººèŠå¤©

== è¼¸å‡ºæ ¼å¼ ==
è§’è‰²åï¼šå°è©±å…§å®¹
è§’è‰²åï¼šå°è©±å…§å®¹
(åªè¼¸å‡ºå°è©±ï¼Œä¸è¦å…¶ä»–èªªæ˜)`;

            try {
                console.log('ç™¼é€æ”¹é€²ç‰ˆAPIè«‹æ±‚...');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±'
                    },
                    body: JSON.stringify({
                        model: "anthropic/claude-3-haiku", // æ”¹ç”¨æ›´å¿«æ›´ä¾¿å®œçš„æ¨¡å‹
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 800,
                        temperature: 0.9, // æé«˜å‰µæ„æ€§
                        top_p: 0.95,
                        stream: false
                    })
                });

                console.log('APIå›æ‡‰ç‹€æ…‹:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIéŒ¯èª¤:', errorText);
                    throw new Error(`APIè«‹æ±‚å¤±æ•— (${response.status})`);
                }

                const data = await response.json();
                console.log('APIæˆåŠŸå›æ‡‰');
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIå›æ‡‰æ ¼å¼éŒ¯èª¤');
                }

                const generatedText = data.choices[0].message.content;
                console.log('ç”Ÿæˆå…§å®¹:', generatedText);

                // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å°è©±
                await parseAndAddGeneratedDialogue(generatedText, characters);

            } catch (error) {
                console.error('APIè«‹æ±‚å®Œå…¨å¤±æ•—:', error.message);
                throw error;
            }
        }

        // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å°è©±ï¼ˆæ”¹é€²ç‰ˆï¼‰
        async function parseAndAddGeneratedDialogue(text, availableCharacters) {
            const lines = text.split('\n').filter(line => line.trim());
            console.log('è§£æå°è©±è¡Œæ•¸:', lines.length);
            
            for (const line of lines) {
                // åŒ¹é…æ ¼å¼ï¼šè§’è‰²åç¨±ï¼šå°è©±å…§å®¹
                const match = line.match(/^(.+?)ï¼š(.+)$/);
                if (match) {
                    const speakerName = match[1].trim();
                    const content = match[2].trim();
                    
                    console.log('è§£æåˆ°å°è©± -', 'è§’è‰²:', speakerName, 'å…§å®¹:', content);
                    
                    // å°‹æ‰¾å°æ‡‰çš„è§’è‰²
                    const character = availableCharacters.find(char => 
                        char.name === speakerName || 
                        char.name.includes(speakerName) || 
                        speakerName.includes(char.name)
                    );
                    
                    if (character) {
                        // æ›´æ–°è§’è‰²è¨˜æ†¶
                        updateCharacterMemory(character.id, content, 'OpenRouterç”Ÿæˆ');
                        
                        const dialogue = {
                            type: 'dialogue',
                            speaker: character.name,
                            speakerId: character.id,
                            content: content,
                            timestamp: new Date(),
                            generated: true,
                            apiGenerated: true // æ¨™è¨˜ç‚ºçœŸå¯¦APIç”Ÿæˆ
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                        
                        console.log('å°è©±å·²æ·»åŠ :', dialogue);
                        
                        // æ·»åŠ å»¶é²è®“å°è©±é€ä¸€å‡ºç¾
                        await new Promise(resolve => setTimeout(resolve, 800));
                    } else {
                        console.warn('æ‰¾ä¸åˆ°åŒ¹é…çš„è§’è‰²:', speakerName);
                    }
                } else {
                    console.warn('ç„¡æ³•è§£æçš„å°è©±æ ¼å¼:', line);
                }
            }
        }

        // ä½¿ç”¨OpenRouter APIç”Ÿæˆå°è©±
        async function generateDialogueWithClaude(apiKey, characters, context, style) {
            // ä½¿ç”¨é è¨­çš„Claude 3 Sonnetæ¨¡å‹
            const selectedModel = "anthropic/claude-3-sonnet";
            
            // å»ºæ§‹è§’è‰²æè¿°
            const characterDescriptions = characters.map(char => 
                `${char.name}ï¼šå€‹æ€§${char.personality}ï¼Œèªªè©±èªæ°£${char.tone}ï¼Œè¡Œç‚ºç‰¹è‰²${char.behavior}`
            ).join('\n');

            // ç²å–æœ€è¿‘çš„å°è©±æ­·å²
            const recentDialogues = dialogues.slice(-5).map(d => {
                if (d.type === 'dialogue') {
                    return `${d.speaker}ï¼š${d.content}`;
                } else {
                    return `(${d.content})`;
                }
            }).join('\n');

            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å°è©±ç·¨åŠ‡ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¨­å®šç”Ÿæˆ2-3è¼ªè‡ªç„¶çš„å°è©±ï¼š

è§’è‰²è¨­å®šï¼š
${characterDescriptions}

å°è©±æƒ…å¢ƒï¼š${context || 'æ—¥å¸¸äº’å‹•'}
å°è©±é¢¨æ ¼ï¼š${style}

${recentDialogues ? `æœ€è¿‘å°è©±æ­·å²ï¼š\n${recentDialogues}\n` : ''}

è«‹ç”Ÿæˆç¬¦åˆå„è§’è‰²å€‹æ€§çš„å°è©±ï¼Œæ¯å€‹è§’è‰²è‡³å°‘èªªä¸€å¥è©±ã€‚æ ¼å¼ï¼š
è§’è‰²åç¨±ï¼šå°è©±å…§å®¹

è«‹ç›´æ¥è¼¸å‡ºå°è©±ï¼Œä¸è¦å…¶ä»–èªªæ˜ã€‚`;

            try {
                // ä½¿ç”¨ä»£ç†æœå‹™å™¨ä¾†é¿å…CORSå•é¡Œ
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = 'https://openrouter.ai/api/v1/chat/completions';
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.8,
                        top_p: 0.9,
                        stream: false
                    })
                });

                if (!response.ok) {
                    // å¦‚æœä»£ç†å¤±æ•—ï¼Œå˜—è©¦æ¨¡æ“¬ç”Ÿæˆ
                    console.warn('APIè«‹æ±‚å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆ');
                    return await simulateAIGeneration(characters, context, style);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIå›æ‡‰æ ¼å¼éŒ¯èª¤');
                }

                const generatedText = data.choices[0].message.content;
                console.log('AIç”Ÿæˆå…§å®¹:', generatedText);

                // è§£æç”Ÿæˆçš„å°è©±
                await parseAndAddGeneratedDialogue(generatedText, characters);

            } catch (error) {
                console.error('OpenRouter APIéŒ¯èª¤:', error);
                // ä½¿ç”¨æ¨¡æ“¬ç”Ÿæˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                console.log('ä½¿ç”¨æ¨¡æ“¬AIç”Ÿæˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ');
                await simulateAIGeneration(characters, context, style);
            }
        }

        // æ”¹é€²çš„æ¨¡æ“¬AIç”Ÿæˆï¼ˆæ›´é€£è²«ï¼‰
        async function simulateAIGeneration(characters, context, style) {
            console.log('ä½¿ç”¨æ”¹é€²ç‰ˆæ¨¡æ“¬ç”Ÿæˆï¼Œè§’è‰²:', characters.map(c => c.name));
            
            // åˆ†æç•¶å‰å°è©±æƒ…å¢ƒ
            const lastDialogue = dialogues.length > 0 ? dialogues[dialogues.length - 1] : null;
            const isQuestion = lastDialogue && lastDialogue.type === 'dialogue' && 
                             (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?'));
            
            // é€£è²«å°è©±ç”Ÿæˆç­–ç•¥
            for (let i = 0; i < Math.min(characters.length, 2); i++) {
                const character = characters[i];
                
                // åˆå§‹åŒ–è§’è‰²è¨˜æ†¶
                initializeCharacterMemory(character.id);
                
                // ç”Ÿæˆé€£è²«çš„å›æ‡‰
                const generatedContent = generateCoherentResponse(character, style, lastDialogue, isQuestion, i);
                
                if (generatedContent) {
                    // æ›´æ–°è§’è‰²è¨˜æ†¶
                    updateCharacterMemory(character.id, generatedContent, `æ¨¡æ“¬ç”Ÿæˆ-${style}`);
                    
                    const dialogue = {
                        type: 'dialogue',
                        speaker: character.name,
                        speakerId: character.id,
                        content: generatedContent,
                        timestamp: new Date(),
                        generated: true,
                        simulated: true
                    };
                    
                    dialogues.push(dialogue);
                    displayDialogue(dialogue);
                    
                    // æ›´æ–°æœ€å¾Œå°è©±å¼•ç”¨
                    lastDialogue = dialogue;
                    
                    // å»¶é²æ•ˆæœ
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            showSecurityTip('ğŸ¤– ä½¿ç”¨æ™ºèƒ½æ¨¡æ“¬ç”Ÿæˆ');
        }

        // ç”Ÿæˆé€£è²«å›æ‡‰
        function generateCoherentResponse(character, style, lastDialogue, isQuestion, order) {
            // é€£è²«å›æ‡‰åº«
            const coherentResponses = {
                è‰¾è‰çµ²: {
                    // å›ç­”å•é¡Œ
                    answer: {
                        natural: ["æˆ‘è¦ºå¾—æ˜¯é€™æ¨£...", "å—¯ï¼Œæ‡‰è©²æ˜¯...", "æˆ‘æƒ³å¯èƒ½æ˜¯...", "æ“šæˆ‘äº†è§£..."],
                        dramatic: ["æ²’éŒ¯ï¼å°±æ˜¯é€™æ¨£ï¼", "æˆ‘å¿…é ˆå‘Šè¨´ä½ çœŸç›¸ï¼", "é€™å€‹å•é¡Œå¾ˆé‡è¦ï¼"],
                        romantic: ["ä½ é€™æ¨£å•è®“æˆ‘å¾ˆé–‹å¿ƒ...", "æˆ‘å¾ˆæ¨‚æ„å‘Šè¨´ä½ ...", "å’Œä½ åˆ†äº«é€™å€‹çœŸå¥½..."],
                        humorous: ["å“ˆå“ˆï¼Œé€™å€‹å•é¡Œæœ‰æ„æ€ï¼", "è®“æˆ‘æƒ³æƒ³...æ‡‰è©²æ˜¯é€™æ¨£...", "ä½ å•å¾—çœŸå¦™ï¼"],
                        tense: ["é€™å€‹å•é¡Œå¾ˆé—œéµ...", "æˆ‘å¿…é ˆä»”ç´°å›ç­”...", "æƒ…æ³å¯èƒ½æ˜¯é€™æ¨£..."]
                    },
                    // å›æ‡‰é™³è¿°
                    respond: {
                        natural: ["ä½ èªªå¾—å°ã€‚", "æˆ‘ä¹Ÿé€™éº¼æƒ³ã€‚", "ç¢ºå¯¦æ˜¯é€™æ¨£ã€‚", "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚"],
                        dramatic: ["å®Œå…¨æ­£ç¢ºï¼", "ä½ èªªåˆ°é‡é»äº†ï¼", "å°±æ˜¯é€™æ¨£ï¼"],
                        romantic: ["ä½ ç¸½æ˜¯é€™éº¼é«”è²¼ã€‚", "å’Œä½ æƒ³æ³•ä¸€è‡´çœŸå¥½ã€‚", "ä½ ç†è§£æˆ‘çš„æ„Ÿå—ã€‚"],
                        humorous: ["å“ˆå“ˆï¼Œæˆ‘å€‘æƒ³åˆ°ä¸€èµ·äº†ï¼", "ä½ èªªå¾—å¤ªå°äº†ï¼", "è‹±é›„æ‰€è¦‹ç•¥åŒï¼"],
                        tense: ["ä½ èªªå¾—æ²’éŒ¯ã€‚", "æƒ…æ³ç¢ºå¯¦å¦‚æ­¤ã€‚", "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ“”æ†‚ã€‚"]
                    },
                    // é–‹å•Ÿæ–°è©±é¡Œ
                    initiate: {
                        natural: ["å°äº†ï¼Œæˆ‘æƒ³åˆ°ä¸€ä»¶äº‹...", "èªªåˆ°é€™å€‹...", "æˆ‘æƒ³å’Œä½ èŠèŠ..."],
                        dramatic: ["æˆ‘æœ‰é‡è¦çš„äº‹è¦èªªï¼", "ä½ ä¸€å®šè¦è½é€™å€‹ï¼"],
                        romantic: ["æˆ‘ä¸€ç›´æƒ³å‘Šè¨´ä½ ...", "æœ‰ä»¶äº‹æƒ³å’Œä½ åˆ†äº«..."],
                        humorous: ["ä½ çŸ¥é“ä¸€ä»¶æœ‰è¶£çš„äº‹å—ï¼Ÿ", "æˆ‘æƒ³åˆ°å€‹å¥½ç©çš„..."],
                        tense: ["æˆ‘å€‘éœ€è¦è«‡è«‡...", "æœ‰ä»¶äº‹è®“æˆ‘æ“”å¿ƒ..."]
                    }
                },
                é›·æ©: {
                    answer: {
                        natural: ["æˆ‘èªç‚º...", "æ ¹æ“šæˆ‘çš„ç¶“é©—...", "æ‡‰è©²æ˜¯é€™æ¨£...", "æˆ‘çš„çœ‹æ³•æ˜¯..."],
                        dramatic: ["äº‹å¯¦æ˜¯é€™æ¨£çš„ã€‚", "æˆ‘å¿…é ˆå‘Šè¨´ä½ ...", "çœŸç›¸åªæœ‰ä¸€å€‹ã€‚"],
                        romantic: ["æˆ‘å¾ˆæ¨‚æ„å›ç­”ã€‚", "èƒ½å’Œä½ è¨è«–é€™å€‹çœŸå¥½...", "ä½ å•å¾—å¾ˆå¥½..."],
                        humorous: ["é€™å€‹å•é¡Œä¸éŒ¯ã€‚", "è®“æˆ‘å¥½å¥½æƒ³æƒ³...", "ä½ ç¸½æ˜¯å•å¾—å¾ˆæœ‰è¶£ã€‚"],
                        tense: ["é€™å¾ˆè¤‡é›œ...", "æˆ‘å€‘éœ€è¦è¬¹æ…è€ƒæ…®...", "æƒ…æ³å¯èƒ½æ˜¯..."]
                    },
                    respond: {
                        natural: ["æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚", "ä½ åˆ†æå¾—å¾ˆå¥½ã€‚", "ç¢ºå¯¦å¦‚æ­¤ã€‚"],
                        dramatic: ["ä½ èªªå¾—å°ï¼Œæˆ‘å€‘å¿…é ˆè¡Œå‹•ã€‚", "æˆ‘å®Œå…¨åŒæ„ã€‚", "é€™æ­£æ˜¯é—œéµã€‚"],
                        romantic: ["ä½ çš„æƒ³æ³•å¾ˆæº«æš–ã€‚", "æˆ‘å¾ˆæ„Ÿæ¿€ä½ çš„åˆ†äº«ã€‚", "å’Œä½ ä¸€è‡´çœŸå¥½ã€‚"],
                        humorous: ["ä½ çš„è§€é»å¾ˆæœ‰è¶£ã€‚", "æˆ‘å–œæ­¡ä½ é€™æ¨£æƒ³ã€‚", "èªªå¾—å¥½ã€‚"],
                        tense: ["ä½ çš„æ“”æ†‚æ˜¯å°çš„ã€‚", "æˆ‘å€‘å¿…é ˆé‡è¦–é€™é»ã€‚", "æƒ…æ³ç¢ºå¯¦åš´é‡ã€‚"]
                    },
                    initiate: {
                        natural: ["æˆ‘æƒ³è¨è«–ä¸€ä¸‹...", "æœ‰ä»¶äº‹æƒ³å’Œä½ è«‡...", "é—œæ–¼..."],
                        dramatic: ["æˆ‘å€‘é¢è‡¨é‡è¦å•é¡Œã€‚", "æœ‰ä»¶äº‹å¿…é ˆå‘Šè¨´ä½ ã€‚"],
                        romantic: ["æˆ‘æƒ³å’Œä½ åˆ†äº«...", "æœ‰å€‹æƒ³æ³•æƒ³èªªçµ¦ä½ è½..."],
                        humorous: ["æƒ³èŠé»è¼•é¬†çš„å—ï¼Ÿ", "æˆ‘æƒ³åˆ°ä»¶æœ‰è¶£çš„äº‹..."],
                        tense: ["æˆ‘å€‘é¢è‡¨å•é¡Œ...", "æœ‰ä»¶äº‹è®“æˆ‘æ“”å¿ƒ..."]
                    }
                }
            };

            // æ±ºå®šå›æ‡‰é¡å‹
            let responseType = 'initiate';
            if (lastDialogue && lastDialogue.type === 'dialogue' && 
                lastDialogue.speakerId !== character.id) {
                if (isQuestion) {
                    responseType = 'answer';
                } else {
                    responseType = 'respond';
                }
            }

            // ç²å–é©åˆçš„å›æ‡‰
            const characterResponses = coherentResponses[character.name] || coherentResponses['è‰¾è‰çµ²'];
            const typeResponses = characterResponses[responseType] || characterResponses['respond'];
            const styleResponses = typeResponses[style] || typeResponses['natural'];

            // éæ¿¾å·²ä½¿ç”¨çš„å›æ‡‰
            const availableResponses = styleResponses.filter(response => 
                !hasCharacterSaidSimilar(character.id, response)
            );

            if (availableResponses.length === 0) {
                // å‚™ç”¨å›æ‡‰
                const fallbacks = ["æˆ‘æ˜ç™½ã€‚", "æ˜¯é€™æ¨£å•Šã€‚", "æˆ‘æƒ³ä¹Ÿæ˜¯ã€‚"];
                return fallbacks[order % fallbacks.length];
            }

            return availableResponses[order % availableResponses.length];
        }

        // ç°¡åŒ–çš„å°è©±ç”Ÿæˆ
        function generateSimpleResponse(character, style, lastDialogue, order) {
            // åŸºç¤å°è©±åº«
            const dialogueBank = {
                è‰¾è‰çµ²: {
                    natural: [
                        "æˆ‘è¦ºå¾—é€™å€‹æƒ³æ³•ä¸éŒ¯ã€‚",
                        "ä½ èªªå¾—å°å‘¢ï¼",
                        "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ„Ÿè¦ºã€‚",
                        "é€™æ¨£æƒ³å¾ˆæœ‰æ„æ€ã€‚",
                        "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚",
                        "ç¢ºå¯¦æ˜¯é€™æ¨£çš„ã€‚",
                        "æˆ‘å€‘æƒ³åˆ°ä¸€èµ·å»äº†ã€‚",
                        "é€™å€‹è§€é»å¾ˆæ£’ã€‚"
                    ],
                    dramatic: [
                        "é€™çœŸçš„å¤ªé©šäººäº†ï¼",
                        "æˆ‘å®Œå…¨æ²’æƒ³åˆ°æœƒé€™æ¨£ï¼",
                        "é€™æ”¹è®Šäº†ä¸€åˆ‡ï¼",
                        "å¤ªä¸å¯æ€è­°äº†ï¼",
                        "æˆ‘å€‘å¿…é ˆè¡Œå‹•èµ·ä¾†ï¼",
                        "é€™æ˜¯é—œéµæ™‚åˆ»ï¼",
                        "æƒ…æ³æ¯”æƒ³åƒçš„åš´é‡ï¼",
                        "æˆ‘å€‘ä¸èƒ½è¢–æ‰‹æ—è§€ï¼"
                    ],
                    romantic: [
                        "å’Œä½ èŠå¤©çœŸçš„å¾ˆé–‹å¿ƒã€‚",
                        "ä½ ç¸½æ˜¯é€™éº¼é«”è²¼ã€‚",
                        "é€™ç¨®æ„Ÿè¦ºå¾ˆæº«æš–ã€‚",
                        "æœ‰ä½ çœŸå¥½ã€‚",
                        "ä½ çš„è©±è®“æˆ‘å¾ˆæ„Ÿå‹•ã€‚",
                        "å’Œä½ åœ¨ä¸€èµ·å¾ˆèˆ’æœã€‚",
                        "ä½ ç†è§£æˆ‘çš„æƒ³æ³•ã€‚",
                        "è¬è¬ä½ çš„é™ªä¼´ã€‚"
                    ],
                    humorous: [
                        "å“ˆå“ˆï¼Œä½ çœŸå¹½é»˜ï¼",
                        "é€™å€‹æƒ³æ³•å¤ªæœ‰è¶£äº†ï¼",
                        "æˆ‘éƒ½è¦ç¬‘æ­»äº†ï¼",
                        "ä½ ç¸½æ˜¯é€™éº¼æç¬‘ã€‚",
                        "ç”Ÿæ´»å°±è¦é€™æ¨£è¼•é¬†ï¼",
                        "ä½ çš„ç¬‘è©±çœŸæ£’ï¼",
                        "æˆ‘å€‘çœŸæœƒè‡ªå¨›è‡ªæ¨‚ã€‚",
                        "å¤ªå¥½ç©äº†ï¼"
                    ],
                    tense: [
                        "æƒ…æ³æœ‰äº›è¤‡é›œã€‚",
                        "æˆ‘å€‘å¾—å°å¿ƒè™•ç†ã€‚",
                        "é€™è®“æˆ‘æœ‰é»æ“”å¿ƒã€‚",
                        "æˆ‘å€‘éœ€è¦æƒ³å€‹è¾¦æ³•ã€‚",
                        "æ™‚é–“å¯èƒ½ä¸å¤šäº†ã€‚",
                        "æƒ…æ³ä¸å¤ªæ¨‚è§€ã€‚",
                        "æˆ‘å€‘å¿…é ˆè¬¹æ…è¡Œäº‹ã€‚",
                        "é€™çœŸè®“äººç·Šå¼µã€‚"
                    ]
                },
                é›·æ©: {
                    natural: [
                        "æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚",
                        "é€™ç¢ºå¯¦æ˜¯å€‹å¥½è§€é»ã€‚",
                        "æˆ‘å€‘å¯ä»¥ä»”ç´°è€ƒæ…®ä¸€ä¸‹ã€‚",
                        "ä½ åˆ†æå¾—å¾ˆæœ‰é“ç†ã€‚",
                        "æˆ‘ä¹Ÿæ˜¯é€™æ¨£èªç‚ºçš„ã€‚",
                        "é€™å€‹æƒ³æ³•å€¼å¾—æ·±æ€ã€‚",
                        "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚",
                        "ä½ èªªå¾—å¾ˆä¸­è‚¯ã€‚"
                    ],
                    dramatic: [
                        "æˆ‘æœƒæ‰¿æ“”èµ·è²¬ä»»ã€‚",
                        "æˆ‘å€‘å¿…é ˆå‹‡æ•¢é¢å°ã€‚",
                        "é€™æ˜¯æˆ‘å€‘çš„ä½¿å‘½ã€‚",
                        "æˆ‘ä¸æœƒè®“ä½ å¤±æœ›ã€‚",
                        "è®“æˆ‘ä¾†ä¿è­·å¤§å®¶ã€‚",
                        "æˆ‘å€‘ä¸€èµ·å…‹æœå›°é›£ã€‚",
                        "é€™æ˜¯æ­£ç¢ºçš„é¸æ“‡ã€‚",
                        "æˆ‘å€‘çµ•ä¸èƒ½æ”¾æ£„ã€‚"
                    ],
                    romantic: [
                        "èƒ½å’Œä½ åˆ†äº«é€™äº›çœŸå¥½ã€‚",
                        "ä½ çš„æƒ³æ³•ç¸½æ˜¯å¾ˆæº«æš–ã€‚",
                        "æˆ‘å¾ˆçæƒœé€™æ¨£çš„æ™‚å…‰ã€‚",
                        "å’Œä½ åœ¨ä¸€èµ·å¾ˆå®‰å¿ƒã€‚",
                        "ä½ è®“æˆ‘æ„Ÿåˆ°å¾ˆå¹¸ç¦ã€‚",
                        "é€™ç¨®æ„Ÿè¦ºå¾ˆç¾å¥½ã€‚",
                        "æˆ‘å¾ˆæ„Ÿæ¿€æœ‰ä½ é™ªä¼´ã€‚",
                        "ä½ æ˜¯æˆ‘é‡è¦çš„äººã€‚"
                    ],
                    humorous: [
                        "ä½ çš„å¹½é»˜æ„Ÿå¾ˆä¸éŒ¯ã€‚",
                        "é€™æ¨£æƒ³ç¢ºå¯¦æœ‰è¶£ã€‚",
                        "ä½ ç¸½èƒ½å¸¶ä¾†æ­¡æ¨‚ã€‚",
                        "æˆ‘å€‘åˆ¥å¤ªåš´è‚…äº†ã€‚",
                        "è¼•é¬†ä¸€é»ä¹Ÿå¥½ã€‚",
                        "ä½ èªªå¾—å°ï¼Œè¦æ¨‚è§€ã€‚",
                        "é€™æ¨£æƒ³å¿ƒæƒ…æœƒæ›´å¥½ã€‚",
                        "è¬è¬ä½ è®“æˆ‘é–‹å¿ƒã€‚"
                    ],
                    tense: [
                        "æˆ‘å€‘éœ€è¦å†·éœåˆ†æã€‚",
                        "è®“æˆ‘ä¾†æƒ³æƒ³è¾¦æ³•ã€‚",
                        "æˆ‘å€‘å¿…é ˆä¿æŒç†æ€§ã€‚",
                        "ç›¸ä¿¡æˆ‘ï¼Œæœƒæœ‰è§£æ±ºæ–¹æ¡ˆã€‚",
                        "æˆ‘å€‘ä¸€æ­¥æ­¥ä¾†è™•ç†ã€‚",
                        "å…ˆä¸è¦å¤ªæ“”å¿ƒã€‚",
                        "æˆ‘æœƒæƒ³è¾¦æ³•çš„ã€‚",
                        "æˆ‘å€‘ä¸€èµ·è§£æ±ºé€™å€‹å•é¡Œã€‚"
                    ]
                },
                æ—ç™½è€…: {
                    natural: ["æ™‚å…‰åœ¨å°è©±ä¸­éœéœæµæ·Œã€‚", "æˆ¿é–“è£¡æ°£æ°›æº«é¦¨å’Œè«§ã€‚", "é™½å…‰é€éçª—æˆ¶ç‘é€²ä¾†ã€‚"],
                    dramatic: ["ç©ºæ°£ä¸­ç€°æ¼«è‘—ç·Šå¼µæ°£æ¯ã€‚", "é—œéµæ™‚åˆ»å³å°‡åˆ°ä¾†ã€‚", "æƒ…æ³è®Šå¾—è¶Šä¾†è¶Šç·Šæ€¥ã€‚"],
                    romantic: ["æº«é¦¨çš„æ°£æ°›åŒ…åœè‘—å…©äººã€‚", "ç¾å¥½çš„æ™‚å…‰åœ¨ç¹¼çºŒã€‚", "æ„›æ„åœ¨ç©ºä¸­æµæ·Œã€‚"],
                    humorous: ["æ­¡è²ç¬‘èªå……æ»¿æˆ¿é–“ã€‚", "å¿«æ¨‚çš„æ°£æ°›æ„ŸæŸ“è‘—æ¯å€‹äººã€‚", "è¼•é¬†çš„æ™‚å…‰çœŸç¾å¥½ã€‚"],
                    tense: ["ç·Šå¼µçš„æ°£æ°›è¶Šä¾†è¶Šæ¿ƒã€‚", "å±æ©Ÿæ„Ÿé€æ¼¸åŠ é‡ã€‚", "æ¯å€‹äººéƒ½æ„Ÿåˆ°å£“åŠ›ã€‚"]
                }
            };

            // ç²å–è§’è‰²å°è©±é¸é …
            const characterDialogues = dialogueBank[character.name] || dialogueBank['è‰¾è‰çµ²'];
            const styleDialogues = characterDialogues[style] || characterDialogues['natural'];
            
            // éæ¿¾å·²ä½¿ç”¨çš„å°è©±
            const availableDialogues = styleDialogues.filter(content => 
                !hasCharacterSaidSimilar(character.id, content)
            );

            // å¦‚æœæ²’æœ‰å¯ç”¨å°è©±ï¼Œä½¿ç”¨å‚™ç”¨
            if (availableDialogues.length === 0) {
                const fallbacks = ["æˆ‘æ˜ç™½äº†ã€‚", "æ˜¯é€™æ¨£å•Šã€‚", "æˆ‘æƒ³ä¹Ÿæ˜¯ã€‚", "æœ‰é“ç†ã€‚"];
                return fallbacks[order % fallbacks.length];
            }

            // ç°¡å–®çš„é€£è²«æ€§è™•ç†
            let selectedIndex = order;
            
            // å¦‚æœå‰é¢æœ‰å°è©±ï¼Œå˜—è©¦åšå‡ºç›¸é—œå›æ‡‰
            if (lastDialogue && lastDialogue.type === 'dialogue' && lastDialogue.speakerId !== character.id) {
                // å¦‚æœå‰é¢æ˜¯å•é¡Œï¼Œå„ªå…ˆé¸æ“‡å›ç­”æ€§è³ªçš„å°è©±
                if (lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?')) {
                    // å°‹æ‰¾é©åˆå›ç­”çš„å°è©±
                    const answerDialogues = availableDialogues.filter(d => 
                        d.includes('æˆ‘è¦ºå¾—') || d.includes('æˆ‘èªç‚º') || d.includes('ç¢ºå¯¦') || d.includes('æˆ‘åŒæ„')
                    );
                    if (answerDialogues.length > 0) {
                        return answerDialogues[0];
                    }
                }
                
                // å¦‚æœå‰é¢æ˜¯é™³è¿°ï¼Œé¸æ“‡å›æ‡‰æ€§å°è©±
                const responseDialogues = availableDialogues.filter(d => 
                    d.includes('ä½ èªªå¾—å°') || d.includes('æˆ‘ä¹Ÿ') || d.includes('åŒæ„') || d.includes('ç†è§£')
                );
                if (responseDialogues.length > 0) {
                    selectedIndex = 0;
                }
            }

            return availableDialogues[selectedIndex % availableDialogues.length];
        }

        // ç²å–å°è©±æƒ…å¢ƒ
        function getConversationContext() {
            const recentDialogues = dialogues.slice(-5);
            return {
                recentTopics: extractTopics(recentDialogues),
                currentMood: determineMood(recentDialogues),
                participantCount: new Set(recentDialogues.map(d => d.speakerId)).size,
                lastSpeaker: recentDialogues.length > 0 ? recentDialogues[recentDialogues.length - 1].speaker : null
            };
        }

        // æå–å°è©±ä¸»é¡Œ
        function extractTopics(dialogues) {
            const keywords = [];
            dialogues.forEach(d => {
                if (d.type === 'dialogue') {
                    // ç°¡å–®çš„é—œéµè©æå–
                    const words = d.content.match(/[\u4e00-\u9fa5]+/g) || [];
                    keywords.push(...words.filter(w => w.length > 1));
                }
            });
            return [...new Set(keywords)].slice(0, 5);
        }

        // åˆ¤æ–·å°è©±æƒ…ç·’
        function determineMood(dialogues) {
            const emotionalWords = {
                happy: ['é–‹å¿ƒ', 'é«˜èˆˆ', 'å¿«æ¨‚', 'å“ˆå“ˆ', 'å¥½', 'æ£’', 'å¤ªå¥½äº†'],
                sad: ['é›£é', 'å‚·å¿ƒ', 'å¤±æœ›', 'ä¸é–‹å¿ƒ', 'ç³Ÿç³•'],
                angry: ['ç”Ÿæ°£', 'æ†¤æ€’', 'ä¸çˆ½', 'è¨å­'],
                excited: ['èˆˆå¥®', 'æ¿€å‹•', 'å¤ªæ£’äº†', 'ä¸å¯æ€è­°', 'é©šäºº'],
                calm: ['å¹³éœ', 'å®‰éœ', 'ç©©å®š', 'å¥½çš„', 'çŸ¥é“äº†']
            };
            
            const recentContent = dialogues.slice(-3).map(d => d.content).join(' ');
            
            for (let mood in emotionalWords) {
                for (let word of emotionalWords[mood]) {
                    if (recentContent.includes(word)) {
                        return mood;
                    }
                }
            }
            return 'neutral';
        }

        // ç”Ÿæˆå€‹æ€§åŒ–ä¸”é€£è²«çš„å°è©±
        async function generatePersonalizedDialogue(character, style, context, conversationContext, order) {
            // åˆ†æå°è©±é€£è²«æ€§
            const flowAnalysis = analyzeConversationFlow();
            
            // æ ¹æ“šåˆ†æçµæœé¸æ“‡åˆé©çš„å›æ‡‰ç­–ç•¥
            let responseStrategy = determineResponseStrategy(character, flowAnalysis, order);
            
            // ç”Ÿæˆé€£è²«çš„å°è©±å…§å®¹
            return generateCoherentResponse(character, style, context, flowAnalysis, responseStrategy, order);
        }

        // æ±ºå®šå›æ‡‰ç­–ç•¥
        function determineResponseStrategy(character, flowAnalysis, order) {
            // å¦‚æœæœ‰ç›´æ¥å•é¡Œéœ€è¦å›ç­”
            if (flowAnalysis.needsResponse && flowAnalysis.lastSpeaker && 
                flowAnalysis.lastSpeaker.speakerId !== character.id) {
                return 'answer_question';
            }
            
            // å¦‚æœå‰ä¸€å€‹è§’è‰²å‰›èªªå®Œï¼Œéœ€è¦å›æ‡‰
            if (flowAnalysis.lastSpeaker && flowAnalysis.lastSpeaker.speakerId !== character.id) {
                if (flowAnalysis.conversationFlow === 'question_asked') {
                    return 'answer_question';
                } else {
                    return 'respond_to_statement';
                }
            }
            
            // å¦‚æœæ˜¯åŒä¸€å€‹è§’è‰²æ¥çºŒèªªè©±
            if (flowAnalysis.lastSpeaker && flowAnalysis.lastSpeaker.speakerId === character.id) {
                return 'continue_thought';
            }
            
            // å¦‚æœæ˜¯å°è©±é–‹å§‹æˆ–æ–°è©±é¡Œ
            if (order === 0 || !flowAnalysis.lastSpeaker) {
                return 'initiate_topic';
            }
            
            return 'general_response';
        }

        // ç”Ÿæˆé€£è²«çš„å›æ‡‰
        function generateCoherentResponse(character, style, context, flowAnalysis, strategy, order) {
            // é€£è²«å°è©±æ¨¡æ¿ï¼ŒåŸºæ–¼è§’è‰²å€‹æ€§å’Œå›æ‡‰ç­–ç•¥
            const coherentDialogues = {
                è‰¾è‰çµ²: {
                    answer_question: {
                        natural: ["æˆ‘è¦ºå¾—æ˜¯é€™æ¨£çš„...", "å—¯ï¼Œæˆ‘æƒ³æ‡‰è©²æ˜¯...", "æ“šæˆ‘æ‰€çŸ¥...", "æˆ‘çš„çœ‹æ³•æ˜¯..."],
                        dramatic: ["å¤©å“ªï¼é€™å€‹å•é¡Œ...", "é€™çœŸçš„å¾ˆé‡è¦ï¼", "æˆ‘å¿…é ˆå‘Šè¨´ä½ ...", "é€™æ”¹è®Šäº†ä¸€åˆ‡ï¼"],
                        romantic: ["ä½ é€™æ¨£å•è®“æˆ‘æƒ³åˆ°...", "å’Œä½ è¨è«–é€™å€‹çœŸçš„å¾ˆæ£’...", "æˆ‘å¾ˆé«˜èˆˆä½ å•é€™å€‹..."],
                        humorous: ["å“ˆå“ˆï¼Œé€™å€‹å•é¡Œå¾ˆæœ‰è¶£ï¼", "ä½ å•åˆ°é‡é»äº†ï¼", "è®“æˆ‘æƒ³æƒ³...æ‡‰è©²æ˜¯é€™æ¨£..."],
                        tense: ["é€™å€‹å•é¡Œå¾ˆé—œéµ...", "æˆ‘å€‘å¿…é ˆä»”ç´°è€ƒæ…®...", "æƒ…æ³å¯èƒ½æ¯”æˆ‘å€‘æƒ³çš„è¤‡é›œ..."]
                    },
                    respond_to_statement: {
                        natural: ["ä½ èªªå¾—å°ã€‚", "æˆ‘ä¹Ÿæ˜¯é€™éº¼æƒ³çš„ã€‚", "é€™å€‹æƒ³æ³•ä¸éŒ¯ã€‚", "æˆ‘åŒæ„ä½ çš„çœ‹æ³•ã€‚"],
                        dramatic: ["å®Œå…¨æ­£ç¢ºï¼", "é€™å°±æ˜¯æˆ‘æƒ³èªªçš„ï¼", "ä½ èªªåˆ°é‡é»äº†ï¼", "æ²’éŒ¯ï¼Œå°±æ˜¯é€™æ¨£ï¼"],
                        romantic: ["ä½ ç¸½æ˜¯é€™éº¼é«”è²¼ã€‚", "å’Œä½ æƒ³æ³•ä¸€è‡´çœŸå¥½ã€‚", "ä½ ç†è§£æˆ‘çš„æ„Ÿå—ã€‚"],
                        humorous: ["å“ˆå“ˆï¼Œæˆ‘å€‘æƒ³åˆ°ä¸€èµ·å»äº†ï¼", "ä½ è®€æ‡‚æˆ‘çš„å¿ƒæ€äº†ï¼", "è‹±é›„æ‰€è¦‹ç•¥åŒï¼"],
                        tense: ["ä½ èªªå¾—æ²’éŒ¯ï¼Œæˆ‘å€‘å¾—å°å¿ƒã€‚", "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ“”æ†‚ã€‚", "æƒ…æ³ç¢ºå¯¦å¦‚ä½ æ‰€èªªã€‚"]
                    },
                    continue_thought: {
                        natural: ["è€Œä¸”æˆ‘é‚„æƒ³è£œå……...", "å°äº†ï¼Œé‚„æœ‰ä¸€é»...", "å¦å¤–...", "æˆ‘æƒ³å†èªª..."],
                        dramatic: ["ä¸åªå¦‚æ­¤ï¼", "é‚„æœ‰æ›´é‡è¦çš„æ˜¯...", "ç­‰ç­‰ï¼Œé‚„æœ‰...", "æˆ‘é‚„æ²’èªªå®Œ..."],
                        romantic: ["é‚„æœ‰...", "æˆ‘æƒ³å†å‘Šè¨´ä½ ...", "å¦å¤–...", "é‚„æƒ³å’Œä½ åˆ†äº«..."],
                        humorous: ["å°äº†å°äº†ï¼", "æˆ‘å·®é»å¿˜äº†...", "é‚„æœ‰ä¸€ä»¶æœ‰è¶£çš„äº‹...", "èªªåˆ°é€™å€‹..."],
                        tense: ["æ›´ç³Ÿçš„æ˜¯...", "é‚„æœ‰ä¸€å€‹å•é¡Œ...", "æˆ‘å€‘é‚„è¦è€ƒæ…®...", "åˆ¥å¿˜äº†..."]
                    },
                    initiate_topic: {
                        natural: ["æˆ‘æƒ³å’Œä½ èŠèŠ...", "ä½ çŸ¥é“å—...", "æˆ‘å‰›æ‰æƒ³åˆ°...", "æœ‰ä»¶äº‹æƒ³å‘Šè¨´ä½ ..."],
                        dramatic: ["æˆ‘æœ‰é‡è¦çš„äº‹è¦èªªï¼", "ä½ ä¸€å®šè¦è½é€™å€‹ï¼", "ç™¼ç”Ÿäº†ä¸å¾—äº†çš„äº‹ï¼"],
                        romantic: ["å’Œä½ åœ¨ä¸€èµ·çœŸå¥½...", "æˆ‘ä¸€ç›´æƒ³å‘Šè¨´ä½ ...", "æœ‰å€‹æƒ³æ³•æƒ³å’Œä½ åˆ†äº«..."],
                        humorous: ["ä½ è½éé€™å€‹ç¬‘è©±å—ï¼Ÿ", "æˆ‘æƒ³åˆ°ä¸€ä»¶æœ‰è¶£çš„äº‹...", "ä¾†èŠé»è¼•é¬†çš„..."],
                        tense: ["æˆ‘å€‘éœ€è¦è«‡è«‡...", "æœ‰å€‹åš´é‡çš„å•é¡Œ...", "æƒ…æ³æœ‰äº›ä¸å°å‹..."]
                    }
                },
                é›·æ©: {
                    answer_question: {
                        natural: ["æˆ‘èªç‚º...", "æ ¹æ“šæˆ‘çš„ç¶“é©—...", "é€™å€‹å•é¡Œ...", "è®“æˆ‘æƒ³æƒ³..."],
                        dramatic: ["é€™æ˜¯å€‹é‡è¦çš„å•é¡Œã€‚", "æˆ‘å¿…é ˆèª å¯¦åœ°èªª...", "äº‹å¯¦æ˜¯...", "æˆ‘å€‘å¿…é ˆé¢å°ç¾å¯¦..."],
                        romantic: ["æˆ‘å¾ˆæ¨‚æ„å›ç­”ä½ ã€‚", "é€™è®“æˆ‘æƒ³åˆ°æˆ‘å€‘...", "ä½ å•å¾—å¾ˆå¥½..."],
                        humorous: ["é€™å€‹å•é¡Œæœ‰æ„æ€ã€‚", "è®“æˆ‘å¥½å¥½æƒ³æƒ³...", "ä½ çœŸæœƒå•å•é¡Œã€‚"],
                        tense: ["é€™å€‹å•é¡Œå¾ˆè¤‡é›œ...", "æˆ‘å€‘éœ€è¦è¬¹æ…è€ƒæ…®...", "æƒ…æ³å¯èƒ½æ˜¯é€™æ¨£..."]
                    },
                    respond_to_statement: {
                        natural: ["æˆ‘ç†è§£ä½ çš„æƒ³æ³•ã€‚", "ä½ èªªå¾—æœ‰é“ç†ã€‚", "é€™ç¢ºå¯¦æ˜¯å€‹å¥½è§€é»ã€‚"],
                        dramatic: ["ä½ èªªå¾—å°ï¼Œæˆ‘å€‘å¿…é ˆè¡Œå‹•ã€‚", "æˆ‘å®Œå…¨åŒæ„ä½ çš„çœ‹æ³•ã€‚", "é€™æ­£æ˜¯æˆ‘å€‘éœ€è¦çš„ã€‚"],
                        romantic: ["ä½ çš„æƒ³æ³•ç¸½æ˜¯å¾ˆæº«æš–ã€‚", "æˆ‘å¾ˆæ„Ÿæ¿€ä½ çš„åˆ†äº«ã€‚", "å’Œä½ æƒ³æ³•ä¸€è‡´çœŸå¥½ã€‚"],
                        humorous: ["ä½ çš„è§€é»å¾ˆæœ‰è¶£ã€‚", "æˆ‘å–œæ­¡ä½ é€™æ¨£æƒ³ã€‚", "ä½ ç¸½æ˜¯èƒ½å¸¶ä¾†æ–°è¦–è§’ã€‚"],
                        tense: ["ä½ çš„æ“”æ†‚æ˜¯å°çš„ã€‚", "æˆ‘å€‘å¿…é ˆèªçœŸå°å¾…ã€‚", "æƒ…æ³ç¢ºå¯¦å¦‚ä½ æ‰€èªªã€‚"]
                    },
                    continue_thought: {
                        natural: ["æˆ‘æƒ³è£œå……ä¸€é»...", "é‚„æœ‰å°±æ˜¯...", "å¦å¤–...", "æˆ‘è¦ºå¾—é‚„éœ€è¦è€ƒæ…®..."],
                        dramatic: ["æ›´é‡è¦çš„æ˜¯...", "æˆ‘å€‘é‚„å¿…é ˆ...", "ä¸èƒ½å¿˜è¨˜...", "é—œéµåœ¨æ–¼..."],
                        romantic: ["æˆ‘é‚„æƒ³èªª...", "å¦å¤–...", "é‚„æœ‰ä¸€ä»¶äº‹...", "æˆ‘æƒ³å‘Šè¨´ä½ ..."],
                        humorous: ["å°äº†...", "é‚„æœ‰ä¸€é»...", "æˆ‘å·®é»å¿˜äº†...", "èªªåˆ°é€™å€‹..."],
                        tense: ["æˆ‘å€‘é‚„è¦æ³¨æ„...", "åˆ¥å¿˜äº†...", "æ›´é‡è¦çš„æ˜¯...", "æˆ‘æ“”å¿ƒçš„æ˜¯..."]
                    },
                    initiate_topic: {
                        natural: ["æˆ‘æƒ³è¨è«–ä¸€ä¸‹...", "æœ‰ä»¶äº‹æƒ³å’Œä½ è«‡è«‡...", "æˆ‘åœ¨æƒ³...", "é—œæ–¼..."],
                        dramatic: ["æˆ‘å€‘éœ€è¦è«‡è«–ä¸€å€‹é‡è¦å•é¡Œã€‚", "æœ‰ä»¶äº‹æˆ‘å¿…é ˆå‘Šè¨´ä½ ã€‚", "æƒ…æ³ç™¼ç”Ÿäº†è®ŠåŒ–ã€‚"],
                        romantic: ["æˆ‘æƒ³å’Œä½ åˆ†äº«...", "æœ‰å€‹æƒ³æ³•æƒ³å‘Šè¨´ä½ ...", "æˆ‘ä¸€ç›´åœ¨æƒ³æˆ‘å€‘..."],
                        humorous: ["ä½ æƒ³èŠé»ä»€éº¼ï¼Ÿ", "æˆ‘æƒ³åˆ°ä¸€ä»¶äº‹...", "ä¾†è«‡é»æœ‰è¶£çš„..."],
                        tense: ["æˆ‘å€‘é¢è‡¨ä¸€å€‹å•é¡Œ...", "æœ‰ä»¶äº‹è®“æˆ‘æ“”å¿ƒ...", "æˆ‘å€‘éœ€è¦æº–å‚™..."]
                    }
                }
            };

            // ç²å–å°æ‡‰çš„å°è©±æ¨¡æ¿
            const characterDialogues = coherentDialogues[character.name] || coherentDialogues['è‰¾è‰çµ²'];
            const strategyDialogues = characterDialogues[strategy] || characterDialogues['general_response'] || characterDialogues['respond_to_statement'];
            const styleDialogues = strategyDialogues[style] || strategyDialogues['natural'];

            // éæ¿¾å·²ä½¿ç”¨çš„å°è©±
            const availableDialogues = styleDialogues.filter(content => 
                !hasCharacterSaidSimilar(character.id, content)
            );

            if (availableDialogues.length === 0) {
                return generateFallbackResponse(character, style, flowAnalysis);
            }

            // åŸºæ–¼ç•¶å‰è©±é¡Œèª¿æ•´å°è©±
            let selectedDialogue = availableDialogues[order % availableDialogues.length];
            
            // å¦‚æœæœ‰å…·é«”è©±é¡Œï¼Œå˜—è©¦çµåˆè©±é¡Œå…§å®¹
            if (flowAnalysis.currentTopic && flowAnalysis.currentTopic.type !== 'general') {
                selectedDialogue = adaptToTopic(selectedDialogue, flowAnalysis.currentTopic, character);
            }

            return selectedDialogue;
        }

        // æ ¹æ“šè©±é¡Œèª¿æ•´å°è©±
        function adaptToTopic(dialogue, topic, character) {
            const topicAdaptations = {
                weather: {
                    è‰¾è‰çµ²: ["å°å•Šï¼Œå¤©æ°£çœŸçš„...", "æˆ‘è¦ºå¾—é€™å€‹å¤©æ°£...", "å¤©æ°£è®“æˆ‘æƒ³åˆ°..."],
                    é›·æ©: ["é—œæ–¼å¤©æ°£ï¼Œæˆ‘æƒ³...", "é€™æ¨£çš„å¤©æ°£ç¢ºå¯¦...", "å¤©æ°£æ–¹é¢..."]
                },
                feeling: {
                    è‰¾è‰çµ²: ["æˆ‘çš„æ„Ÿè¦ºæ˜¯...", "æˆ‘ä¹Ÿæœ‰åŒæ¨£çš„æ„Ÿå—...", "ä½ çš„æ„Ÿè¦ºæˆ‘èƒ½ç†è§£..."],
                    é›·æ©: ["æˆ‘ç†è§£ä½ çš„æ„Ÿå—...", "é—œæ–¼é€™ç¨®æ„Ÿè¦º...", "æˆ‘ä¹Ÿæœ‰é¡ä¼¼çš„æƒ³æ³•..."]
                },
                question: {
                    è‰¾è‰çµ²: ["é—œæ–¼ä½ çš„å•é¡Œ...", "é€™å€‹å•é¡Œè®“æˆ‘æƒ³åˆ°...", "ä½ å•å¾—å¾ˆå¥½..."],
                    é›·æ©: ["è®“æˆ‘å›ç­”ä½ çš„å•é¡Œ...", "é€™å€‹å•é¡Œ...", "æ ¹æ“šä½ çš„å•é¡Œ..."]
                }
            };

            const adaptations = topicAdaptations[topic.type];
            if (adaptations && adaptations[character.name]) {
                const adaptedOptions = adaptations[character.name];
                return adaptedOptions[Math.floor(Math.random() * adaptedOptions.length)];
            }

            return dialogue;
        }

        // å‚™ç”¨å›æ‡‰ç”Ÿæˆ
        function generateFallbackResponse(character, style, flowAnalysis) {
            const fallbacks = {
                è‰¾è‰çµ²: ["å—¯ï¼Œæˆ‘æ˜ç™½äº†ã€‚", "æ˜¯é€™æ¨£å•Šã€‚", "æˆ‘æƒ³ä¹Ÿæ˜¯ã€‚", "æœ‰é“ç†ã€‚"],
                é›·æ©: ["æˆ‘ç†è§£ã€‚", "ç¢ºå¯¦å¦‚æ­¤ã€‚", "ä½ èªªå¾—å°ã€‚", "æˆ‘åŒæ„ã€‚"]
            };

            const characterFallbacks = fallbacks[character.name] || fallbacks['è‰¾è‰çµ²'];
            return characterFallbacks[Math.floor(Math.random() * characterFallbacks.length)];
        }

        // åˆ†æå°è©±é€£è²«æ€§å’Œè©±é¡Œ
        function analyzeConversationFlow() {
            const recentDialogues = dialogues.slice(-5);
            
            return {
                lastSpeaker: recentDialogues.length > 0 ? recentDialogues[recentDialogues.length - 1] : null,
                currentTopic: extractCurrentTopic(recentDialogues),
                conversationFlow: analyzeFlow(recentDialogues),
                questionAsked: hasOpenQuestion(recentDialogues),
                emotionalTone: analyzeEmotionalTone(recentDialogues),
                needsResponse: needsDirectResponse(recentDialogues)
            };
        }

        // æå–ç•¶å‰è©±é¡Œ
        function extractCurrentTopic(dialogues) {
            if (dialogues.length === 0) return null;
            
            const lastDialogue = dialogues[dialogues.length - 1];
            if (lastDialogue.type !== 'dialogue') return null;
            
            const content = lastDialogue.content;
            
            // è­˜åˆ¥è©±é¡Œé—œéµè©
            const topicKeywords = {
                greeting: ['ä½ å¥½', 'å—¨', 'å“ˆå›‰', 'æ—©å®‰', 'æ™šå®‰'],
                question: ['ä»€éº¼', 'ç‚ºä»€éº¼', 'æ€éº¼', 'å“ªè£¡', 'èª°', 'ä½•æ™‚', 'å¦‚ä½•'],
                feeling: ['è¦ºå¾—', 'æ„Ÿè¦º', 'æƒ³', 'èªç‚º', 'å–œæ­¡', 'è¨å­'],
                suggestion: ['æˆ‘å€‘', 'å¯ä»¥', 'è¦ä¸è¦', 'å»ºè­°', 'ä¸å¦‚'],
                agreement: ['å°', 'æ˜¯çš„', 'æ²’éŒ¯', 'åŒæ„', 'ç¢ºå¯¦'],
                disagreement: ['ä¸', 'éŒ¯', 'ä¸å°', 'ä¸åŒæ„', 'ä½†æ˜¯'],
                weather: ['å¤©æ°£', 'ä¸‹é›¨', 'æ™´å¤©', 'é¢¨', 'å†·', 'ç†±'],
                time: ['æ™‚é–“', 'æ—©ä¸Š', 'ä¸‹åˆ', 'æ™šä¸Š', 'æ˜å¤©', 'æ˜¨å¤©'],
                place: ['é€™è£¡', 'é‚£è£¡', 'åœ°æ–¹', 'æˆ¿é–“', 'å¤–é¢', 'å®¶']
            };
            
            for (let topic in topicKeywords) {
                for (let keyword of topicKeywords[topic]) {
                    if (content.includes(keyword)) {
                        return { type: topic, keyword: keyword, content: content };
                    }
                }
            }
            
            return { type: 'general', content: content };
        }

        // åˆ†æå°è©±æµå‘
        function analyzeFlow(dialogues) {
            if (dialogues.length < 2) return 'start';
            
            const lastTwo = dialogues.slice(-2);
            const [prev, current] = lastTwo;
            
            if (prev.speakerId === current.speakerId) return 'continuation';
            if (current.content.includes('ï¼Ÿ') || current.content.includes('?')) return 'question_asked';
            if (prev.content.includes('ï¼Ÿ') || prev.content.includes('?')) return 'answering_question';
            
            return 'normal_exchange';
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰æœªå›ç­”çš„å•é¡Œ
        function hasOpenQuestion(dialogues) {
            const lastDialogue = dialogues[dialogues.length - 1];
            if (!lastDialogue || lastDialogue.type !== 'dialogue') return false;
            
            return lastDialogue.content.includes('ï¼Ÿ') || lastDialogue.content.includes('?');
        }

        // åˆ†ææƒ…ç·’åŸºèª¿
        function analyzeEmotionalTone(dialogues) {
            const recentContent = dialogues.slice(-3).map(d => d.content).join(' ');
            
            const emotionPatterns = {
                excited: ['å¤ªæ£’äº†', 'çœŸçš„å—', 'ä¸å¯æ€è­°', 'é©šäºº', 'å“‡'],
                happy: ['é–‹å¿ƒ', 'é«˜èˆˆ', 'å¿«æ¨‚', 'å¥½', 'æ£’', 'å“ˆå“ˆ'],
                concerned: ['æ“”å¿ƒ', 'ç…©æƒ±', 'å›°æ“¾', 'å•é¡Œ', 'éº»ç…©'],
                sad: ['é›£é', 'å‚·å¿ƒ', 'å¤±æœ›', 'ä¸å¥½', 'ç³Ÿç³•'],
                curious: ['æƒ³çŸ¥é“', 'å¥½å¥‡', 'æœ‰è¶£', 'ç‚ºä»€éº¼', 'æ€éº¼æ¨£'],
                calm: ['å¥½çš„', 'äº†è§£', 'çŸ¥é“', 'å—¯', 'æ˜¯']
            };
            
            for (let emotion in emotionPatterns) {
                for (let pattern of emotionPatterns[emotion]) {
                    if (recentContent.includes(pattern)) {
                        return emotion;
                    }
                }
            }
            
            return 'neutral';
        }

        // åˆ¤æ–·æ˜¯å¦éœ€è¦ç›´æ¥å›æ‡‰
        function needsDirectResponse(dialogues) {
            const lastDialogue = dialogues[dialogues.length - 1];
            if (!lastDialogue || lastDialogue.type !== 'dialogue') return false;
            
            const content = lastDialogue.content;
            
            // éœ€è¦å›æ‡‰çš„æƒ…æ³
            const responseNeeded = [
                'ä½ è¦ºå¾—', 'ä½ èªç‚º', 'ä½ æƒ³', 'ä½ çŸ¥é“',
                'å°å§', 'æ˜¯å—', 'å¥½å—', 'å¯ä»¥å—',
                'ï¼Ÿ', '?'
            ];
            
            return responseNeeded.some(pattern => content.includes(pattern));
        }

        // è§£æä¸¦æ·»åŠ ç”Ÿæˆçš„å°è©±
        async function parseAndAddGeneratedDialogue(text, availableCharacters) {
            const lines = text.split('\n').filter(line => line.trim());
            
            for (const line of lines) {
                const match = line.match(/^(.+?)ï¼š(.+)$/);
                if (match) {
                    const speakerName = match[1].trim();
                    const content = match[2].trim();
                    
                    // å°‹æ‰¾å°æ‡‰çš„è§’è‰²
                    const character = availableCharacters.find(char => 
                        char.name === speakerName || char.name.includes(speakerName) || speakerName.includes(char.name)
                    );
                    
                    if (character) {
                        const dialogue = {
                            type: 'dialogue',
                            speaker: character.name,
                            speakerId: character.id,
                            content: content,
                            timestamp: new Date(),
                            generated: true // æ¨™è¨˜ç‚ºAIç”Ÿæˆ
                        };
                        
                        dialogues.push(dialogue);
                        displayDialogue(dialogue);
                        
                        // æ·»åŠ çŸ­æš«å»¶é²è®“å°è©±é€ä¸€å‡ºç¾
                        await new Promise(resolve => setTimeout(resolve, 800));
                    }
                }
            }
        }

        // ç”Ÿæˆå ´æ™¯æè¿°ï¼ˆä½¿ç”¨OpenRouter APIï¼‰
        async function generateSceneDescription() {
            const apiKey = getAPIKey();
            
            try {
                if (apiKey) {
                    // å˜—è©¦ä½¿ç”¨OpenRouter API
                    await generateSceneWithOpenRouter(apiKey);
                } else {
                    // æ²’æœ‰API Keyï¼Œä½¿ç”¨é€£è²«å ´æ™¯ç”Ÿæˆ
                    const sceneText = generateCoherentScene();
                    
                    const narrator = {
                        type: 'narrator',
                        content: sceneText,
                        timestamp: new Date(),
                        generated: true,
                        simulated: true
                    };
                    
                    dialogues.push(narrator);
                    displayNarrator(narrator);
                    showSecurityTip('ğŸ¬ ä½¿ç”¨æœ¬åœ°å ´æ™¯ç”Ÿæˆ');
                }

            } catch (error) {
                console.error('å ´æ™¯ç”ŸæˆéŒ¯èª¤:', error);
                // APIå¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
                const fallbackScene = generateCoherentScene();
                
                const narrator = {
                    type: 'narrator',
                    content: fallbackScene,
                    timestamp: new Date(),
                    generated: true,
                    simulated: true
                };
                
                dialogues.push(narrator);
                displayNarrator(narrator);
                showSecurityTip('ğŸ¬ APIå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å ´æ™¯ç”Ÿæˆ');
            }
        }

        // ä½¿ç”¨OpenRouterç”Ÿæˆå ´æ™¯æè¿°
        async function generateSceneWithOpenRouter(apiKey) {
            // ç²å–æœ€è¿‘çš„å°è©±ä¾†ç†è§£æƒ…å¢ƒ
            const recentContext = dialogues.slice(-3).map(d => {
                if (d.type === 'dialogue') {
                    return `${d.speaker}èªªï¼š${d.content}`;
                }
                return d.content;
            }).join('ï¼Œ');

            const prompt = `è«‹æ ¹æ“šä»¥ä¸‹å°è©±æƒ…å¢ƒï¼Œç”Ÿæˆä¸€æ®µç°¡æ½”å„ªç¾çš„å ´æ™¯æè¿°æˆ–éå ´æ—ç™½ï¼š

ç›®å‰æƒ…å¢ƒï¼š${recentContext || 'æ•…äº‹é–‹å§‹'}
ç•¶å‰å ´æ™¯ï¼š${currentScene.location}ï¼Œ${currentScene.timeOfDay}ï¼Œ${currentScene.weather}

è¦æ±‚ï¼š
1. ç”Ÿæˆ20-50å­—çš„å ´æ™¯æè¿°
2. è¦æœ‰æ–‡å­¸æ€§ï¼Œç¬¦åˆæ•…äº‹æ°›åœ
3. ä¿æŒèˆ‡ç•¶å‰å ´æ™¯è¨­å®šçš„ä¸€è‡´æ€§
4. åªè¼¸å‡ºæ—ç™½å…§å®¹ï¼Œä¸è¦å…¶ä»–èªªæ˜`;

            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = 'https://openrouter.ai/api/v1/chat/completions';
            
            const response = await fetch(proxyUrl + targetUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    model: "anthropic/claude-3-sonnet",
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 200,
                    temperature: 0.7,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`APIéŒ¯èª¤ (${response.status})`);
            }

            const data = await response.json();
            const sceneText = data.choices[0].message.content.trim();

            // æ·»åŠ å ´æ™¯æè¿°
            const narrator = {
                type: 'narrator',
                content: sceneText,
                timestamp: new Date(),
                generated: true,
                apiGenerated: true
            };
            
            dialogues.push(narrator);
            displayNarrator(narrator);
            showSecurityTip('ğŸ¬ OpenRouterå ´æ™¯ç”Ÿæˆå®Œæˆ');
        }

        // åˆ†æä¸¦æ›´æ–°å ´æ™¯ç‹€æ…‹
        function analyzeAndUpdateScene() {
            const recentDialogues = dialogues.slice(-5);
            
            // å¾å°è©±ä¸­æå–å ´æ™¯ç·šç´¢
            recentDialogues.forEach(dialogue => {
                if (dialogue.type === 'dialogue') {
                    const content = dialogue.content.toLowerCase();
                    
                    // æª¢æ¸¬åœ°é»è®ŠåŒ–çš„é—œéµè©
                    if (content.includes('èµ°') || content.includes('å»') || content.includes('åˆ°')) {
                        if (content.includes('å¤–é¢') || content.includes('å‡ºå»') || content.includes('è¡—ä¸Š')) {
                            currentScene.location = 'æˆ¶å¤–';
                        } else if (content.includes('å›ä¾†') || content.includes('é€²ä¾†') || content.includes('æˆ¿é–“')) {
                            currentScene.location = 'å®¤å…§';
                        } else if (content.includes('å’–å•¡å»³') || content.includes('é¤å»³')) {
                            currentScene.location = 'å’–å•¡å»³';
                        } else if (content.includes('å…¬åœ’')) {
                            currentScene.location = 'å…¬åœ’';
                        } else if (content.includes('å­¸æ ¡') || content.includes('æ•™å®¤')) {
                            currentScene.location = 'å­¸æ ¡';
                        }
                    }
                    
                    // æª¢æ¸¬æ™‚é–“è®ŠåŒ–
                    if (content.includes('æ™šä¸Š') || content.includes('å¤œæ™š') || content.includes('å¤©é»‘')) {
                        currentScene.timeOfDay = 'å¤œæ™š';
                    } else if (content.includes('æ—©ä¸Š') || content.includes('ä¸Šåˆ')) {
                        currentScene.timeOfDay = 'æ—©æ™¨';
                    } else if (content.includes('ä¸‹åˆ') || content.includes('å‚æ™š')) {
                        currentScene.timeOfDay = 'å‚æ™š';
                    }
                    
                    // æª¢æ¸¬å¤©æ°£è®ŠåŒ–
                    if (content.includes('ä¸‹é›¨') || content.includes('é›¨')) {
                        currentScene.weather = 'é›¨å¤©';
                    } else if (content.includes('æ™´') || content.includes('é™½å…‰')) {
                        currentScene.weather = 'æ™´æœ—';
                    } else if (content.includes('é¢¨')) {
                        currentScene.weather = 'æœ‰é¢¨';
                    }
                    
                    // æª¢æ¸¬æ°›åœè®ŠåŒ–
                    if (content.includes('ç·Šå¼µ') || content.includes('å±éšª') || content.includes('å°å¿ƒ')) {
                        currentScene.atmosphere = 'ç·Šå¼µ';
                    } else if (content.includes('é–‹å¿ƒ') || content.includes('å¿«æ¨‚') || content.includes('å“ˆå“ˆ')) {
                        currentScene.atmosphere = 'æ­¡æ¨‚';
                    } else if (content.includes('æµªæ¼«') || content.includes('ç¾å¥½') || content.includes('æº«é¦¨')) {
                        currentScene.atmosphere = 'æº«é¦¨';
                    } else if (content.includes('å¹³éœ') || content.includes('å®‰éœ')) {
                        currentScene.atmosphere = 'å¹³éœ';
                    }
                }
            });
        }

        // ç”Ÿæˆé€£è²«çš„å ´æ™¯æè¿°
        function generateCoherentScene() {
            analyzeAndUpdateScene();
            
            const sceneTemplates = {
                å®¤å…§: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "é™½å…‰é€éçª—æˆ¶ç‘é€²æˆ¿é–“ï¼Œåœ¨åœ°æ¿ä¸Šå½¢æˆæº«æš–çš„å…‰æ–‘ã€‚",
                            "å®¤å…§çš„å…‰ç·šæŸ”å’Œè€Œæ˜äº®ï¼Œç‡Ÿé€ å‡ºèˆ’é©çš„æ°›åœã€‚",
                            "å¾®é¢¨å¾åŠé–‹çš„çª—æˆ¶å¹é€²ä¾†ï¼Œå¸¶ä¾†å¤–é¢çš„æ¸…æ–°ç©ºæ°£ã€‚"
                        ],
                        é›¨å¤©: [
                            "é›¨æ»´è¼•æ•²è‘—çª—ç»ç’ƒï¼Œç™¼å‡ºè¦å¾‹çš„ç¯€æ‹è²ã€‚",
                            "å®¤å…§é¡¯å¾—æ ¼å¤–æº«æš–ï¼Œèˆ‡å¤–é¢çš„é›¨å¤©å½¢æˆå°æ¯”ã€‚",
                            "é›¨è²æˆç‚ºäº†å°è©±çš„èƒŒæ™¯éŸ³æ¨‚ã€‚"
                        ],
                        æœ‰é¢¨: [
                            "çª—ç°¾åœ¨å¾®é¢¨ä¸­è¼•æŸ”åœ°é£„å‹•è‘—ã€‚",
                            "é¢¨è²åœ¨æˆ¿é–“è£¡è¼•æŸ”åœ°è¿´éŸ¿ã€‚"
                        ]
                    },
                    å¤œæ™š: {
                        æ™´æœ—: [
                            "æœˆå…‰é€éçª—æˆ¶ç‘é€²ä¾†ï¼Œç‚ºæˆ¿é–“å¢æ·»äº†ä¸€çµ²è©©æ„ã€‚",
                            "å®¤å…§çš„ç‡ˆå…‰æº«æš–è€ŒæŸ”å’Œï¼Œå‰µé€ å‡ºå¯§éœçš„å¤œæ™šæ°›åœã€‚",
                            "å¤œæ™šçš„å¯§éœåŒ…åœè‘—é€™å€‹æº«é¦¨çš„ç©ºé–“ã€‚"
                        ],
                        é›¨å¤©: [
                            "å¤œé›¨æ•²æ‰“è‘—çª—æˆ¶ï¼Œä½¿å®¤å…§é¡¯å¾—æ›´åŠ æº«æš–å®‰å…¨ã€‚",
                            "é›¨å¤œçš„å®¤å…§æ ¼å¤–å¯§éœèˆ’é©ã€‚"
                        ]
                    }
                },
                æˆ¶å¤–: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "é™½å…‰ç‘åœ¨è¡—é“ä¸Šï¼Œå¾®é¢¨è¼•æ’«éè‡‰é °ã€‚",
                            "å¤©ç©ºæ¹›è—ï¼Œç™½é›²æ‚ æ‚ é£„éã€‚",
                            "æº«æš–çš„é™½å…‰è®“ä¸€åˆ‡éƒ½é¡¯å¾—ç”Ÿæ©Ÿå‹ƒå‹ƒã€‚"
                        ],
                        é›¨å¤©: [
                            "é›¨æ»´å¾å¤©ç©ºé£„è½ï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—æ¸…æ–°çš„å‘³é“ã€‚",
                            "é›¨å¾Œçš„ç©ºæ°£æ ¼å¤–æ¸…æ–°ï¼Œæ´—æ·¨äº†åŸå¸‚çš„å¡µåŸƒã€‚"
                        ]
                    },
                    å¤œæ™š: {
                        æ™´æœ—: [
                            "å¤œç©ºä¸­æ˜Ÿæ˜Ÿé–ƒçˆï¼Œè¡—ç‡ˆç…§äº®äº†å‰æ–¹çš„è·¯ã€‚",
                            "æ¶¼çˆ½çš„å¤œé¢¨å¸¶ä¾†äº†é æ–¹çš„èŠ±é¦™ã€‚",
                            "å¤œæ™šçš„åŸå¸‚åœ¨ç‡ˆç«ä¸­é¡¯å¾—æ ¼å¤–ç¾éº—ã€‚"
                        ]
                    }
                },
                å’–å•¡å»³: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "å’–å•¡å»³è£¡ç€°æ¼«è‘—é¦™æ¿ƒçš„å’–å•¡å‘³ï¼Œé™½å…‰å¾çª—æˆ¶ç‘é€²ä¾†ã€‚",
                            "è¼•æŸ”çš„éŸ³æ¨‚åœ¨å’–å•¡å»³è£¡æ’­æ”¾è‘—ï¼Œç‡Ÿé€ å‡ºæ‚ é–’çš„æ°›åœã€‚",
                            "å…¶ä»–å®¢äººçš„ä½è²äº¤è«‡è²æˆç‚ºäº†èˆ’é©çš„èƒŒæ™¯éŸ³ã€‚"
                        ]
                    },
                    å‚æ™š: {
                        æ™´æœ—: [
                            "å‚æ™šçš„å’–å•¡å»³ç‡ˆå…‰æº«æš–ï¼Œçª—å¤–å¤•é™½è¥¿ä¸‹ã€‚",
                            "å’–å•¡å»³åœ¨å¤•é™½çš„ç…§å°„ä¸‹é¡¯å¾—æ ¼å¤–æº«é¦¨ã€‚"
                        ]
                    }
                },
                å…¬åœ’: {
                    ç™½å¤©: {
                        æ™´æœ—: [
                            "å…¬åœ’è£¡ç¶ æ¨¹æˆè”­ï¼Œé³¥å…’åœ¨æé ­æ­Œå”±ã€‚",
                            "å¾®é¢¨å¹éæ¨¹è‘‰ï¼Œç™¼å‡ºæ²™æ²™çš„è²éŸ¿ã€‚",
                            "é™½å…‰é€éæ¨¹è‘‰ç‘ä¸‹æ–‘é§çš„å…‰å½±ã€‚"
                        ]
                    },
                    å‚æ™š: {
                        æ™´æœ—: [
                            "å¤•é™½è¥¿ä¸‹ï¼Œå…¬åœ’è£¡çš„ä¸€åˆ‡éƒ½è¢«æŸ“æˆäº†é‡‘é»ƒè‰²ã€‚",
                            "å‚æ™šçš„å…¬åœ’æ ¼å¤–å¯§éœï¼Œåªæœ‰å¾®é¢¨å’Œé³¥é³´è²ã€‚"
                        ]
                    }
                }
            };
            
            // ç²å–ç•¶å‰å ´æ™¯çš„æè¿°é¸é …
            const locationScenes = sceneTemplates[currentScene.location] || sceneTemplates['å®¤å…§'];
            const timeScenes = locationScenes[currentScene.timeOfDay] || locationScenes['ç™½å¤©'];
            const weatherScenes = timeScenes[currentScene.weather] || timeScenes['æ™´æœ—'];
            
            if (weatherScenes.length === 0) {
                return generateDefaultScene();
            }
            
            // æ ¹æ“šæ°›åœèª¿æ•´æè¿°
            let selectedScene = weatherScenes[Math.floor(Math.random() * weatherScenes.length)];
            
            // æ ¹æ“šç•¶å‰æ°›åœæ·»åŠ ä¿®é£¾
            switch (currentScene.atmosphere) {
                case 'ç·Šå¼µ':
                    selectedScene += ' ç©ºæ°£ä¸­ä¼¼ä¹ç€°æ¼«è‘—ä¸€çµ²ç·Šå¼µçš„æ°£æ¯ã€‚';
                    break;
                case 'æ­¡æ¨‚':
                    selectedScene += ' æ­¡å¿«çš„æ°›åœè®“ä¸€åˆ‡éƒ½é¡¯å¾—æ›´åŠ ç¾å¥½ã€‚';
                    break;
                case 'æº«é¦¨':
                    selectedScene += ' æº«é¦¨çš„æ°£æ°›è®“äººæ„Ÿåˆ°å¿ƒæƒ…æ„‰æ‚¦ã€‚';
                    break;
                case 'å¹³éœ':
                    selectedScene += ' ä¸€åˆ‡éƒ½é¡¯å¾—é‚£éº¼å¹³éœç¥¥å’Œã€‚';
                    break;
            }
            
            return selectedScene;
        }

        // é è¨­å ´æ™¯æè¿°
        function generateDefaultScene() {
            return "æ™‚å…‰éœéœåœ°æµæ·Œè‘—ï¼Œå‘¨åœçš„ä¸€åˆ‡éƒ½é¡¯å¾—é‚£éº¼è‡ªç„¶è€Œå’Œè«§ã€‚";
        }

        // æ›´æ–°å°èªªé è¦½
        function updateNovelPreview() {
            const preview = document.getElementById('novel-preview');
            let novelText = '';

            dialogues.forEach(item => {
                if (item.type === 'dialogue') {
                    novelText += `<p><strong>${item.speaker}ï¼š</strong>ã€Œ${item.content}ã€</p>`;
                } else if (item.type === 'narrator') {
                    novelText += `<p style="text-align: center; font-style: italic; color: #666; margin: 20px 0;">${item.content}</p>`;
                }
            });

            preview.innerHTML = novelText || '<p style="text-align: center; color: #666;">å°šæœªå»ºç«‹å°è©±å…§å®¹...</p>';
        }

        // åŒ¯å‡ºå°èªª
        function exportNovel() {
            if (dialogues.length === 0) {
                alert('è«‹å…ˆå»ºç«‹ä¸€äº›å°è©±å…§å®¹ï¼');
                return;
            }

            const format = document.getElementById('export-format').value;
            
            switch(format) {
                case 'txt':
                    exportToTXT();
                    break;
                case 'docx':
                    exportToWord();
                    break;
                case 'pdf':
                    exportToPDF();
                    break;
                default:
                    alert('è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼');
            }
        }

        // åŒ¯å‡ºç‚ºTXT
        function exportToTXT() {
            let novelText = 'AIå¤šè§’è‰²å°è©±å°èªª\n' + '='.repeat(30) + '\n\n';
            
            dialogues.forEach(item => {
                if (item.type === 'dialogue') {
                    novelText += `${item.speaker}ï¼šã€Œ${item.content}ã€\n\n`;
                } else if (item.type === 'narrator') {
                    novelText += `${item.content}\n\n`;
                }
            });

            const blob = new Blob([novelText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å°è©±å°èªª.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // åŒ¯å‡ºç‚ºWordæ–‡ä»¶
        function exportToWord() {
            try {
                const doc = new docx.Document({
                    sections: [{
                        properties: {},
                        children: [
                            new docx.Paragraph({
                                text: "AIå¤šè§’è‰²å°è©±å°èªª",
                                heading: docx.HeadingLevel.TITLE,
                                alignment: docx.AlignmentType.CENTER,
                            }),
                            new docx.Paragraph({
                                text: "",
                                spacing: { after: 400 }
                            }),
                            ...dialogues.map(item => {
                                if (item.type === 'dialogue') {
                                    return new docx.Paragraph({
                                        children: [
                                            new docx.TextRun({
                                                text: `${item.speaker}ï¼š`,
                                                bold: true,
                                            }),
                                            new docx.TextRun({
                                                text: `ã€Œ${item.content}ã€`,
                                            }),
                                        ],
                                        spacing: { after: 200 }
                                    });
                                } else if (item.type === 'narrator') {
                                    return new docx.Paragraph({
                                        text: item.content,
                                        italics: true,
                                        alignment: docx.AlignmentType.CENTER,
                                        spacing: { after: 200 }
                                    });
                                }
                            }).filter(Boolean)
                        ]
                    }]
                });

                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, "å°è©±å°èªª.docx");
                });
            } catch (error) {
                console.error('WordåŒ¯å‡ºéŒ¯èª¤:', error);
                alert('WordåŒ¯å‡ºåŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–æ ¼å¼ã€‚');
            }
        }

        // åŒ¯å‡ºç‚ºPDFï¼ˆåœ–ç‰‡æ¨£å¼ï¼‰
        function exportToPDF() {
            if (dialogues.length === 0) {
                alert('è«‹å…ˆå»ºç«‹ä¸€äº›å°è©±å…§å®¹ï¼');
                return;
            }

            // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„PDFé è¦½å®¹å™¨
            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = `
                width: 210mm;
                min-height: 297mm;
                background: white;
                padding: 20mm;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
                position: absolute;
                left: -9999px;
                top: 0;
                box-sizing: border-box;
            `;

            // æ·»åŠ æ¨™é¡Œ
            const title = document.createElement('div');
            title.style.cssText = `
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                color: #333;
                margin-bottom: 30px;
                padding-bottom: 10px;
                border-bottom: 3px solid #4facfe;
            `;
            title.textContent = 'AIå¤šè§’è‰²å°è©±å°èªª';
            pdfContainer.appendChild(title);

            // æ·»åŠ å°è©±å…§å®¹
            dialogues.forEach(item => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    margin-bottom: 20px;
                    padding: 15px;
                    border-radius: 15px;
                    max-width: 80%;
                    word-wrap: break-word;
                `;

                if (item.type === 'dialogue') {
                    const isProtagonist = protagonistId && item.speakerId == protagonistId;
                    
                    if (isProtagonist) {
                        messageDiv.style.cssText += `
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            color: white;
                            margin-left: auto;
                            margin-right: 0;
                        `;
                    } else {
                        messageDiv.style.cssText += `
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            margin-left: 0;
                            margin-right: auto;
                        `;
                    }

                    const speakerName = document.createElement('div');
                    speakerName.style.cssText = `
                        font-weight: bold;
                        font-size: 14px;
                        margin-bottom: 8px;
                        opacity: 0.9;
                    `;
                    speakerName.textContent = item.speaker;

                    const content = document.createElement('div');
                    content.style.cssText = `
                        font-size: 16px;
                        line-height: 1.5;
                    `;
                    content.textContent = item.content;

                    messageDiv.appendChild(speakerName);
                    messageDiv.appendChild(content);

                } else if (item.type === 'narrator') {
                    messageDiv.style.cssText += `
                        background: #f8f9fa;
                        color: #495057;
                        text-align: center;
                        font-style: italic;
                        margin: 20px auto;
                        border-left: 4px solid #6c757d;
                    `;
                    messageDiv.textContent = item.content;
                }

                pdfContainer.appendChild(messageDiv);
            });

            // æš«æ™‚æ·»åŠ åˆ°é é¢ä»¥é€²è¡Œæˆªåœ–
            document.body.appendChild(pdfContainer);

            // ä½¿ç”¨html2canvasæˆªåœ–ä¸¦è½‰æ›ç‚ºPDF
            html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: 'white',
                width: pdfContainer.scrollWidth,
                height: pdfContainer.scrollHeight
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                // A4å°ºå¯¸
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // ç¬¬ä¸€é 
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // å¦‚æœå…§å®¹è¶…éä¸€é ï¼Œæ·»åŠ æ–°é é¢
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('å°è©±å°èªª.pdf');
                
                // æ¸…ç†è‡¨æ™‚å…ƒç´ 
                document.body.removeChild(pdfContainer);
            }).catch(error => {
                console.error('PDFåŒ¯å‡ºéŒ¯èª¤:', error);
                alert('PDFåŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é¸æ“‡å…¶ä»–æ ¼å¼ã€‚');
                document.body.removeChild(pdfContainer);
            });
        }

        // å„²å­˜å°ˆæ¡ˆ
        function saveProject() {
            const projectData = {
                characters: characters,
                dialogues: dialogues,
                timestamp: new Date()
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å°èªªå°ˆæ¡ˆ.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // é‡æ–°é¡¯ç¤ºèŠå¤©å…§å®¹
        function refreshChatDisplay() {
            const container = document.getElementById('chat-container');
            container.innerHTML = '<div class="message narrator"><div class="message-header">ç³»çµ±æç¤º</div>æ­¡è¿ä½¿ç”¨AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±ï¼è«‹å…ˆå»ºç«‹è§’è‰²ï¼Œç„¶å¾Œé–‹å§‹å‰µä½œå°è©±ã€‚</div>';
            
            dialogues.forEach(item => {
                if (item.type === 'dialogue') {
                    displayDialogue(item);
                } else if (item.type === 'narrator') {
                    displayNarrator(item);
                }
            });
        }

        // æ¸…ç©ºå°è©±ï¼ˆåŒæ™‚é‡ç½®å ´æ™¯ç‹€æ…‹ï¼‰
        function clearChat() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å°è©±å—ï¼Ÿé€™å°‡é‡ç½®æ‰€æœ‰è§’è‰²çš„è¨˜æ†¶å’Œå ´æ™¯è¨­å®šã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                dialogues = [];
                characterMemories = {}; // æ¸…ç©ºæ‰€æœ‰è§’è‰²è¨˜æ†¶
                // é‡ç½®å ´æ™¯ç‹€æ…‹
                currentScene = {
                    location: 'å®¤å…§',
                    timeOfDay: 'ç™½å¤©',
                    weather: 'æ™´æœ—',
                    atmosphere: 'å¹³éœ',
                    established: false
                };
                const container = document.getElementById('chat-container');
                container.innerHTML = '<div class="message narrator"><div class="message-header">ç³»çµ±æç¤º</div>æ­¡è¿ä½¿ç”¨AIå¤šè§’è‰²å°è©±å°èªªç³»çµ±ï¼è«‹å…ˆå»ºç«‹è§’è‰²ï¼Œç„¶å¾Œé–‹å§‹å‰µä½œå°è©±ã€‚</div>';
                showSecurityTip('ğŸ’¬ å°è©±å·²æ¸…ç©ºï¼Œè§’è‰²è¨˜æ†¶å’Œå ´æ™¯å·²é‡ç½®');
            }
        }

        // è¼‰å…¥ç¯„æœ¬
        function loadTemplate() {
            alert('è§’è‰²ç¯„æœ¬å·²è¼‰å…¥ï¼ä½ å¯ä»¥åœ¨è§’è‰²åˆ—è¡¨ä¸­çœ‹åˆ°é è¨­è§’è‰²ã€‚');
        }
    </script>
</body>
</html>